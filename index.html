<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proje ve Tedarik Y√∂netimi</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .login-wrapper {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-container {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 420px;
            overflow: hidden;
        }
        
        .login-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 30px;
            text-align: center;
        }
        
        .login-header h1 { font-size: 24px; margin-bottom: 8px; }
        .login-header p { font-size: 14px; opacity: 0.9; }
        
        .login-body { padding: 30px; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            font-size: 14px;
            margin-bottom: 8px;
            color: #34495e;
            font-weight: 500;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled { background: #95a5a6; cursor: not-allowed; transform: none; }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
            width: auto;
        }
        
        .btn-success { background: #27ae60; }
        .btn-danger { background: #e74c3c; }
        .btn-warning { background: #f39c12; }
        .kdv-btn { 
            padding: 12px 24px; 
            border: 2px solid #667eea; 
            background: #fff; 
            color: #667eea; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: all 0.3s; 
        }
        .kdv-btn:hover { background: #f0f0ff; }
        .kdv-btn.active { background: #667eea; color: #fff; }
        .btn-info { background: #3498db; }
        
        .error-msg {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 14px;
            display: none;
        }
        .error-msg.show { display: block; }
        
        .demo-info {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 13px;
        }
        .demo-info strong { display: block; margin-bottom: 4px; }
        
        .app-container {
            display: none;
            width: 100%;
            min-height: 100vh;
        }
        .app-container.show { display: flex; }
        
        .sidebar {
            width: 280px;
            background: #2c3e50;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        
        .sidebar-header {
            padding: 20px;
            background: #1a252f;
            border-bottom: 1px solid #34495e;
        }
        .sidebar-header h1 { font-size: 18px; color: #3498db; margin-bottom: 4px; }
        .sidebar-header p { font-size: 12px; color: #95a5a6; }
        
        .user-info {
            padding: 15px 20px;
            background: #34495e;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-info-text strong { display: block; font-size: 13px; }
        .user-info-text small { font-size: 11px; color: #bdc3c7; }
        
        .logout-btn {
            background: #e74c3c;
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .home-btn {
            background: #667eea;
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            margin-right: 8px;
        }
        .back-to-home {
            display: block;
            text-align: center;
            color: #667eea;
            text-decoration: none;
            margin-bottom: 15px;
            font-size: 14px;
            transition: color 0.3s;
        }
        .back-to-home:hover {
            color: #764ba2;
            text-decoration: underline;
        }
        
        .menu { flex: 1; overflow-y: auto; padding: 10px 0; }
        
        .menu-section { margin-bottom: 2px; }
        .menu-section-title {
            padding: 12px 20px;
            font-size: 13px;
            color: #ecf0f1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #243342;
            transition: all 0.2s;
            font-weight: 500;
        }
        .menu-section-title:hover { background: #34495e; }
        .menu-section-title .arrow {
            transition: transform 0.3s;
            font-size: 10px;
        }
        .menu-section-title.open .arrow { transform: rotate(90deg); }
        
        .menu-items {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #1a252f;
        }
        .menu-items.open { max-height: 500px; }
        
        .menu-item {
            padding: 10px 20px 10px 35px;
            cursor: pointer;
            color: #bdc3c7;
            border-left: 3px solid transparent;
            transition: all 0.2s;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .menu-item:hover, .menu-item.active {
            background: #34495e;
            border-left-color: #3498db;
            color: #fff;
        }
        .menu-item.disabled { opacity: 0.5; cursor: not-allowed; }
        
        .main-content {
            flex: 1;
            padding: 30px;
            background: #f5f7fa;
            overflow-y: auto;
        }
        
        .page-header { margin-bottom: 25px; }
        .page-header h2 { font-size: 26px; color: #2c3e50; margin-bottom: 5px; }
        .page-header p { color: #7f8c8d; font-size: 14px; }
        
        .card {
            background: #fff;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .card h3 { margin: 0 0 20px 0; color: #2c3e50; font-size: 18px; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #3498db;
        }
        .stat-card h4 { font-size: 12px; color: #7f8c8d; text-transform: uppercase; margin-bottom: 8px; }
        .stat-card p { font-size: 28px; font-weight: 700; color: #2c3e50; }
        .stat-card.warning { border-left-color: #f39c12; }
        .stat-card.danger { border-left-color: #e74c3c; }
        .stat-card.success { border-left-color: #27ae60; }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ecf0f1; }
        th { background: #f8f9fa; font-size: 12px; text-transform: uppercase; color: #7f8c8d; font-weight: 600; }
        td { font-size: 14px; color: #34495e; }
        tr:hover { background: #f8f9fa; }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-success { background: #d5f4e6; color: #27ae60; }
        .badge-warning { background: #fff3cd; color: #f39c12; }
        .badge-danger { background: #fadbd8; color: #e74c3c; }
        .badge-info { background: #e3f2fd; color: #1976d2; }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-right: 5px;
        }
        .action-btn.primary { background: #3498db; color: #fff; }
        .action-btn.success { background: #27ae60; color: #fff; }
        .action-btn.danger { background: #e74c3c; color: #fff; }
        .action-btn.warning { background: #f39c12; color: #fff; }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #27ae60;
            color: #fff;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
        }
        .toast.show { display: block; }
        .toast.error { background: #e74c3c; }
        .toast.warning { background: #f39c12; }
        
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: #fff;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 { margin: 0; }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        .modal-body { padding: 20px; }
        
        .kritik-stok-table tr.kritik { background: #fff5f5; }
        
        .hidden { display: none !important; }
        
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; min-height: auto; }
            .main-content { padding: 15px; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="login-wrapper" id="loginWrapper">
        <div class="login-container">
            <div class="login-header">
                <h1>Proje ve Tedarik Y√∂netimi</h1>
                <p>Kurumsal ƒ∞≈ü S√ºre√ßleri Platformu</p>
            </div>
            <div class="login-body">
                <a href="/" class="back-to-home">‚Üê Ana Sayfaya D√∂n</a>
                <div class="error-msg" id="loginError"></div>
                <form id="loginForm">
                    <div class="form-group">
                        <label>E-posta</label>
                        <input type="email" id="loginEmail" required placeholder="ornek@sirket.com">
                    </div>
                    <div class="form-group">
                        <label>≈ûifre</label>
                        <input type="password" id="loginPassword" required placeholder="≈ûifrenizi girin">
                    </div>
                    <button type="submit" class="btn" id="loginBtn">Giri≈ü Yap</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="login-wrapper" id="superAdminLoginWrapper" style="display: none;">
        <div class="login-container">
            <div class="login-header" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                <h1>Sistem Y√∂netimi</h1>
                <p>S√ºper Admin Paneli</p>
            </div>
            <div class="login-body">
                <div class="error-msg" id="superAdminLoginError"></div>
                <form id="superAdminLoginForm">
                    <div class="form-group">
                        <label>E-posta</label>
                        <input type="email" id="superAdminEmail" required placeholder="admin@sistem.com">
                    </div>
                    <div class="form-group">
                        <label>≈ûifre</label>
                        <input type="password" id="superAdminPassword" required placeholder="≈ûifrenizi girin">
                    </div>
                    <button type="submit" class="btn" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">S√ºper Admin Giri≈üi</button>
                </form>
                <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                    <a href="#" onclick="showNormalLogin(); return false;" style="color: #667eea; font-size: 13px;">Firma Giri≈üine D√∂n</a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="app-container" id="superAdminContainer" style="display: none;">
        <div class="sidebar" style="background: #1a1a2e;">
            <div class="sidebar-header" style="background: #16213e;">
                <h1 style="color: #e74c3c;">Sistem Y√∂netimi</h1>
                <p id="superAdminName">S√ºper Admin</p>
            </div>
            <div class="user-info" style="background: #0f3460;">
                <div class="user-info-text">
                    <strong id="superAdminEmail2">superadmin@sistem.com</strong>
                    <small>S√ºper Admin</small>
                </div>
                <button class="logout-btn" onclick="superAdminLogout()">√áƒ±kƒ±≈ü</button>
            </div>
            <div class="menu" id="superAdminMenu">
                <div class="menu-item active" onclick="showSuperAdminPage('dashboard')" data-page="dashboard">
                    <span>üìä</span> Dashboard
                </div>
                <div class="menu-section">
                    <div class="menu-header" onclick="toggleSuperAdminAccordion('sistemler')">
                        <span>üíº</span> Sistemler
                        <span class="accordion-icon" id="sistemler-icon">‚ñº</span>
                    </div>
                    <div class="submenu" id="sistemler-submenu" style="display: none;">
                        <div class="menu-item" onclick="showSuperAdminPage('sistem-tedarik')" data-page="sistem-tedarik">
                            <span>üì¶</span> Tedarik Sistemi
                        </div>
                        <div class="menu-item" onclick="showSuperAdminPage('sistem-lojistik')" data-page="sistem-lojistik">
                            <span>üöõ</span> Lojistik Sistemi
                        </div>
                        <div class="menu-item" onclick="showSuperAdminPage('sistem-servis')" data-page="sistem-servis">
                            <span>üîß</span> Servis Sistemi
                        </div>
                    </div>
                </div>
                <div class="menu-item" onclick="showSuperAdminPage('firmalar')" data-page="firmalar">
                    <span>üè¢</span> T√ºm Firmalar
                </div>
                <div class="menu-item" onclick="showSuperAdminPage('yeni-lisans')" data-page="yeni-lisans">
                    <span>‚ûï</span> Yeni Lisans
                </div>
            </div>
        </div>
        <div class="main-content" id="superAdminContent"></div>
    </div>

    <div class="app-container" id="appContainer">
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>Proje ve Tedarik Y√∂netimi</h1>
                <p id="companyName">≈ûirket Adƒ±</p>
            </div>
            <div class="user-info">
                <div class="user-info-text">
                    <strong id="userEmail">kullanici@sirket.com</strong>
                    <small id="userRole">Rol</small>
                </div>
                <button class="logout-btn" onclick="logout()">√áƒ±kƒ±≈ü</button>
            </div>
            <div class="menu" id="sidebarMenu"></div>
        </div>
        <div class="main-content" id="mainContent"></div>
    </div>

    <div class="toast" id="toast"></div>
    <div class="modal" id="modal"><div class="modal-content" id="modalContent"></div></div>

<script>
// Para formatƒ± yardƒ±mcƒ± fonksiyonu
function formatMoney(amount) {
    if (amount === null || amount === undefined) return '0 ‚Ç∫';
    return Number(amount).toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' ‚Ç∫';
}

let currentUser = null;
let appData = { projects: [], products: [], suppliers: [], requests: [], offers: [], orders: [], stockMovements: [], invoices: [], users: [] };

const ALL_PERMISSIONS = {
    'dashboard': 'üìä Dashboard',
    'projeler': 'üìÅ Projeler',
    'yeni-proje': '‚ûï Yeni Proje',
    'yeni-talep': 'üìù Yeni Talep',
    'talep-takip': 'üìã Talep Takip',
    'talep-onay': '‚úì Talep Onay',
    'tedarikci-teklifleri': 'üí∞ Teklif Topla',
    'teklif-mukayese': 'üìä Teklif Mukayese',
    'siparis-ver': 'üõí Sipari≈ü Ver',
    'siparisler': 'üì¶ Sipari≈üler',
    'teslim-al': '‚úÖ Teslim Al',
    'stok-liste': 'üìã Stok Listesi',
    'satinalma-urunler': 'üõçÔ∏è Satƒ±nalƒ±nan √úr√ºnler',
    'stok-hareketler': 'üîÑ Stok Hareketleri',
    'stok-giris': '‚¨áÔ∏è Stok Giri≈ü',
    'stok-cikis': '‚¨ÜÔ∏è Stok √áƒ±kƒ±≈ü',
    'fatura': 'üßæ Fatura Giri≈üi',
    'tedarikci-yonetim': 'üè¢ Tedarik√ßiler',
    'urun-yonetim': 'üì¶ √úr√ºn Tanƒ±mlarƒ±',
    'kategori-yonetim': 'üóÇÔ∏è Kategori Y√∂netimi',
    'yonetici-panel': '‚öôÔ∏è Y√∂netici Paneli'
};

const DEFAULT_PERMISSIONS = {
    'Kullanƒ±cƒ±': ['dashboard', 'yeni-talep', 'talep-takip', 'teslim-al'],
    'Satƒ±nalma': ['dashboard', 'projeler', 'yeni-proje', 'yeni-talep', 'talep-takip', 'talep-onay', 'tedarikci-teklifleri', 'teklif-mukayese', 'siparis-ver', 'siparisler', 'teslim-al', 'stok-liste', 'satinalma-urunler', 'stok-hareketler', 'stok-giris', 'stok-cikis', 'fatura', 'tedarikci-yonetim', 'urun-yonetim'],
    'Y√∂netim': Object.keys(ALL_PERMISSIONS)
};

const MENU_STRUCTURE = [
    { section: 'Ana Sayfa', items: [{ id: 'dashboard', icon: 'üìä', label: 'Dashboard' }] },
    { section: 'Proje Y√∂netimi', items: [
        { id: 'projeler', icon: 'üìÅ', label: 'Projeler' },
        { id: 'yeni-proje', icon: '‚ûï', label: 'Yeni Proje' }
    ]},
    { section: 'Talep Y√∂netimi', items: [
        { id: 'yeni-talep', icon: 'üìù', label: 'Yeni Talep' },
        { id: 'talep-takip', icon: 'üìã', label: 'Talep Takip' },
        { id: 'talep-onay', icon: '‚úì', label: 'Talep Onay' }
    ]},
    { section: 'Teklif & Sipari≈ü', items: [
        { id: 'tedarikci-teklifleri', icon: 'üí∞', label: 'Teklif Topla' },
        { id: 'teklif-mukayese', icon: 'üìä', label: 'Teklif Mukayese' },
        { id: 'siparis-ver', icon: 'üõí', label: 'Sipari≈ü Ver' },
        { id: 'siparisler', icon: 'üì¶', label: 'Sipari≈üler' },
        { id: 'teslim-al', icon: '‚úÖ', label: 'Teslim Al' }
    ]},
    { section: 'Stok Y√∂netimi', items: [
        { id: 'stok-liste', icon: 'üìã', label: 'Stok Listesi' },
        { id: 'satinalma-urunler', icon: 'üõçÔ∏è', label: 'Satƒ±nalƒ±nan √úr√ºnler' },
        { id: 'stok-hareketler', icon: 'üîÑ', label: 'Stok Hareketleri' },
        { id: 'stok-giris', icon: '‚¨áÔ∏è', label: 'Stok Giri≈ü' },
        { id: 'stok-cikis', icon: '‚¨ÜÔ∏è', label: 'Stok √áƒ±kƒ±≈ü' }
    ]},
    { section: 'Diƒüer', items: [
        { id: 'fatura', icon: 'üßæ', label: 'Fatura Giri≈üi' },
        { id: 'tedarikci-yonetim', icon: 'üè¢', label: 'Tedarik√ßiler' },
        { id: 'urun-yonetim', icon: 'üì¶', label: '√úr√ºn Tanƒ±mlarƒ±' },
        { id: 'kategori-yonetim', icon: 'üóÇÔ∏è', label: 'Kategori Y√∂netimi' },
        { id: 'yonetici-panel', icon: '‚öôÔ∏è', label: 'Y√∂netici Paneli' }
    ]}
];

function hasPermission(page) {
    if (!currentUser) return false;
    if (currentUser.role === 'Y√∂netim') return true;
    const perms = DEFAULT_PERMISSIONS[currentUser.role] || [];
    return perms.includes(page);
}

function showToast(msg, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.className = 'toast show ' + type;
    setTimeout(() => toast.classList.remove('show'), 3000);
}

function showError(id, msg) {
    const el = document.getElementById(id);
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 4000);
}

async function apiCall(endpoint, method = 'GET', data = null) {
    const options = { method, headers: { 'Content-Type': 'application/json' } };
    if (data) options.body = JSON.stringify(data);
    
    let url = `/api/${endpoint}`;
    if (method === 'GET' && currentUser) {
        url += (url.includes('?') ? '&' : '?') + `license_code=${currentUser.license_code}`;
    }
    
    const res = await fetch(url, options);
    return res.json();
}

async function loadAllData() {
    const [projects, products, suppliers, requests, offers, orders, stockMovements, invoices, users, categories] = await Promise.all([
        apiCall('projects'),
        apiCall('products'),
        apiCall('suppliers'),
        apiCall('requests'),
        apiCall('offers'),
        apiCall('orders'),
        apiCall('stock-movements'),
        apiCall('invoices'),
        apiCall('users'),
        apiCall('categories')
    ]);
    appData = { projects, products, suppliers, requests, offers, orders, stockMovements, invoices, users, categories };
}

function generateMenu() {
    const menu = document.getElementById('sidebarMenu');
    let html = '';
    let sectionIndex = 0;
    
    for (const section of MENU_STRUCTURE) {
        const visibleItems = section.items.filter(item => hasPermission(item.id));
        if (visibleItems.length === 0) continue;
        
        const sectionId = `section-${sectionIndex}`;
        html += `<div class="menu-section">
            <div class="menu-section-title" onclick="toggleMenuSection('${sectionId}')">
                <span>${section.section}</span>
                <span class="arrow">‚ñ∂</span>
            </div>
            <div class="menu-items" id="${sectionId}">
                ${visibleItems.map(item => `
                    <div class="menu-item" data-page="${item.id}" onclick="navigateTo('${item.id}')">
                        <span>${item.icon}</span> ${item.label}
                    </div>
                `).join('')}
            </div>
        </div>`;
        sectionIndex++;
    }
    
    if (currentUser && currentUser.role === 'Y√∂netim') {
        html += `<div class="menu-section">
            <div class="menu-section-title" onclick="toggleMenuSection('section-lisans')">
                <span>‚öôÔ∏è Ayarlar</span>
                <span class="arrow">‚ñ∂</span>
            </div>
            <div class="menu-items" id="section-lisans">
                <div class="menu-item" data-page="lisans-yonetimi" onclick="navigateTo('lisans-yonetimi')">
                    <span>üîë</span> Lisans Y√∂netimi
                </div>
            </div>
        </div>`;
    }
    
    menu.innerHTML = html;
}

function generateLicenseOnlyMenu() {
    const menu = document.getElementById('sidebarMenu');
    menu.innerHTML = `
        <div class="menu-section">
            <div class="menu-section-title open">
                <span>‚öôÔ∏è Lisans Ayarlarƒ±</span>
            </div>
            <div class="menu-items open">
                <div class="menu-item active" data-page="lisans-yonetimi" onclick="navigateTo('lisans-yonetimi')">
                    <span>üîë</span> Lisans Y√∂netimi
                </div>
            </div>
        </div>
    `;
}

function toggleMenuSection(sectionId) {
    const section = document.getElementById(sectionId);
    const title = section.previousElementSibling;
    const isOpen = section.classList.contains('open');
    
    section.classList.toggle('open');
    title.classList.toggle('open');
}

function navigateTo(page) {
    if (page !== 'lisans-yonetimi' && !hasPermission(page)) {
        showToast('Bu sayfaya eri≈üim yetkiniz yok!', 'error');
        return;
    }
    
    document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
    document.querySelector(`.menu-item[data-page="${page}"]`)?.classList.add('active');
    
    renderPage(page);
}

async function renderPage(page) {
    await loadAllData();
    const content = document.getElementById('mainContent');
    
    const pages = {
        'dashboard': renderDashboard,
        'projeler': renderProjeler,
        'yeni-proje': renderYeniProje,
        'yeni-talep': renderYeniTalep,
        'talep-takip': renderTalepTakip,
        'talep-onay': renderTalepOnay,
        'tedarikci-teklifleri': renderTeklifTopla,
        'teklif-mukayese': renderTeklifMukayese,
        'siparis-ver': renderSiparisVer,
        'siparisler': renderSiparisler,
        'teslim-al': renderTeslimAl,
        'stok-liste': renderStokListe,
        'satinalma-urunler': renderSatinalinaUrunler,
        'stok-hareketler': renderStokHareketler,
        'stok-giris': () => renderStokHareket('Giri≈ü'),
        'stok-cikis': () => renderStokHareket('√áƒ±kƒ±≈ü'),
        'fatura': renderFatura,
        'tedarikci-yonetim': renderTedarikciYonetim,
        'urun-yonetim': renderUrunYonetim,
        'kategori-yonetim': renderKategoriYonetim,
        'yonetici-panel': renderYoneticiPanel,
        'lisans-yonetimi': renderLisansYonetimi
    };
    
    if (pages[page]) pages[page]();
}

async function renderLisansYonetimi() {
    const content = document.getElementById('mainContent');
    const licenseInfo = currentUser.license_info;
    const isActive = licenseInfo && licenseInfo.aktif;
    
    let statusClass = 'danger';
    let statusText = 'Pasif';
    if (isActive) {
        statusClass = 'success';
        statusText = 'Aktif';
    }
    
    let kalanGunText = '';
    if (licenseInfo && licenseInfo.kalan_gun !== null) {
        if (licenseInfo.kalan_gun < 0) {
            kalanGunText = `<span class="badge badge-danger">S√ºresi Dolmu≈ü</span>`;
        } else if (licenseInfo.kalan_gun <= 7) {
            kalanGunText = `<span class="badge badge-warning">${licenseInfo.kalan_gun} g√ºn kaldƒ±</span>`;
        } else if (licenseInfo.kalan_gun <= 30) {
            kalanGunText = `<span class="badge badge-warning">${licenseInfo.kalan_gun} g√ºn kaldƒ±</span>`;
        } else {
            kalanGunText = `<span class="badge badge-success">${licenseInfo.kalan_gun} g√ºn kaldƒ±</span>`;
        }
    }
    
    content.innerHTML = `
        <div class="page-header">
            <h2>üîë Lisans Y√∂netimi</h2>
            <p>Lisans bilgilerinizi g√∂r√ºnt√ºleyin ve y√∂netin</p>
        </div>
        
        ${!isActive ? `
        <div class="card" style="background: linear-gradient(135deg, #fff3cd, #ffeeba); border-left: 4px solid #ffc107; margin-bottom: 20px;">
            <h3 style="color: #856404;">‚ö†Ô∏è Lisans Aktivasyonu Gerekli</h3>
            <p style="color: #856404;">Sistemi kullanabilmek i√ßin lisansƒ±nƒ±zƒ± aktif etmeniz gerekmektedir. Size e-posta ile g√∂nderilen lisans kodunu a≈üaƒüƒ±ya girin.</p>
        </div>
        ` : ''}
        
        <div class="card">
            <h3>üìã Mevcut Lisans Bilgileri</h3>
            <table class="form-table" style="margin-top: 15px;">
                <tr>
                    <td style="width: 200px; font-weight: 600;">Durum:</td>
                    <td><span class="badge badge-${statusClass}">${statusText}</span> ${kalanGunText}</td>
                </tr>
                <tr>
                    <td style="font-weight: 600;">≈ûirket Adƒ±:</td>
                    <td>${currentUser.company_name || '-'}</td>
                </tr>
                <tr>
                    <td style="font-weight: 600;">Paket:</td>
                    <td>${licenseInfo?.paket || '-'}</td>
                </tr>
                <tr>
                    <td style="font-weight: 600;">Biti≈ü Tarihi:</td>
                    <td>${licenseInfo?.bitis_tarihi || '-'}</td>
                </tr>
            </table>
        </div>
        
        ${currentUser.role === 'Y√∂netim' ? `
        <div class="card">
            <h3>üîê Lisans Aktivasyonu</h3>
            <p style="color: #666; margin-bottom: 15px;">Yeni lisans kodunuzu girerek sistemi aktif edin veya lisansƒ±nƒ±zƒ± yenileyin.</p>
            <form id="activateLicenseForm">
                <div class="form-group">
                    <label>Lisans Kodu</label>
                    <input type="text" id="newLicenseCode" required placeholder="√ñrn: ABC-1234-XYZ-5678" style="font-family: monospace; font-size: 16px; letter-spacing: 1px;">
                </div>
                <button type="submit" class="btn btn-success" style="margin-top: 10px;">
                    ‚úì Lisansƒ± Aktif Et
                </button>
            </form>
        </div>
        ` : `
        <div class="card">
            <p style="color: #666;">Lisans i≈ülemleri i√ßin y√∂neticinize ba≈üvurun.</p>
        </div>
        `}
    `;
    
    const form = document.getElementById('activateLicenseForm');
    if (form) {
        form.onsubmit = async (e) => {
            e.preventDefault();
            const newCode = document.getElementById('newLicenseCode').value.trim();
            
            const res = await apiCall('license/activate', 'POST', {
                user_license_code: currentUser.license_code,
                new_license_code: newCode
            });
            
            if (res.success) {
                showToast('Lisans ba≈üarƒ±yla aktif edildi! Sayfa yenileniyor...');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showToast(res.message || 'Hata olu≈ütu!', 'error');
            }
        };
    }
}

async function renderDashboard() {
    const dashboard = await apiCall('dashboard');
    const content = document.getElementById('mainContent');
    
    function formatMoney(val) {
        return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(val || 0);
    }
    
    function formatDate(dateStr) {
        if (!dateStr) return '-';
        try {
            const d = new Date(dateStr);
            return d.toLocaleDateString('tr-TR') + ' ' + d.toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'});
        } catch(e) { return dateStr; }
    }
    
    function getActivityIcon(type) {
        switch(type) {
            case 'login': return 'üîë';
            case 'request_create': return 'üìù';
            case 'order_create': return 'üõí';
            default: return 'üìå';
        }
    }
    
    content.innerHTML = `
        <div class="page-header">
            <h2>üìä Kontrol Paneli</h2>
            <p>Proje ve tedarik s√ºre√ßlerinizi y√∂netin</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card"><h4>Aktif Projeler</h4><p>${dashboard.aktif_projeler}</p></div>
            <div class="stat-card warning"><h4>Bekleyen Talepler</h4><p>${dashboard.bekleyen_talepler}</p></div>
            <div class="stat-card success"><h4>Toplam Sipari≈ü</h4><p>${dashboard.toplam_siparis}</p></div>
            <div class="stat-card danger"><h4>Kritik Stok</h4><p>${dashboard.kritik_stok_sayisi}</p></div>
        </div>
        
        <div class="stats-grid" style="margin-top: 20px;">
            <div class="stat-card" style="border-left-color: #9b59b6;">
                <h4>Toplam Satinalma</h4>
                <p style="font-size: 22px;">${formatMoney(dashboard.toplam_satin_alma)}</p>
            </div>
            <div class="stat-card success">
                <h4>Tamamlanan Tutar</h4>
                <p style="font-size: 22px;">${formatMoney(dashboard.tamamlanan_tutar)}</p>
            </div>
            <div class="stat-card warning">
                <h4>Bekleyen Tutar</h4>
                <p style="font-size: 22px;">${formatMoney(dashboard.bekleyen_tutar)}</p>
            </div>
            <div class="stat-card" style="border-left-color: #1abc9c;">
                <h4>Toplam Fatura</h4>
                <p style="font-size: 22px;">${formatMoney(dashboard.toplam_fatura_tutar)}</p>
            </div>
        </div>
        
        <div class="stats-grid" style="margin-top: 20px;">
            <div class="stat-card" style="border-left-color: #3498db;">
                <h4>Tedarikci Sayisi</h4>
                <p>${dashboard.toplam_tedarikci || 0}</p>
            </div>
            <div class="stat-card" style="border-left-color: #e67e22;">
                <h4>Urun Sayisi</h4>
                <p>${dashboard.toplam_urun || 0}</p>
            </div>
            <div class="stat-card" style="border-left-color: #16a085;">
                <h4>Fatura Sayisi</h4>
                <p>${dashboard.toplam_fatura || 0}</p>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <div class="card">
                <h3>üë• Son Giris Yapanlar</h3>
                ${(dashboard.son_girisler && dashboard.son_girisler.length > 0) ? `
                <table style="width:100%;">
                    <thead><tr><th>Kullanici</th><th>Son Giris</th></tr></thead>
                    <tbody>
                        ${dashboard.son_girisler.map(g => `
                            <tr>
                                <td>${g.user_email}</td>
                                <td>${formatDate(g.son_giris)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ` : '<div class="empty-state">Henuz giris kaydi yok</div>'}
            </div>
            
            <div class="card">
                <h3>üìã Son Aktiviteler</h3>
                ${(dashboard.son_aktiviteler && dashboard.son_aktiviteler.length > 0) ? `
                <div style="max-height: 300px; overflow-y: auto;">
                    ${dashboard.son_aktiviteler.filter(a => a.activity_type !== 'login').slice(0, 10).map(a => `
                        <div style="padding: 8px 0; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 18px;">${getActivityIcon(a.activity_type)}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">${a.activity_description}</div>
                                <div style="font-size: 12px; color: #7f8c8d;">${a.user_email} - ${formatDate(a.created_at)}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                ` : '<div class="empty-state">Hen√ºz aktivite yok</div>'}
            </div>
        </div>
        
        ${dashboard.kritik_stoklar.length > 0 ? `
        <div class="card" style="margin-top: 20px;">
            <h3>‚ö†Ô∏è Kritik Stok Uyarilari</h3>
            <table class="kritik-stok-table">
                <thead><tr><th>Urun Kodu</th><th>Urun Adi</th><th>Mevcut Stok</th><th>Minimum Stok</th></tr></thead>
                <tbody>
                    ${dashboard.kritik_stoklar.map(p => `
                        <tr class="kritik">
                            <td>${p.urun_kodu}</td>
                            <td>${p.urun_adi}</td>
                            <td><span class="badge badge-danger">${p.stok_miktari} ${p.birim}</span></td>
                            <td>${p.minimum_stok} ${p.birim}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>` : ''}
    `;
}

function renderProjeler() {
    const content = document.getElementById('mainContent');
    content.innerHTML = `
        <div class="page-header">
            <h2>üìÅ Projeler</h2>
            <p>T√ºm projeleri g√∂r√ºnt√ºleyin</p>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Proje Listesi (${appData.projects.length})</h3>
                <div>
                    <button class="btn btn-info btn-sm" onclick="printProjeler()">üñ®Ô∏è Yazdƒ±r</button>
                    <button class="btn btn-sm" onclick="printProjeler()">üìÑ PDF</button>
                </div>
            </div>
            ${appData.projects.length === 0 ? '<div class="empty-state">Hen√ºz proje yok</div>' : `
            <table id="projelerTable">
                <thead><tr><th>Proje Kodu</th><th>Proje Adƒ±</th><th>Lokasyon</th><th>Durum</th><th>ƒ∞≈ülem</th></tr></thead>
                <tbody>
                    ${appData.projects.map(p => `
                        <tr>
                            <td><strong>${p.proje_kodu}</strong></td>
                            <td>${p.proje_adi}</td>
                            <td>${p.lokasyon || '-'}</td>
                            <td><span class="badge badge-${p.durum === 'Aktif' ? 'success' : p.durum === 'Tamamlandƒ±' ? 'info' : 'danger'}">${p.durum}</span></td>
                            <td><button class="action-btn danger" onclick="deleteProject(${p.id})">Sil</button></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>`}
        </div>
    `;
}

function printProjeler() {
    printListAsPDF('Proje Listesi', appData.projects, [
        { header: 'Proje Kodu', field: 'proje_kodu' },
        { header: 'Proje Adƒ±', field: 'proje_adi' },
        { header: 'Lokasyon', field: 'lokasyon' },
        { header: 'Durum', field: 'durum' }
    ]);
}

async function renderYeniProje() {
    const content = document.getElementById('mainContent');
    
    const statusRes = await fetch(`/api/project-statuses?license_code=${currentUser.license_code}`);
    const statuses = await statusRes.json();
    
    content.innerHTML = `
        <div class="page-header">
            <h2>‚ûï Yeni Proje</h2>
            <p>Yeni proje olu≈üturun</p>
        </div>
        <div class="card">
            <form id="projectForm">
                <div class="form-grid">
                    <div class="form-group"><label>Proje Adƒ± *</label><input type="text" id="projeAdi" required></div>
                    <div class="form-group"><label>ƒ∞lgili Personel</label><input type="text" id="ilgiliPersonel"></div>
                    <div class="form-group"><label>Lokasyon</label><input type="text" id="lokasyon"></div>
                    <div class="form-group"><label>Ba≈ülangƒ±√ß Tarihi</label><input type="date" id="baslangicTarihi"></div>
                    <div class="form-group"><label>Biti≈ü Tarihi</label><input type="date" id="bitisTarihi"></div>
                    <div class="form-group"><label>B√ºt√ße (‚Ç∫)</label><input type="number" id="butce" step="0.01"></div>
                    <div class="form-group">
                        <label>Durum <button type="button" class="btn btn-sm" onclick="openDurumYonetimModal()" style="padding:2px 8px; font-size:11px; margin-left:5px;">+ Y√∂net</button></label>
                        <select id="projeDurum">
                            ${statuses.map(s => `<option value="${s.durum_adi}">${s.durum_adi}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div class="form-group"><label>A√ßƒ±klama</label><textarea id="projeAciklama" rows="3"></textarea></div>
                <button type="submit" class="btn">üíæ Projeyi Kaydet</button>
            </form>
        </div>
    `;
    
    document.getElementById('projectForm').onsubmit = async (e) => {
        e.preventDefault();
        const res = await apiCall('projects', 'POST', {
            license_code: currentUser.license_code,
            proje_adi: document.getElementById('projeAdi').value,
            santiye_sefi: document.getElementById('ilgiliPersonel').value,
            lokasyon: document.getElementById('lokasyon').value,
            baslangic_tarihi: document.getElementById('baslangicTarihi').value,
            bitis_tarihi: document.getElementById('bitisTarihi').value,
            butce: parseFloat(document.getElementById('butce').value) || 0,
            durum: document.getElementById('projeDurum').value,
            aciklama: document.getElementById('projeAciklama').value
        });
        if (res.success) {
            showToast('Proje olu≈üturuldu: ' + res.proje_kodu);
            navigateTo('projeler');
        }
    };
}

async function deleteProject(id) {
    if (!confirm('Projeyi silmek istediƒüinize emin misiniz?')) return;
    await apiCall(`projects/${id}`, 'DELETE');
    showToast('Proje silindi');
    navigateTo('projeler');
}

async function openDurumYonetimModal() {
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    
    const statusRes = await fetch(`/api/project-statuses?license_code=${currentUser.license_code}`);
    const statuses = await statusRes.json();
    
    modalContent.innerHTML = `
        <div class="modal-header">
            <h3>Proje Durumlarƒ± Y√∂netimi</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom:15px;">
                <form id="yeniDurumForm" style="display:flex; gap:10px;">
                    <input type="text" id="yeniDurumAdi" placeholder="Yeni durum adƒ±..." required style="flex:1;">
                    <button type="submit" class="btn">+ Ekle</button>
                </form>
            </div>
            <div id="durumListesi">
                ${statuses.map(s => `
                    <div class="kategori-item" style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:#f8f9fa; border-radius:8px; margin-bottom:8px;">
                        <span><strong>${s.durum_adi}</strong></span>
                        <div style="display:flex; gap:5px;">
                            <button class="action-btn btn-sm" onclick="editDurum(${s.id}, '${s.durum_adi}')" style="padding:4px 8px; font-size:12px;">D√ºzenle</button>
                            <button class="action-btn danger btn-sm" onclick="deleteDurum(${s.id})" style="padding:4px 8px; font-size:12px;">Sil</button>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModalAndRefresh()">Kapat</button>
        </div>
    `;
    
    modal.classList.add('show');
    
    document.getElementById('yeniDurumForm').onsubmit = async (e) => {
        e.preventDefault();
        const durumAdi = document.getElementById('yeniDurumAdi').value.trim();
        if (!durumAdi) return;
        
        const res = await fetch('/api/project-statuses', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                license_code: currentUser.license_code,
                durum_adi: durumAdi
            })
        });
        
        const data = await res.json();
        if (data.success) {
            showToast('Durum eklendi');
            openDurumYonetimModal();
        } else {
            showToast(data.message || 'Ekleme ba≈üarƒ±sƒ±z!', 'error');
        }
    };
}

async function closeModalAndRefresh() {
    closeModal();
    await refreshStatusDropdown();
}

async function refreshStatusDropdown() {
    const statusRes = await fetch(`/api/project-statuses?license_code=${currentUser.license_code}`);
    const statuses = await statusRes.json();
    const dropdown = document.getElementById('projeDurum');
    if (dropdown) {
        dropdown.innerHTML = statuses.map(s => `<option value="${s.durum_adi}">${s.durum_adi}</option>`).join('');
    }
}

function editDurum(id, currentName) {
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    
    modalContent.innerHTML = `
        <div class="modal-header">
            <h3>Durumu D√ºzenle</h3>
            <button class="modal-close" onclick="openDurumYonetimModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Durum Adƒ±</label>
                <input type="text" id="editDurumAdi" value="${currentName}" required>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="saveDurum(${id})">Kaydet</button>
            <button class="btn btn-secondary" onclick="openDurumYonetimModal()">ƒ∞ptal</button>
        </div>
    `;
}

async function saveDurum(id) {
    const newName = document.getElementById('editDurumAdi').value.trim();
    if (!newName) {
        showToast('Durum adƒ± bo≈ü olamaz!', 'error');
        return;
    }
    
    const res = await fetch(`/api/project-statuses/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            license_code: currentUser.license_code,
            durum_adi: newName
        })
    });
    
    const data = await res.json();
    if (data.success) {
        showToast('Durum g√ºncellendi');
        openDurumYonetimModal();
    } else {
        showToast(data.message || 'G√ºncelleme ba≈üarƒ±sƒ±z!', 'error');
    }
}

async function deleteDurum(id) {
    if (!confirm('Bu durumu silmek istediƒüinizden emin misiniz?')) return;
    
    const res = await fetch(`/api/project-statuses/${id}?license_code=${currentUser.license_code}`, { 
        method: 'DELETE' 
    });
    const data = await res.json();
    
    if (data.success) {
        showToast('Durum silindi');
        openDurumYonetimModal();
    } else {
        showToast(data.message || 'Silme ba≈üarƒ±sƒ±z!', 'error');
    }
}

function renderYeniTalep() {
    const content = document.getElementById('mainContent');
    
    content.innerHTML = `
        <div class="page-header">
            <h2>üìù Yeni Talep</h2>
            <p>√úr√ºn talebi olu≈üturun</p>
        </div>
        <div class="card">
            <form id="talepForm">
                <div class="form-grid">
                    <div class="form-group"><label>Proje</label>
                        <select id="talepProje">
                            <option value="">Proje Se√ßin...</option>
                            ${appData.projects.filter(p => p.durum === 'Aktif').map(p => `<option value="${p.id}">${p.proje_kodu} - ${p.proje_adi}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group"><label>Aciliyet</label>
                        <select id="talepAciliyet"><option>Normal</option><option>Y√ºksek</option><option>Acil</option></select>
                    </div>
                    <div class="form-group"><label>Departman</label><input type="text" id="talepDepartman"></div>
                </div>
                <div class="form-group"><label>A√ßƒ±klama</label><textarea id="talepAciklama" rows="2"></textarea></div>
                
                <h3 style="margin: 20px 0 10px;">Talep Edilecek √úr√ºnler</h3>
                
                <button type="button" class="btn btn-success" onclick="openUrunSecModal()" style="margin-bottom:15px;">
                    ‚ûï √úr√ºn Se√ß ve Ekle
                </button>
                
                <div style="background:#f8f9fa; border-radius:8px; padding:15px;">
                    <table id="talepUrunTable">
                        <thead><tr><th>√úr√ºn Kodu</th><th>√úr√ºn Adƒ±</th><th>Miktar</th><th>Birim</th><th>Beklenen Teslim</th><th>ƒ∞≈ülem</th></tr></thead>
                        <tbody id="talepUrunBody"></tbody>
                    </table>
                    <div id="bostablo" style="padding:30px; text-align:center; color:#7f8c8d;">
                        Hen√ºz √ºr√ºn eklenmedi.<br>"√úr√ºn Se√ß ve Ekle" butonuna tƒ±klayarak √ºr√ºn ekleyin.
                    </div>
                </div>
                <p id="urunUyari" style="color:#e74c3c; font-size:13px; display:none; margin-top:8px;">En az bir √ºr√ºn eklemeniz gerekiyor!</p>
                
                <button type="submit" class="btn" style="margin-top:20px; width:100%;">üì§ Talebi G√∂nder</button>
            </form>
        </div>
    `;
    
    document.getElementById('talepForm').onsubmit = async (e) => {
        e.preventDefault();
        const rows = document.querySelectorAll('#talepUrunBody tr');
        const items = [];
        rows.forEach(row => {
            const urunId = row.dataset.urunId;
            const urun = appData.products.find(p => p.id == urunId);
            if (urun) {
                items.push({
                    urun_id: urunId,
                    urun_kodu: urun.urun_kodu,
                    urun_adi: urun.urun_adi,
                    miktar: parseFloat(row.querySelector('.miktar-input').value) || 0,
                    birim: urun.birim,
                    beklenen_teslim: row.querySelector('.teslim-input').value
                });
            }
        });
        
        if (items.length === 0) {
            document.getElementById('urunUyari').style.display = 'block';
            showToast('En az bir √ºr√ºn ekleyin!', 'error');
            return;
        }
        
        const res = await apiCall('requests', 'POST', {
            license_code: currentUser.license_code,
            proje_id: document.getElementById('talepProje').value,
            talep_eden: currentUser.email,
            departman: document.getElementById('talepDepartman').value,
            aciliyet: document.getElementById('talepAciliyet').value,
            aciklama: document.getElementById('talepAciklama').value,
            items,
            user_id: currentUser.id,
            user_email: currentUser.email
        });
        
        if (res.success) {
            showToast('Talep olu≈üturuldu: ' + res.talep_no);
            navigateTo('talep-takip');
        }
    };
}

function openUrunSecModal() {
    const sortedProducts = [...appData.products].sort((a, b) => a.urun_kodu.localeCompare(b.urun_kodu));
    
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    
    modalContent.innerHTML = `
        <div class="modal-header">
            <h3>üì¶ √úr√ºn Se√ß</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group" style="margin-bottom:15px;">
                <label>üîç √úr√ºn Ara</label>
                <input type="text" id="modalUrunArama" placeholder="√úr√ºn kodu veya adƒ± ile arama yapƒ±n..." 
                    style="width:100%; padding:12px; font-size:15px; border:2px solid #667eea; border-radius:8px;"
                    oninput="filterModalUrunList(this.value)">
            </div>
            <p style="font-size:12px; color:#7f8c8d; margin-bottom:10px;">Toplam ${sortedProducts.length} √ºr√ºn (√ºr√ºn koduna g√∂re sƒ±ralƒ±)</p>
            <div id="modalUrunListeContainer" style="max-height:350px; overflow-y:auto; background:#fff; border:1px solid #ddd; border-radius:8px;">
                ${renderUrunListeHTML(sortedProducts)}
            </div>
        </div>
    `;
    modal.classList.add('show');
}

function renderUrunListeHTML(products) {
    if (products.length === 0) {
        return '<div style="padding:20px; color:#7f8c8d; text-align:center;">√úr√ºn bulunamadƒ±</div>';
    }
    return products.map(p => `
        <div class="urun-liste-item" data-urun-id="${p.id}" onclick="addUrunToTalep(${p.id})" 
            style="padding:12px; cursor:pointer; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;"
            onmouseover="this.style.background='#f0f4ff'" onmouseout="this.style.background='#fff'">
            <div>
                <strong style="color:#667eea;">${p.urun_kodu}</strong>
                <span style="margin-left:10px;">${p.urun_adi}</span>
            </div>
            <div style="display:flex; align-items:center; gap:12px;">
                <span style="color:#7f8c8d; font-size:13px;">${p.birim}</span>
                <span style="background:#27ae60; color:#fff; padding:5px 12px; border-radius:4px; font-size:12px;">+ Ekle</span>
            </div>
        </div>
    `).join('');
}

function filterModalUrunList(query) {
    const container = document.getElementById('modalUrunListeContainer');
    const q = query.toLowerCase().trim();
    
    const sortedProducts = [...appData.products].sort((a, b) => a.urun_kodu.localeCompare(b.urun_kodu));
    const filtered = q.length > 0 
        ? sortedProducts.filter(p => p.urun_kodu.toLowerCase().includes(q) || p.urun_adi.toLowerCase().includes(q))
        : sortedProducts;
    
    container.innerHTML = renderUrunListeHTML(filtered);
}

function addUrunToTalep(urunId) {
    const urun = appData.products.find(p => p.id == urunId);
    if (!urun) return;
    
    const exists = document.querySelector(`#talepUrunBody tr[data-urun-id="${urunId}"]`);
    if (exists) {
        showToast('Bu √ºr√ºn zaten eklendi!', 'warning');
        return;
    }
    
    const tbody = document.getElementById('talepUrunBody');
    const row = document.createElement('tr');
    row.dataset.urunId = urunId;
    row.innerHTML = `
        <td><strong>${urun.urun_kodu}</strong></td>
        <td>${urun.urun_adi}</td>
        <td><input type="number" class="miktar-input" style="width:80px;padding:6px;text-align:center;" min="0.01" step="0.01" value="1"></td>
        <td>${urun.birim}</td>
        <td><input type="date" class="teslim-input" style="padding:6px;"></td>
        <td><button type="button" class="action-btn danger" onclick="removeUrunFromTalep(this)">√ó</button></td>
    `;
    tbody.appendChild(row);
    
    document.getElementById('bostablo').style.display = 'none';
    document.getElementById('urunUyari').style.display = 'none';
    showToast('√úr√ºn eklendi: ' + urun.urun_adi, 'success');
}

function removeUrunFromTalep(btn) {
    btn.closest('tr').remove();
    const tbody = document.getElementById('talepUrunBody');
    if (tbody.children.length === 0) {
        document.getElementById('bostablo').style.display = 'block';
    }
}

function renderTalepTakip() {
    const content = document.getElementById('mainContent');
    content.innerHTML = `
        <div class="page-header">
            <h2>üìã Talep Takip</h2>
            <p>T√ºm talepleri g√∂r√ºnt√ºleyin</p>
        </div>
        <div class="card">
            <h3>Talepler (${appData.requests.length})</h3>
            ${appData.requests.length === 0 ? '<div class="empty-state">Hen√ºz talep yok</div>' : `
            <table>
                <thead><tr><th>Talep No</th><th>Talep Eden</th><th>Aciliyet</th><th>Durum</th><th>Tarih</th><th>ƒ∞≈ülem</th></tr></thead>
                <tbody>
                    ${appData.requests.map(t => `
                        <tr>
                            <td><strong>${t.talep_no}</strong></td>
                            <td>${t.talep_eden || '-'}</td>
                            <td><span class="badge badge-${t.aciliyet === 'Acil' ? 'danger' : t.aciliyet === 'Y√ºksek' ? 'warning' : 'info'}">${t.aciliyet}</span></td>
                            <td><span class="badge badge-${t.durum === 'Onaylandƒ±' ? 'success' : t.durum === 'Reddedildi' ? 'danger' : 'warning'}">${t.durum}</span></td>
                            <td>${new Date(t.created_at).toLocaleDateString('tr-TR')}</td>
                            <td><button class="action-btn primary" onclick="showTalepDetay(${t.id})">Detay</button></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>`}
        </div>
    `;
}

function showTalepDetay(id) {
    const talep = appData.requests.find(t => t.id === id);
    if (!talep) return;
    
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    modalContent.innerHTML = `
        <div class="modal-header">
            <h3>Talep Detayƒ±: ${talep.talep_no}</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <p><strong>Durum:</strong> <span class="badge badge-${talep.durum === 'Onaylandƒ±' ? 'success' : talep.durum === 'Reddedildi' ? 'danger' : 'warning'}">${talep.durum}</span></p>
            <p><strong>Talep Eden:</strong> ${talep.talep_eden || '-'}</p>
            <p><strong>Aciliyet:</strong> ${talep.aciliyet}</p>
            <p><strong>A√ßƒ±klama:</strong> ${talep.aciklama || '-'}</p>
            <h4 style="margin: 20px 0 10px;">√úr√ºnler</h4>
            <table>
                <thead><tr><th>√úr√ºn</th><th>Miktar</th><th>Birim</th></tr></thead>
                <tbody>
                    ${(talep.items || []).map(i => `<tr><td>${i.urun_kodu} - ${i.urun_adi}</td><td>${i.miktar}</td><td>${i.birim}</td></tr>`).join('')}
                </tbody>
            </table>
        </div>
    `;
    modal.classList.add('show');
}

function closeModal() {
    document.getElementById('modal').classList.remove('show');
}

function renderTalepOnay() {
    const bekleyenler = appData.requests.filter(t => t.durum === 'Beklemede');
    const content = document.getElementById('mainContent');
    content.innerHTML = `
        <div class="page-header">
            <h2>‚úì Talep Onay</h2>
            <p>Bekleyen talepleri onaylayƒ±n veya reddedin</p>
        </div>
        <div class="card">
            <h3>Bekleyen Talepler (${bekleyenler.length})</h3>
            ${bekleyenler.length === 0 ? '<div class="empty-state">Onay bekleyen talep yok</div>' : `
            <table>
                <thead><tr><th>Talep No</th><th>Talep Eden</th><th>Aciliyet</th><th>√úr√ºn Sayƒ±sƒ±</th><th>Detay</th><th>ƒ∞≈ülem</th></tr></thead>
                <tbody>
                    ${bekleyenler.map(t => `
                        <tr>
                            <td><strong>${t.talep_no}</strong></td>
                            <td>${t.talep_eden || '-'}</td>
                            <td><span class="badge badge-${t.aciliyet === 'Acil' ? 'danger' : t.aciliyet === 'Y√ºksek' ? 'warning' : 'info'}">${t.aciliyet}</span></td>
                            <td>${(t.items || []).length}</td>
                            <td><button class="action-btn primary" onclick="showTalepDetay(${t.id})">G√∂r√ºnt√ºle</button></td>
                            <td>
                                <button class="action-btn success" onclick="showOnayModal(${t.id}, 'Onaylandƒ±')">Onayla</button>
                                <button class="action-btn danger" onclick="showOnayModal(${t.id}, 'Reddedildi')">Reddet</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>`}
        </div>
    `;
}

function showOnayModal(talepId, durum) {
    const talep = appData.requests.find(t => t.id === talepId);
    if (!talep) return;
    
    const isRet = durum === 'Reddedildi';
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    
    modalContent.innerHTML = `
        <div class="modal-header">
            <h3>${isRet ? '‚ùå Talep Reddet' : '‚úÖ Talep Onayla'}: ${talep.talep_no}</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <p><strong>Talep Eden:</strong> ${talep.talep_eden || '-'}</p>
            <p><strong>√úr√ºn Sayƒ±sƒ±:</strong> ${(talep.items || []).length}</p>
            <div class="form-group" style="margin-top:15px;">
                <label>${isRet ? 'Red Gerek√ßesi *' : 'A√ßƒ±klama (Opsiyonel)'}</label>
                <textarea id="onayAciklama" rows="3" placeholder="${isRet ? 'Red gerek√ßesini yazƒ±nƒ±z...' : 'A√ßƒ±klama ekleyebilirsiniz...'}"
                    style="width:100%; padding:10px; border:${isRet ? '2px solid #e74c3c' : '1px solid #ddd'}; border-radius:8px;"></textarea>
                ${isRet ? '<p style="color:#e74c3c; font-size:12px; margin-top:5px;">* Ret i√ßin a√ßƒ±klama zorunludur</p>' : ''}
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn ${isRet ? 'btn-danger' : 'btn-success'}" onclick="confirmOnayDurum(${talepId}, '${durum}')" style="flex:1;">
                    ${isRet ? '‚ùå Reddet' : '‚úÖ Onayla'}
                </button>
                <button class="btn btn-secondary" onclick="closeModal()" style="flex:1; background:#6c757d;">ƒ∞ptal</button>
            </div>
        </div>
    `;
    modal.classList.add('show');
}

async function confirmOnayDurum(id, durum) {
    const aciklama = document.getElementById('onayAciklama').value.trim();
    
    if (durum === 'Reddedildi' && !aciklama) {
        showToast('Ret i√ßin a√ßƒ±klama yazmanƒ±z zorunludur!', 'error');
        document.getElementById('onayAciklama').focus();
        return;
    }
    
    await apiCall(`requests/${id}`, 'PUT', { durum, onay_aciklama: aciklama });
    closeModal();
    showToast(`Talep ${durum.toLowerCase()}`);
    navigateTo('talep-onay');
}

function renderStokListe() {
    const content = document.getElementById('mainContent');
    
    const stokHesapla = {};
    appData.stockMovements.forEach(h => {
        if (!stokHesapla[h.urun_id]) stokHesapla[h.urun_id] = 0;
        if (h.hareket_tipi === 'Giri≈ü') {
            stokHesapla[h.urun_id] += parseFloat(h.miktar) || 0;
        } else {
            stokHesapla[h.urun_id] -= parseFloat(h.miktar) || 0;
        }
    });
    
    const urunlerWithStok = appData.products.map(p => ({
        ...p,
        gercek_stok: stokHesapla[p.id] || 0
    }));
    
    const toplamStokDeger = urunlerWithStok.reduce((sum, p) => sum + p.gercek_stok, 0);
    
    content.innerHTML = `
        <div class="page-header">
            <h2>üìã Stok Listesi</h2>
            <p>Teslim alƒ±nan √ºr√ºnlerin stok durumu</p>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">√úr√ºnler (${urunlerWithStok.length})</h3>
                <span style="font-weight:bold; color:#667eea;">Toplam Stok Adedi: ${toplamStokDeger.toLocaleString('tr-TR')}</span>
            </div>
            ${urunlerWithStok.length === 0 ? '<div class="empty-state">Hen√ºz √ºr√ºn yok</div>' : `
            <table>
                <thead><tr><th>√úr√ºn Kodu</th><th>√úr√ºn Adƒ±</th><th>Kategori</th><th>Birim</th><th>Stok Miktarƒ±</th></tr></thead>
                <tbody>
                    ${urunlerWithStok.map(p => {
                        return `
                        <tr>
                            <td><strong>${p.urun_kodu}</strong></td>
                            <td>${p.urun_adi}</td>
                            <td><span class="badge badge-info">${p.ana_kategori || '-'}</span></td>
                            <td>${p.birim}</td>
                            <td><strong>${p.gercek_stok.toLocaleString('tr-TR')}</strong> ${p.birim}</td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>`}
        </div>
    `;
}

function renderStokHareketler() {
    const content = document.getElementById('mainContent');
    content.innerHTML = `
        <div class="page-header">
            <h2>üîÑ Stok Hareketleri</h2>
            <p>Depolar arasƒ± giri≈ü ve √ßƒ±kƒ±≈ü hareketleri</p>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Hareketler (${appData.stockMovements.length})</h3>
                <div>
                    <button class="btn btn-info btn-sm" onclick="printStokHareketler()">üñ®Ô∏è Yazdƒ±r</button>
                    <button class="btn btn-sm" onclick="printStokHareketler()">üìÑ PDF</button>
                </div>
            </div>
            ${appData.stockMovements.length === 0 ? '<div class="empty-state">Hen√ºz hareket yok</div>' : `
            <table>
                <thead><tr><th>Tarih</th><th>√úr√ºn</th><th>Hareket</th><th>Miktar</th><th>Kaynak</th><th>Hedef</th><th>A√ßƒ±klama</th></tr></thead>
                <tbody>
                    ${appData.stockMovements.map(h => {
                        const kaynak = h.kaynak_depo || '-';
                        const hedef = h.hedef_depo || '-';
                        return `
                        <tr>
                            <td>${new Date(h.created_at).toLocaleDateString('tr-TR')}</td>
                            <td>${h.urun_kodu} - ${h.urun_adi}</td>
                            <td><span class="badge badge-${h.hareket_tipi === 'Giri≈ü' ? 'success' : 'danger'}">${h.hareket_tipi}</span></td>
                            <td>${h.miktar} ${h.birim}</td>
                            <td>${kaynak}</td>
                            <td>${hedef}</td>
                            <td>${h.aciklama || '-'}</td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>`}
        </div>
    `;
}

function printStokHareketler() {
    printListAsPDF('Stok Hareketleri', appData.stockMovements, [
        { header: 'Tarih', field: 'created_at', format: (v) => v ? new Date(v).toLocaleDateString('tr-TR') : '-' },
        { header: '√úr√ºn Kodu', field: 'urun_kodu' },
        { header: '√úr√ºn Adƒ±', field: 'urun_adi' },
        { header: 'Hareket', field: 'hareket_tipi' },
        { header: 'Miktar', field: 'miktar' },
        { header: 'Birim', field: 'birim' },
        { header: 'A√ßƒ±klama', field: 'aciklama' }
    ]);
}

function renderStokHareket(tip) {
    const content = document.getElementById('mainContent');
    const icon = tip === 'Giri≈ü' ? '‚¨áÔ∏è' : '‚¨ÜÔ∏è';
    const depoListesi = appData.projects.filter(p => p.durum === 'Aktif');
    
    content.innerHTML = `
        <div class="page-header">
            <h2>${icon} Stok ${tip}</h2>
            <p>Depolar arasƒ± √ºr√ºn transferi yapƒ±n (Her proje bir depodur)</p>
        </div>
        <div class="card">
            <form id="stokForm">
                <div class="form-grid">
                    ${tip === 'Giri≈ü' ? `
                        <div class="form-group">
                            <label>üì• Hedef Depo (Proje) *</label>
                            <select id="hedefDepo" required>
                                <option value="">Hedef Depo Se√ßin...</option>
                                <option value="ANA-DEPO">üè≠ Ana Depo (Merkez)</option>
                                ${depoListesi.map(p => `<option value="${p.proje_kodu}">${p.proje_kodu} - ${p.proje_adi}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>üì§ Kaynak (Nereden Geliyor)</label>
                            <input type="text" id="kaynakDepo" placeholder="Tedarik√ßi, i√ß transfer vb." value="Tedarik√ßi">
                        </div>
                    ` : `
                        <div class="form-group">
                            <label>üì§ Kaynak Depo (Nereden √áƒ±kƒ±yor) *</label>
                            <select id="kaynakDepo" required>
                                <option value="">Kaynak Depo Se√ßin...</option>
                                <option value="ANA-DEPO">üè≠ Ana Depo (Merkez)</option>
                                ${depoListesi.map(p => `<option value="${p.proje_kodu}">${p.proje_kodu} - ${p.proje_adi}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>üì• Hedef Depo (Nereye Gidiyor) *</label>
                            <select id="hedefDepo" required>
                                <option value="">Hedef Depo Se√ßin...</option>
                                ${depoListesi.map(p => `<option value="${p.proje_kodu}">${p.proje_kodu} - ${p.proje_adi}</option>`).join('')}
                                <option value="KULLANIM">‚öôÔ∏è Kullanƒ±m / T√ºketim</option>
                                <option value="IADE">‚Ü©Ô∏è ƒ∞ade</option>
                            </select>
                        </div>
                    `}
                </div>
                <div class="form-grid">
                    <div class="form-group"><label>√úr√ºn *</label>
                        <select id="stokUrun" required onchange="updateStokBirim()">
                            <option value="">√úr√ºn Se√ßin...</option>
                            ${appData.products.map(p => `<option value="${p.id}" data-birim="${p.birim}" data-stok="${p.stok_miktari}">${p.urun_kodu} - ${p.urun_adi} (Stok: ${p.stok_miktari})</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group"><label>Miktar *</label>
                        <input type="number" id="stokMiktar" required min="0.01" step="0.01">
                    </div>
                    <div class="form-group"><label>Birim</label>
                        <input type="text" id="stokBirim" readonly style="background:#f8f9fa;">
                    </div>
                </div>
                <div class="form-group"><label>A√ßƒ±klama / Not</label><textarea id="stokAciklama" rows="2" placeholder="Transfer ile ilgili notlar..."></textarea></div>
                <button type="submit" class="btn ${tip === 'Giri≈ü' ? 'btn-success' : 'btn-danger'}">${icon} ${tip} Yap</button>
            </form>
        </div>
        
        <div class="card" style="margin-top:20px; background:#f8f9fa;">
            <h4 style="margin:0 0 10px;">üìã Depo Bilgisi</h4>
            <p style="margin:0; color:#666;">Her proje bir depo olarak tanƒ±mlanmƒ±≈ütƒ±r. Stok giri≈ülerinde tedarik√ßiden gelen √ºr√ºnler hedef depoya (projeye) girer. Stok √ßƒ±kƒ±≈ülarƒ±nda √ºr√ºnler kaynak depodan hedef depoya (ba≈üka projeye veya kullanƒ±ma) transfer edilir.</p>
        </div>
    `;
    
    document.getElementById('stokForm').onsubmit = async (e) => {
        e.preventDefault();
        const urunId = document.getElementById('stokUrun').value;
        const miktar = parseFloat(document.getElementById('stokMiktar').value);
        const hedefDepo = document.getElementById('hedefDepo')?.value || '';
        const kaynakDepo = document.getElementById('kaynakDepo')?.value || '';
        
        let aciklama = document.getElementById('stokAciklama').value;
        if (tip === 'Giri≈ü') {
            aciklama = `[${kaynakDepo}] ‚Üí [${hedefDepo}] ${aciklama}`;
        } else {
            aciklama = `[${kaynakDepo}] ‚Üí [${hedefDepo}] ${aciklama}`;
        }
        
        const res = await apiCall('stock-movements', 'POST', {
            license_code: currentUser.license_code,
            urun_id: urunId,
            hareket_tipi: tip,
            miktar,
            kaynak_depo: kaynakDepo,
            hedef_depo: hedefDepo,
            aciklama: aciklama
        });
        
        if (res.success) {
            showToast(`Stok ${tip.toLowerCase()}i yapƒ±ldƒ±! Yeni stok: ${res.new_stock}`);
            navigateTo('stok-liste');
        } else {
            showToast(res.message || 'Hata olu≈ütu!', 'error');
        }
    };
}

function updateStokBirim() {
    const select = document.getElementById('stokUrun');
    const opt = select.options[select.selectedIndex];
    document.getElementById('stokBirim').value = opt.dataset.birim || '';
}

function getNextProductCode() {
    if (appData.products.length === 0) return 'URN-0001';
    const codes = appData.products.map(p => {
        const match = p.urun_kodu.match(/URN-(\d+)/);
        return match ? parseInt(match[1]) : 0;
    });
    const maxCode = Math.max(...codes);
    return `URN-${String(maxCode + 1).padStart(4, '0')}`;
}

function getAnaKategoriler() {
    return (appData.categories || []).filter(c => c.seviye === 1);
}

function getAltKategoriler1(anaKategoriId) {
    if (!anaKategoriId) return (appData.categories || []).filter(c => c.seviye === 2);
    return (appData.categories || []).filter(c => c.seviye === 2 && c.ust_kategori_id === parseInt(anaKategoriId));
}

function getAltKategoriler2(altKategori1Id) {
    if (!altKategori1Id) return (appData.categories || []).filter(c => c.seviye === 3);
    return (appData.categories || []).filter(c => c.seviye === 3 && c.ust_kategori_id === parseInt(altKategori1Id));
}

function renderKategoriYonetim() {
    const content = document.getElementById('mainContent');
    const anaKategoriler = getAnaKategoriler();
    const altKategoriler1 = (appData.categories || []).filter(c => c.seviye === 2);
    const altKategoriler2 = (appData.categories || []).filter(c => c.seviye === 3);
    
    content.innerHTML = `
        <div class="page-header">
            <h2>üóÇÔ∏è Kategori Y√∂netimi</h2>
            <p>Firmanƒ±za √∂zel √ºr√ºn kategorilerini tanƒ±mlayƒ±n (3 kademeli)</p>
        </div>
        
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px;">
            <div class="card">
                <h3>1Ô∏è‚É£ Ana Kategori</h3>
                <form id="anaKategoriForm" style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="anaKategoriAdi" placeholder="√ñrn: Hammadde, Ambalaj, Elektrik..." required style="flex:1;">
                    <button type="submit" class="btn btn-sm">+ Ekle</button>
                </form>
                <div class="kategori-liste" id="anaKategoriListe">
                    ${anaKategoriler.length === 0 ? '<div class="empty-state">Hen√ºz ana kategori yok</div>' : 
                    anaKategoriler.map(k => `
                        <div class="kategori-item" style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:#f8f9fa; border-radius:8px; margin-bottom:8px;">
                            <span><strong>${k.kategori_adi}</strong></span>
                            <div style="display:flex; gap:5px;">
                                <button class="action-btn btn-sm" onclick="editCategory(${k.id}, '${k.kategori_adi}')" style="padding:4px 8px; font-size:12px;">D√ºzenle</button>
                                <button class="action-btn danger btn-sm" onclick="deleteCategory(${k.id})" style="padding:4px 8px; font-size:12px;">Sil</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <div class="card">
                <h3>2Ô∏è‚É£ Alt Kategori (1. Seviye)</h3>
                <form id="altKategori1Form" style="display:flex; flex-direction:column; gap:10px; margin-bottom:15px;">
                    <select id="altKategori1Ust" required>
                        <option value="">Ana Kategori Se√ßin...</option>
                        ${anaKategoriler.map(k => `<option value="${k.id}">${k.kategori_adi}</option>`).join('')}
                    </select>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="altKategori1Adi" placeholder="√ñrn: Kaƒüƒ±t, Plastik, Cam..." required style="flex:1;">
                        <button type="submit" class="btn btn-sm">+ Ekle</button>
                    </div>
                </form>
                <div class="kategori-liste" id="altKategori1Liste">
                    ${altKategoriler1.length === 0 ? '<div class="empty-state">Hen√ºz alt kategori yok</div>' : 
                    altKategoriler1.map(k => {
                        const ust = anaKategoriler.find(a => a.id === k.ust_kategori_id);
                        return `
                        <div class="kategori-item" style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:#f8f9fa; border-radius:8px; margin-bottom:8px;">
                            <span><strong>${k.kategori_adi}</strong> <small style="color:#888;">(${ust ? ust.kategori_adi : '-'})</small></span>
                            <div style="display:flex; gap:5px;">
                                <button class="action-btn btn-sm" onclick="editCategory(${k.id}, '${k.kategori_adi}')" style="padding:4px 8px; font-size:12px;">D√ºzenle</button>
                                <button class="action-btn danger btn-sm" onclick="deleteCategory(${k.id})" style="padding:4px 8px; font-size:12px;">Sil</button>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            </div>
            
            <div class="card">
                <h3>3Ô∏è‚É£ Alt Kategori (2. Seviye)</h3>
                <form id="altKategori2Form" style="display:flex; flex-direction:column; gap:10px; margin-bottom:15px;">
                    <select id="altKategori2Ust" required>
                        <option value="">1. Seviye Alt Kategori Se√ßin...</option>
                        ${altKategoriler1.map(k => {
                            const ust = anaKategoriler.find(a => a.id === k.ust_kategori_id);
                            return `<option value="${k.id}">${ust ? ust.kategori_adi + ' > ' : ''}${k.kategori_adi}</option>`;
                        }).join('')}
                    </select>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="altKategori2Adi" placeholder="√ñrn: A4, Karton, ≈ûeffaf..." required style="flex:1;">
                        <button type="submit" class="btn btn-sm">+ Ekle</button>
                    </div>
                </form>
                <div class="kategori-liste" id="altKategori2Liste">
                    ${altKategoriler2.length === 0 ? '<div class="empty-state">Hen√ºz 2. seviye alt kategori yok</div>' : 
                    altKategoriler2.map(k => {
                        const ust1 = altKategoriler1.find(a => a.id === k.ust_kategori_id);
                        const ust0 = ust1 ? anaKategoriler.find(a => a.id === ust1.ust_kategori_id) : null;
                        return `
                        <div class="kategori-item" style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:#f8f9fa; border-radius:8px; margin-bottom:8px;">
                            <span><strong>${k.kategori_adi}</strong> <small style="color:#888;">(${ust0 ? ust0.kategori_adi + ' > ' : ''}${ust1 ? ust1.kategori_adi : '-'})</small></span>
                            <div style="display:flex; gap:5px;">
                                <button class="action-btn btn-sm" onclick="editCategory(${k.id}, '${k.kategori_adi}')" style="padding:4px 8px; font-size:12px;">D√ºzenle</button>
                                <button class="action-btn danger btn-sm" onclick="deleteCategory(${k.id})" style="padding:4px 8px; font-size:12px;">Sil</button>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            </div>
        </div>
        
        <div class="card" style="margin-top:20px; background:#e8f4f8;">
            <h3>üí° Kategori Kullanƒ±m Rehberi</h3>
            <p>Kategorilerinizi firmanƒ±zƒ±n sekt√∂r√ºne g√∂re tanƒ±mlayƒ±n. √ñrnek yapƒ±lar:</p>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-top:10px;">
                <div style="background:white; padding:12px; border-radius:8px;">
                    <strong>Gƒ±da Sekt√∂r√º:</strong><br>
                    <small>Hammadde > Et √úr√ºnleri > Kƒ±rmƒ±zƒ± Et<br>
                    Ambalaj > Plastik > Vakum Po≈üet</small>
                </div>
                <div style="background:white; padding:12px; border-radius:8px;">
                    <strong>Kozmetik Sekt√∂r√º:</strong><br>
                    <small>Ham Materyal > Yaƒülar > Bitkisel Yaƒü<br>
                    Ambalaj > ≈ûi≈üe > Cam ≈ûi≈üe</small>
                </div>
                <div style="background:white; padding:12px; border-radius:8px;">
                    <strong>ƒ∞n≈üaat Sekt√∂r√º:</strong><br>
                    <small>Yapƒ± Malz. > Beton > Hazƒ±r Beton<br>
                    Elektrik > Kablo > NYM Kablo</small>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('anaKategoriForm').onsubmit = async (e) => {
        e.preventDefault();
        const ad = document.getElementById('anaKategoriAdi').value.trim();
        if (!ad) return;
        await apiCall('categories', 'POST', { license_code: currentUser.license_code, seviye: 1, kategori_adi: ad, ust_kategori_id: null });
        showToast('Ana kategori eklendi');
        navigateTo('kategori-yonetim');
    };
    
    document.getElementById('altKategori1Form').onsubmit = async (e) => {
        e.preventDefault();
        const ustId = document.getElementById('altKategori1Ust').value;
        const ad = document.getElementById('altKategori1Adi').value.trim();
        if (!ustId || !ad) return;
        await apiCall('categories', 'POST', { license_code: currentUser.license_code, seviye: 2, kategori_adi: ad, ust_kategori_id: parseInt(ustId) });
        showToast('Alt kategori eklendi');
        navigateTo('kategori-yonetim');
    };
    
    document.getElementById('altKategori2Form').onsubmit = async (e) => {
        e.preventDefault();
        const ustId = document.getElementById('altKategori2Ust').value;
        const ad = document.getElementById('altKategori2Adi').value.trim();
        if (!ustId || !ad) return;
        await apiCall('categories', 'POST', { license_code: currentUser.license_code, seviye: 3, kategori_adi: ad, ust_kategori_id: parseInt(ustId) });
        showToast('2. seviye alt kategori eklendi');
        navigateTo('kategori-yonetim');
    };
}

async function deleteCategory(id) {
    if (!confirm('Bu kategoriyi silmek istediƒüinizden emin misiniz?')) return;
    const res = await fetch(`/api/categories/${id}?license_code=${currentUser.license_code}`, { method: 'DELETE' });
    const data = await res.json();
    if (data.success) {
        showToast('Kategori silindi');
        navigateTo('kategori-yonetim');
    } else {
        showToast(data.message || 'Kategori silinemedi!', 'error');
    }
}

function editCategory(id, currentName) {
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    
    modalContent.innerHTML = `
        <div class="modal-header">
            <h3>Kategori D√ºzenle</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Kategori Adƒ±</label>
                <input type="text" id="editKategoriAdi" value="${currentName}" required>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="saveCategory(${id})">Kaydet</button>
            <button class="btn btn-secondary" onclick="closeModal()">ƒ∞ptal</button>
        </div>
    `;
    
    modal.classList.add('show');
}

async function saveCategory(id) {
    const newName = document.getElementById('editKategoriAdi').value.trim();
    if (!newName) {
        showToast('Kategori adƒ± bo≈ü olamaz!', 'error');
        return;
    }
    
    const res = await fetch(`/api/categories/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            license_code: currentUser.license_code,
            kategori_adi: newName
        })
    });
    
    const data = await res.json();
    if (data.success) {
        showToast('Kategori g√ºncellendi');
        closeModal();
        navigateTo('kategori-yonetim');
    } else {
        showToast(data.message || 'G√ºncelleme ba≈üarƒ±sƒ±z!', 'error');
    }
}

function renderUrunYonetim() {
    const content = document.getElementById('mainContent');
    const nextCode = getNextProductCode();
    const anaKategoriler = getAnaKategoriler();
    const altKategoriler1 = (appData.categories || []).filter(c => c.seviye === 2);
    const altKategoriler2 = (appData.categories || []).filter(c => c.seviye === 3);
    
    const kategoriBilgisi = anaKategoriler.length === 0 
        ? '<span style="color:#e74c3c;">Hen√ºz kategori tanƒ±mlanmamƒ±≈ü. <a href="#" onclick="navigateTo(\'kategori-yonetim\'); return false;">Kategori Y√∂netimi</a>\'nden kategori ekleyin.</span>'
        : `<strong>Ana Kategoriler:</strong> ${anaKategoriler.map(k => k.kategori_adi).join(', ')}`;
    
    content.innerHTML = `
        <div class="page-header">
            <h2>üì¶ √úr√ºn Tanƒ±mlarƒ±</h2>
            <p>√úr√ºnleri y√∂netin - Excel ile toplu aktarƒ±m yapabilirsiniz</p>
        </div>
        
        <div class="card">
            <h3>üì• Excel ile Toplu √úr√ºn Aktarƒ±mƒ±</h3>
            <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                <button type="button" class="btn btn-info btn-sm" onclick="downloadExcelTemplate()">
                    üìÑ Excel ≈ûablonu ƒ∞ndir
                </button>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="file" id="excelFileInput" accept=".csv,.xlsx,.xls" style="display:none;" onchange="importExcelFile(this)">
                    <button type="button" class="btn btn-success btn-sm" onclick="document.getElementById('excelFileInput').click()">
                        üì§ Excel'den Aktar
                    </button>
                </div>
                <button type="button" class="btn btn-warning btn-sm" onclick="exportProductsToExcel()">
                    üìä Listeyi Excel Olarak ƒ∞ndir
                </button>
            </div>
            <div style="background:#e8f4f8; padding:12px; border-radius:8px; font-size:13px;">
                <strong>Kategori Bilgisi:</strong><br>
                ${kategoriBilgisi}
            </div>
        </div>
        
        <div class="card">
            <h3>‚ûï Manuel √úr√ºn Ekle</h3>
            <form id="urunForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>√úr√ºn Kodu *</label>
                        <input type="text" id="urunKodu" value="${nextCode}" required readonly style="background: #f0f0f0;">
                        <small style="color: #7f8c8d;">Otomatik olu≈üturulur</small>
                    </div>
                    <div class="form-group"><label>√úr√ºn Adƒ± *</label><input type="text" id="urunAdi" required placeholder="√úr√ºn adƒ±nƒ± girin"></div>
                    <div class="form-group"><label>Ana Kategori *</label>
                        <select id="urunAnaKategori" required onchange="updateAltKategoriSecim()">
                            <option value="">Se√ßin...</option>
                            ${anaKategoriler.map(k => `<option value="${k.id}" data-adi="${k.kategori_adi}">${k.kategori_adi}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group"><label>Alt Kategori 1</label>
                        <select id="urunAltKategori1" onchange="updateAltKategori2Secim()">
                            <option value="">Se√ßin...</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Alt Kategori 2</label>
                        <select id="urunAltKategori2">
                            <option value="">Se√ßin...</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Birim *</label>
                        <select id="urunBirim" required>
                            <option>Adet</option><option>Kg</option><option>Ton</option><option>Metre</option><option>m¬≤</option><option>m¬≥</option><option>Litre</option><option>Paket</option><option>Kutu</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn">üíæ √úr√ºn Ekle</button>
            </form>
        </div>
        
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
                <h3 style="margin:0;">üìã √úr√ºn Listesi (${appData.products.length})</h3>
                <div style="display:flex; gap:10px; align-items:center;">
                    <select id="filterAnaKategori" onchange="filterUrunListesi()" style="padding:8px;">
                        <option value="">T√ºm Ana Kategoriler</option>
                        ${anaKategoriler.map(k => `<option value="${k.kategori_adi}">${k.kategori_adi}</option>`).join('')}
                    </select>
                </div>
            </div>
            ${appData.products.length === 0 ? '<div class="empty-state">Hen√ºz √ºr√ºn yok. Excel ≈üablonunu indirip toplu √ºr√ºn ekleyebilirsiniz.</div>' : `
            <table id="urunListesiTable">
                <thead><tr><th>Kod</th><th>√úr√ºn Adƒ±</th><th>Ana Kategori</th><th>Alt Kategori 1</th><th>Alt Kategori 2</th><th>Birim</th><th>ƒ∞≈ülem</th></tr></thead>
                <tbody>
                    ${appData.products.map(p => `
                        <tr data-ana="${p.ana_kategori || ''}">
                            <td><strong>${p.urun_kodu}</strong></td>
                            <td>${p.urun_adi}</td>
                            <td><span class="badge badge-info">${p.ana_kategori || '-'}</span></td>
                            <td><span class="badge badge-warning">${p.alt_kategori || '-'}</span></td>
                            <td><span class="badge badge-success">${p.alt_kategori_2 || '-'}</span></td>
                            <td>${p.birim}</td>
                            <td><button class="action-btn danger" onclick="deleteProduct(${p.id})">Sil</button></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>`}
        </div>
    `;
    
    document.getElementById('urunForm').onsubmit = async (e) => {
        e.preventDefault();
        const urunKodu = document.getElementById('urunKodu').value;
        
        const exists = appData.products.find(p => p.urun_kodu === urunKodu);
        if (exists) {
            showToast('Bu √ºr√ºn kodu zaten mevcut!', 'error');
            return;
        }
        
        const anaKatSelect = document.getElementById('urunAnaKategori');
        const altKat1Select = document.getElementById('urunAltKategori1');
        const altKat2Select = document.getElementById('urunAltKategori2');
        
        const anaKatAdi = anaKatSelect.options[anaKatSelect.selectedIndex]?.dataset?.adi || '';
        const altKat1Adi = altKat1Select.options[altKat1Select.selectedIndex]?.dataset?.adi || '';
        const altKat2Adi = altKat2Select.options[altKat2Select.selectedIndex]?.dataset?.adi || '';
        
        const res = await apiCall('products', 'POST', {
            license_code: currentUser.license_code,
            urun_kodu: urunKodu,
            urun_adi: document.getElementById('urunAdi').value,
            ana_kategori: anaKatAdi,
            alt_kategori: altKat1Adi,
            alt_kategori_2: altKat2Adi,
            birim: document.getElementById('urunBirim').value,
            stok_miktari: 0,
            minimum_stok: 0
        });
        
        if (res.success) {
            showToast('√úr√ºn eklendi');
            navigateTo('urun-yonetim');
        } else {
            showToast(res.message || 'Hata olu≈ütu!', 'error');
        }
    };
}

function updateAltKategoriSecim() {
    const anaKatId = document.getElementById('urunAnaKategori').value;
    const altKat1Select = document.getElementById('urunAltKategori1');
    const altKat2Select = document.getElementById('urunAltKategori2');
    
    altKat1Select.innerHTML = '<option value="">Se√ßin...</option>';
    altKat2Select.innerHTML = '<option value="">Se√ßin...</option>';
    
    if (!anaKatId) return;
    
    const altKategoriler = getAltKategoriler1(anaKatId);
    altKategoriler.forEach(k => {
        altKat1Select.innerHTML += `<option value="${k.id}" data-adi="${k.kategori_adi}">${k.kategori_adi}</option>`;
    });
}

function updateAltKategori2Secim() {
    const altKat1Id = document.getElementById('urunAltKategori1').value;
    const altKat2Select = document.getElementById('urunAltKategori2');
    
    altKat2Select.innerHTML = '<option value="">Se√ßin...</option>';
    
    if (!altKat1Id) return;
    
    const altKategoriler = getAltKategoriler2(altKat1Id);
    altKategoriler.forEach(k => {
        altKat2Select.innerHTML += `<option value="${k.id}" data-adi="${k.kategori_adi}">${k.kategori_adi}</option>`;
    });
}

function filterUrunListesi() {
    const anaFilter = document.getElementById('filterAnaKategori').value;
    const rows = document.querySelectorAll('#urunListesiTable tbody tr');
    
    rows.forEach(row => {
        const anaKat = row.dataset.ana || '';
        let show = true;
        if (anaFilter && anaKat !== anaFilter) show = false;
        row.style.display = show ? '' : 'none';
    });
}

function downloadExcelTemplate() {
    const template = `urun_kodu,urun_adi,ana_kategori,alt_kategori,birim,minimum_stok
URN-0001,√áimento CEM I 42.5R,ƒ∞n≈üaat Malzeme,Sarf Malzeme,Ton,20
URN-0002,Nerv√ºrl√º Demir 12mm,ƒ∞n≈üaat Malzeme,Demirba≈ü,Ton,15
URN-0003,NYY Kablo 3x2.5mm,Elektrik Malzeme,Sarf Malzeme,Metre,100
URN-0004,Klima Split 12000 BTU,Mekanik Malzeme,Demirba≈ü,Adet,5
URN-0005,PVC Boru 110mm,Mekanik Malzeme,Sarf Malzeme,Metre,50`;
    const blob = new Blob(['\ufeff' + template], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'urun_sablonu.csv';
    link.click();
    showToast('≈ûablon indirildi - Kategori s√ºtunlarƒ±nƒ± doldurarak i√ße aktarabilirsiniz');
}

function exportProductsToExcel() {
    if (appData.products.length === 0) {
        showToast('ƒ∞ndirilecek √ºr√ºn yok!', 'warning');
        return;
    }
    
    let csv = 'urun_kodu,urun_adi,ana_kategori,alt_kategori,birim,stok_miktari,minimum_stok\n';
    appData.products.forEach(p => {
        csv += `${p.urun_kodu},${p.urun_adi},${p.ana_kategori || ''},${p.alt_kategori || ''},${p.birim},${p.stok_miktari},${p.minimum_stok}\n`;
    });
    
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `urun_listesi_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
    showToast('√úr√ºn listesi indirildi');
}

async function importExcelFile(input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        const text = e.target.result;
        const lines = text.split('\n').filter(line => line.trim());
        
        if (lines.length < 2) {
            showToast('Dosya bo≈ü veya sadece ba≈ülƒ±k satƒ±rƒ± var!', 'error');
            return;
        }
        
        const header = lines[0].toLowerCase();
        if (!header.includes('urun_kodu') || !header.includes('urun_adi')) {
            showToast('Ge√ßersiz format! ≈ûablonu kullanƒ±n.', 'error');
            return;
        }
        
        const headerCols = header.split(',').map(c => c.trim());
        const hasCategories = headerCols.includes('ana_kategori') && headerCols.includes('alt_kategori');
        
        let added = 0;
        let skipped = 0;
        
        for (let i = 1; i < lines.length; i++) {
            const cols = lines[i].split(',').map(c => c.trim());
            if (cols.length < 3) continue;
            
            let urun_kodu, urun_adi, ana_kategori, alt_kategori, birim, minimum_stok;
            
            if (hasCategories) {
                urun_kodu = cols[0];
                urun_adi = cols[1];
                ana_kategori = cols[2] || '';
                alt_kategori = cols[3] || '';
                birim = cols[4] || 'Adet';
                minimum_stok = parseInt(cols[5]) || 10;
            } else {
                urun_kodu = cols[0];
                urun_adi = cols[1];
                ana_kategori = '';
                alt_kategori = '';
                birim = cols[2] || 'Adet';
                minimum_stok = parseInt(cols[3]) || 10;
            }
            
            if (!urun_kodu || !urun_adi) continue;
            
            const exists = appData.products.find(p => p.urun_kodu === urun_kodu);
            if (exists) {
                skipped++;
                continue;
            }
            
            const res = await apiCall('products', 'POST', {
                license_code: currentUser.license_code,
                urun_kodu,
                urun_adi,
                ana_kategori,
                alt_kategori,
                birim,
                stok_miktari: 0,
                minimum_stok
            });
            
            if (res.success) added++;
        }
        
        input.value = '';
        showToast(`${added} √ºr√ºn eklendi${skipped > 0 ? `, ${skipped} m√ºkerrer atlandƒ±` : ''}`);
        navigateTo('urun-yonetim');
    };
    reader.readAsText(file, 'UTF-8');
}

async function deleteProduct(id) {
    if (!confirm('√úr√ºn√º silmek istediƒüinize emin misiniz?')) return;
    await apiCall(`products/${id}`, 'DELETE');
    showToast('√úr√ºn silindi');
    navigateTo('urun-yonetim');
}

function renderTedarikciYonetim() {
    const content = document.getElementById('mainContent');
    content.innerHTML = `
        <div class="page-header">
            <h2>üè¢ Tedarik√ßi Y√∂netimi</h2>
            <p>Tedarik√ßileri y√∂netin</p>
        </div>
        <div class="card">
            <h3>Yeni Tedarik√ßi Ekle</h3>
            <form id="tedarikciForm">
                <div class="form-grid">
                    <div class="form-group"><label>Tedarik√ßi Adƒ± *</label><input type="text" id="tedAdi" required></div>
                    <div class="form-group"><label>E-posta</label><input type="email" id="tedEmail"></div>
                    <div class="form-group"><label>Telefon</label><input type="text" id="tedTelefon"></div>
                    <div class="form-group"><label>Adres</label><input type="text" id="tedAdres"></div>
                </div>
                <button type="submit" class="btn">üíæ Tedarik√ßi Ekle</button>
            </form>
        </div>
        <div class="card">
            <h3>Tedarik√ßi Listesi (${appData.suppliers.length})</h3>
            ${appData.suppliers.length === 0 ? '<div class="empty-state">Hen√ºz tedarik√ßi yok</div>' : `
            <table>
                <thead><tr><th>Tedarik√ßi Adƒ±</th><th>E-posta</th><th>Telefon</th><th>ƒ∞≈ülem</th></tr></thead>
                <tbody>
                    ${appData.suppliers.map(t => `
                        <tr>
                            <td><strong>${t.tedarikci_adi}</strong></td>
                            <td>${t.tedarikci_email || '-'}</td>
                            <td>${t.tedarikci_telefon || '-'}</td>
                            <td><button class="action-btn danger" onclick="deleteSupplier(${t.id})">Sil</button></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>`}
        </div>
    `;
    
    document.getElementById('tedarikciForm').onsubmit = async (e) => {
        e.preventDefault();
        await apiCall('suppliers', 'POST', {
            license_code: currentUser.license_code,
            tedarikci_adi: document.getElementById('tedAdi').value,
            tedarikci_email: document.getElementById('tedEmail').value,
            tedarikci_telefon: document.getElementById('tedTelefon').value,
            tedarikci_adres: document.getElementById('tedAdres').value
        });
        showToast('Tedarik√ßi eklendi');
        navigateTo('tedarikci-yonetim');
    };
}

async function deleteSupplier(id) {
    if (!confirm('Tedarik√ßiyi silmek istediƒüinize emin misiniz?')) return;
    await apiCall(`suppliers/${id}`, 'DELETE');
    showToast('Tedarik√ßi silindi');
    navigateTo('tedarikci-yonetim');
}

function renderTeklifTopla() {
    const onaylananTalepler = appData.requests.filter(t => t.durum === 'Onaylandƒ±');
    const content = document.getElementById('mainContent');
    content.innerHTML = `
        <div class="page-header">
            <h2>üí∞ Teklif Topla</h2>
            <p>Tedarik√ßilerden teklif alƒ±n - birden fazla tedarik√ßiden fiyat girebilirsiniz</p>
        </div>
        <div class="card">
            <h3>Teklif Giri≈üi</h3>
            <div class="form-grid" style="margin-bottom:15px;">
                <div class="form-group"><label>Talep Se√ßin *</label>
                    <select id="teklifTalep" onchange="showTalepDetayForTeklif()">
                        <option value="">Talep Se√ßin...</option>
                        ${onaylananTalepler.map(t => `<option value="${t.id}">${t.talep_no} - ${t.talep_eden || 'Bilinmiyor'}</option>`).join('')}
                    </select>
                </div>
            </div>
            
            <div id="talepUrunlerContainer" style="display:none; margin-bottom:20px; background:#f8f9fa; padding:15px; border-radius:8px;">
                <h4 style="margin-bottom:10px;">Talep Edilen √úr√ºnler</h4>
                <table id="talepUrunlerTable">
                    <thead><tr><th>√úr√ºn Kodu</th><th>√úr√ºn Adƒ±</th><th>Miktar</th><th>Birim</th></tr></thead>
                    <tbody id="talepUrunlerBody"></tbody>
                </table>
            </div>
            
            <div id="teklifGirisContainer" style="display:none;">
                <h4 style="margin:20px 0 10px;">Tedarik√ßi Teklifleri</h4>
                <p style="font-size:13px; color:#7f8c8d; margin-bottom:15px;">Her tedarik√ßi i√ßin ayrƒ± teklif girebilirsiniz. En az bir tedarik√ßi ekleyin.</p>
                
                <div id="teklifListContainer"></div>
                
                <button type="button" class="btn btn-success btn-sm" onclick="addTeklifRow()" style="margin:15px 0;">
                    + Tedarik√ßi Teklifi Ekle
                </button>
                
                <div style="margin-top:20px;">
                    <button type="button" class="btn" onclick="saveTeklifler()">üíæ T√ºm Teklifleri Kaydet</button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3>Girilen Teklifler (${appData.offers.length})</h3>
            ${appData.offers.length === 0 ? '<div class="empty-state">Hen√ºz teklif yok</div>' : `
            <table>
                <thead><tr><th>Teklif No</th><th>Talep</th><th>Tedarik√ßi</th><th>√úr√ºn Sayƒ±sƒ±</th><th>Genel Toplam</th><th>Vade</th><th>Teslim</th><th>Detay</th></tr></thead>
                <tbody>
                    ${appData.offers.map(t => {
                        const urunFiyatlari = t.urun_fiyatlari ? JSON.parse(t.urun_fiyatlari) : [];
                        return `
                        <tr>
                            <td><strong>${t.teklif_no}</strong></td>
                            <td>${appData.requests.find(r => r.id === t.talep_id)?.talep_no || '-'}</td>
                            <td>${t.tedarikci_adi}</td>
                            <td>${urunFiyatlari.length || '-'} √ºr√ºn</td>
                            <td><strong>‚Ç∫${parseFloat(t.toplam_fiyat || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</strong></td>
                            <td>${t.odeme_vadesi || '-'} g√ºn</td>
                            <td>${t.teslim_suresi || '-'} g√ºn</td>
                            <td><button class="action-btn" onclick="showTeklifDetay(${t.id})">üëÅ</button></td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>`}
        </div>
    `;
}

function showTeklifDetay(teklifId) {
    const teklif = appData.offers.find(t => t.id === teklifId);
    if (!teklif) return;
    
    const urunFiyatlari = teklif.urun_fiyatlari ? JSON.parse(teklif.urun_fiyatlari) : [];
    const talep = appData.requests.find(r => r.id === teklif.talep_id);
    
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    
    modalContent.innerHTML = `
        <div class="modal-header">
            <h3>Teklif Detayƒ±: ${teklif.teklif_no}</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">
                <div><strong>Talep No:</strong> ${talep?.talep_no || '-'}</div>
                <div><strong>Tedarik√ßi:</strong> ${teklif.tedarikci_adi}</div>
                <div><strong>√ñdeme Vadesi:</strong> ${teklif.odeme_vadesi || '-'} g√ºn</div>
                <div><strong>Teslim S√ºresi:</strong> ${teklif.teslim_suresi || '-'} g√ºn</div>
            </div>
            
            <h4 style="margin-bottom:10px;">√úr√ºn Bazlƒ± Fiyatlar</h4>
            <table>
                <thead>
                    <tr><th>√úr√ºn</th><th>Miktar</th><th>Birim Fiyat</th><th>Toplam</th></tr>
                </thead>
                <tbody>
                    ${urunFiyatlari.map(u => {
                        const urun = appData.products.find(p => p.id == u.urun_id);
                        return `
                        <tr>
                            <td>${urun ? urun.urun_kodu + ' - ' + urun.urun_adi : '√úr√ºn #' + u.urun_id}</td>
                            <td>${u.miktar}</td>
                            <td>‚Ç∫${parseFloat(u.birim_fiyat).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                            <td><strong>‚Ç∫${parseFloat(u.toplam).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</strong></td>
                        </tr>`;
                    }).join('')}
                </tbody>
                <tfoot>
                    <tr style="background:#e8f4e8; font-weight:bold;">
                        <td colspan="3" style="text-align:right;">GENEL TOPLAM:</td>
                        <td>‚Ç∫${parseFloat(teklif.toplam_fiyat || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                    </tr>
                </tfoot>
            </table>
            
            ${teklif.notlar ? `<div style="margin-top:15px;"><strong>Notlar:</strong> ${teklif.notlar}</div>` : ''}
        </div>
    `;
    modal.classList.add('show');
}

function showTalepDetayForTeklif() {
    const talepId = document.getElementById('teklifTalep').value;
    const container = document.getElementById('talepUrunlerContainer');
    const teklifContainer = document.getElementById('teklifGirisContainer');
    
    if (!talepId) {
        container.style.display = 'none';
        teklifContainer.style.display = 'none';
        return;
    }
    
    const talep = appData.requests.find(t => t.id == talepId);
    if (!talep || !talep.items) return;
    
    const tbody = document.getElementById('talepUrunlerBody');
    tbody.innerHTML = talep.items.map(item => `
        <tr>
            <td><strong>${item.urun_kodu}</strong></td>
            <td>${item.urun_adi}</td>
            <td>${item.miktar}</td>
            <td>${item.birim}</td>
        </tr>
    `).join('');
    
    container.style.display = 'block';
    teklifContainer.style.display = 'block';
    document.getElementById('teklifListContainer').innerHTML = '';
    addTeklifRow();
}

let teklifRowCounter = 0;
function addTeklifRow() {
    const container = document.getElementById('teklifListContainer');
    const talepId = document.getElementById('teklifTalep').value;
    const talep = appData.requests.find(t => t.id == talepId);
    
    if (!talep || !talep.items || talep.items.length === 0) {
        showToast('Talep √ºr√ºn bilgisi bulunamadƒ±!', 'error');
        return;
    }
    
    teklifRowCounter++;
    const rowId = `teklif-row-${teklifRowCounter}`;
    
    const div = document.createElement('div');
    div.id = rowId;
    div.className = 'teklif-row';
    div.style.cssText = 'background:#fff; border:1px solid #ddd; border-radius:8px; padding:15px; margin-bottom:15px;';
    div.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h5 style="margin:0; color:#667eea;">Tedarik√ßi Teklifi #${teklifRowCounter}</h5>
            <button type="button" class="action-btn danger" onclick="removeTeklifRow('${rowId}')">√ó Kaldƒ±r</button>
        </div>
        <div class="form-grid" style="margin-bottom:15px;">
            <div class="form-group"><label>Tedarik√ßi *</label>
                <select class="teklif-tedarikci" required>
                    <option value="">Tedarik√ßi Se√ßin...</option>
                    ${appData.suppliers.map(s => `<option value="${s.id}" data-adi="${s.tedarikci_adi}">${s.tedarikci_adi}</option>`).join('')}
                </select>
            </div>
            <div class="form-group"><label>√ñdeme Vadesi (G√ºn)</label>
                <input type="number" class="teklif-vade" min="0" placeholder="√ñrn: 30">
            </div>
            <div class="form-group"><label>Teslim S√ºresi (G√ºn) *</label>
                <input type="number" class="teklif-teslim" required min="1" placeholder="√ñrn: 7">
            </div>
        </div>
        
        <h6 style="margin:10px 0; color:#555;">√úr√ºn Bazlƒ± Fiyatlandƒ±rma</h6>
        <table class="urun-fiyat-table" style="width:100%; font-size:14px;">
            <thead>
                <tr style="background:#f8f9fa;">
                    <th style="padding:10px;">√úr√ºn Kodu</th>
                    <th style="padding:10px;">√úr√ºn Adƒ±</th>
                    <th style="padding:10px; text-align:center;">Miktar</th>
                    <th style="padding:10px;">Birim</th>
                    <th style="padding:10px; width:120px;">Birim Fiyat (‚Ç∫)</th>
                    <th style="padding:10px; width:120px;">Toplam (‚Ç∫)</th>
                </tr>
            </thead>
            <tbody>
                ${talep.items.map((item, idx) => `
                    <tr data-item-index="${idx}" data-urun-id="${item.urun_id}" data-miktar="${item.miktar}">
                        <td style="padding:8px;"><strong>${item.urun_kodu}</strong></td>
                        <td style="padding:8px;">${item.urun_adi}</td>
                        <td style="padding:8px; text-align:center;">${item.miktar}</td>
                        <td style="padding:8px;">${item.birim}</td>
                        <td style="padding:8px;">
                            <input type="number" class="urun-birim-fiyat" step="0.01" min="0" 
                                style="width:100%; padding:6px; text-align:right;" 
                                placeholder="0.00"
                                oninput="calculateUrunToplam(this)">
                        </td>
                        <td style="padding:8px;">
                            <input type="number" class="urun-toplam" readonly 
                                style="width:100%; padding:6px; text-align:right; background:#f0f0f0;" value="0.00">
                        </td>
                    </tr>
                `).join('')}
            </tbody>
            <tfoot>
                <tr style="background:#e8f4e8; font-weight:bold;">
                    <td colspan="5" style="padding:10px; text-align:right;">GENEL TOPLAM:</td>
                    <td style="padding:10px;">
                        <input type="text" class="teklif-genel-toplam" readonly 
                            style="width:100%; padding:6px; text-align:right; background:#d4edda; font-weight:bold; border:none;" value="‚Ç∫0.00">
                    </td>
                </tr>
            </tfoot>
        </table>
        
        <div class="form-group" style="margin-top:15px;"><label>A√ßƒ±klama/Notlar</label>
            <textarea class="teklif-aciklama" rows="2" placeholder="Teklif detaylarƒ±, ko≈üullar vb."></textarea>
        </div>
    `;
    container.appendChild(div);
}

function removeTeklifRow(rowId) {
    document.getElementById(rowId).remove();
}

function calculateUrunToplam(input) {
    const row = input.closest('tr');
    const miktar = parseFloat(row.dataset.miktar) || 0;
    const birimFiyat = parseFloat(input.value) || 0;
    const toplam = miktar * birimFiyat;
    row.querySelector('.urun-toplam').value = toplam.toFixed(2);
    
    calculateGenelToplam(input.closest('.teklif-row'));
}

function calculateGenelToplam(teklifRow) {
    const toplamInputs = teklifRow.querySelectorAll('.urun-toplam');
    let genelToplam = 0;
    toplamInputs.forEach(inp => {
        genelToplam += parseFloat(inp.value) || 0;
    });
    teklifRow.querySelector('.teklif-genel-toplam').value = '‚Ç∫' + genelToplam.toLocaleString('tr-TR', {minimumFractionDigits: 2});
}

async function saveTeklifler() {
    const talepId = document.getElementById('teklifTalep').value;
    if (!talepId) {
        showToast('L√ºtfen talep se√ßin!', 'error');
        return;
    }
    
    const rows = document.querySelectorAll('.teklif-row');
    if (rows.length === 0) {
        showToast('En az bir tedarik√ßi teklifi ekleyin!', 'error');
        return;
    }
    
    let saved = 0;
    for (const row of rows) {
        const tedSelect = row.querySelector('.teklif-tedarikci');
        const teslim = row.querySelector('.teklif-teslim').value;
        
        if (!tedSelect.value || !teslim) {
            showToast('Tedarik√ßi ve teslim s√ºresi zorunludur!', 'error');
            return;
        }
        
        const urunFiyatlari = [];
        let toplamFiyat = 0;
        const urunRows = row.querySelectorAll('.urun-fiyat-table tbody tr');
        
        for (const urunRow of urunRows) {
            const birimFiyat = parseFloat(urunRow.querySelector('.urun-birim-fiyat').value) || 0;
            const urunToplam = parseFloat(urunRow.querySelector('.urun-toplam').value) || 0;
            
            if (birimFiyat <= 0) {
                showToast('T√ºm √ºr√ºnler i√ßin birim fiyat girilmelidir!', 'error');
                return;
            }
            
            urunFiyatlari.push({
                urun_id: urunRow.dataset.urunId,
                miktar: parseFloat(urunRow.dataset.miktar),
                birim_fiyat: birimFiyat,
                toplam: urunToplam
            });
            toplamFiyat += urunToplam;
        }
        
        await apiCall('offers', 'POST', {
            license_code: currentUser.license_code,
            talep_id: parseInt(talepId),
            tedarikci_id: parseInt(tedSelect.value),
            tedarikci_adi: tedSelect.options[tedSelect.selectedIndex].dataset.adi,
            urun_fiyatlari: JSON.stringify(urunFiyatlari),
            toplam_fiyat: toplamFiyat,
            odeme_vadesi: row.querySelector('.teklif-vade').value || null,
            teslim_suresi: teslim,
            notlar: row.querySelector('.teklif-aciklama').value
        });
        saved++;
    }
    
    showToast(`${saved} teklif kaydedildi`);
    navigateTo('teklif-mukayese');
}

function renderTeklifMukayese() {
    const content = document.getElementById('mainContent');
    
    const onayliTalepIds = new Set(appData.offers.filter(o => o.onaylandi === 1).map(o => o.talep_id));
    
    const bekleyenTalepGruplari = {};
    const onaylanmisTalepGruplari = {};
    
    appData.offers.forEach(t => {
        const talepId = t.talep_id;
        if (onayliTalepIds.has(talepId)) {
            if (!onaylanmisTalepGruplari[talepId]) onaylanmisTalepGruplari[talepId] = [];
            onaylanmisTalepGruplari[talepId].push(t);
        } else {
            if (!bekleyenTalepGruplari[talepId]) bekleyenTalepGruplari[talepId] = [];
            bekleyenTalepGruplari[talepId].push(t);
        }
    });
    
    let html = `
        <div class="page-header">
            <h2>üìä Teklif Mukayese</h2>
            <p>Teklifleri kar≈üƒ±la≈ütƒ±rƒ±n ve tedarik√ßi onayƒ± verin</p>
        </div>
    `;
    
    for (const [talepId, teklifler] of Object.entries(bekleyenTalepGruplari)) {
        const talep = appData.requests.find(t => t.id == talepId);
        if (!talep) continue;
        
        const minFiyat = Math.min(...teklifler.map(t => parseFloat(t.toplam_fiyat || 0)));
        
        html += `
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0;">Talep: ${talep.talep_no}</h3>
                    <button class="btn btn-info btn-sm" onclick="showMukayeseTablosu(${talepId})">üìä Detaylƒ± Mukayese</button>
                </div>
                <p style="font-size:13px; color:#7f8c8d; margin-bottom:10px;">Talep Eden: ${talep.talep_eden || '-'} | √úr√ºn Sayƒ±sƒ±: ${(talep.items || []).length}</p>
                <table>
                    <thead><tr><th>Se√ß</th><th>Tedarik√ßi</th><th>√úr√ºn Sayƒ±sƒ±</th><th>Genel Toplam</th><th>√ñdeme Vadesi</th><th>Teslim S√ºresi</th><th>Detay</th></tr></thead>
                    <tbody>
                        ${teklifler.map(t => {
                            const enUcuz = parseFloat(t.toplam_fiyat || 0) === minFiyat;
                            const urunFiyatlari = t.urun_fiyatlari ? JSON.parse(t.urun_fiyatlari) : [];
                            return `
                            <tr ${enUcuz ? 'style="background:#e8f5e9;"' : ''}>
                                <td><input type="radio" name="teklif-${talepId}" value="${t.id}" class="teklif-secim"></td>
                                <td>${t.tedarikci_adi} ${enUcuz ? '<span style="color:#27ae60;">üèÜ En Uygun</span>' : ''}</td>
                                <td>${urunFiyatlari.length} √ºr√ºn</td>
                                <td><strong>‚Ç∫${parseFloat(t.toplam_fiyat || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</strong></td>
                                <td>${t.odeme_vadesi || '-'} g√ºn</td>
                                <td>${t.teslim_suresi || '-'} g√ºn</td>
                                <td><button class="action-btn" onclick="showTeklifDetay(${t.id})">üëÅ</button></td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
                <div style="margin-top:15px;">
                    <button class="btn btn-success" onclick="onaylaTeklif(${talepId})">‚úÖ Se√ßili Tedarik√ßiyi Onayla</button>
                </div>
            </div>
        `;
    }
    
    if (Object.keys(bekleyenTalepGruplari).length === 0 && Object.keys(onaylanmisTalepGruplari).length === 0) {
        html += '<div class="card"><div class="empty-state">Onay bekleyen teklif yok</div></div>';
    }
    
    if (Object.keys(onaylanmisTalepGruplari).length > 0) {
        html += `<h3 style="margin:20px 0 10px; color:#27ae60;">‚úÖ Onaylanmƒ±≈ü Talepler</h3>`;
        
        for (const [talepId, teklifler] of Object.entries(onaylanmisTalepGruplari)) {
            const talep = appData.requests.find(t => t.id == talepId);
            if (!talep) continue;
            
            const onayliTeklif = teklifler.find(t => t.onaylandi === 1);
            
            html += `
                <div class="card" style="border-left:4px solid #27ae60;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="margin:0;">Talep: ${talep.talep_no} <span style="color:#27ae60; font-size:14px;">‚úì ONAYLANDI</span></h3>
                        <button class="btn btn-info btn-sm" onclick="showMukayeseTablosu(${talepId})">üìä Detay G√∂r√ºnt√ºle</button>
                    </div>
                    <p style="font-size:13px; color:#7f8c8d; margin-bottom:10px;">
                        Onaylanan Tedarik√ßi: <strong style="color:#27ae60;">${onayliTeklif ? onayliTeklif.tedarikci_adi : '-'}</strong> | 
                        Toplam: <strong>‚Ç∫${onayliTeklif ? parseFloat(onayliTeklif.toplam_fiyat || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2}) : '0,00'}</strong>
                    </p>
                    <table>
                        <thead><tr><th>Durum</th><th>Tedarik√ßi</th><th>Genel Toplam</th><th>√ñdeme Vadesi</th><th>Teslim S√ºresi</th><th>Detay</th></tr></thead>
                        <tbody>
                            ${teklifler.map(t => {
                                const urunFiyatlari = t.urun_fiyatlari ? JSON.parse(t.urun_fiyatlari) : [];
                                return `
                                <tr ${t.onaylandi === 1 ? 'style="background:#e8f5e9;"' : 'style="opacity:0.6;"'}>
                                    <td>${t.onaylandi === 1 ? '<span style="color:#27ae60;">‚úì Onaylƒ±</span>' : '<span style="color:#999;">Reddedildi</span>'}</td>
                                    <td>${t.tedarikci_adi}</td>
                                    <td><strong>‚Ç∫${parseFloat(t.toplam_fiyat || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</strong></td>
                                    <td>${t.odeme_vadesi || '-'} g√ºn</td>
                                    <td>${t.teslim_suresi || '-'} g√ºn</td>
                                    <td><button class="action-btn" onclick="showTeklifDetay(${t.id})">üëÅ</button></td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
    }
    
    content.innerHTML = html;
}

function showMukayeseTablosu(talepId) {
    const teklifler = appData.offers.filter(o => o.talep_id == talepId);
    const talep = appData.requests.find(t => t.id == talepId);
    if (!talep || teklifler.length === 0) return;
    
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    
    let urunKarsilastirmaHTML = '';
    if (talep.items && talep.items.length > 0) {
        urunKarsilastirmaHTML = `
            <h4 style="margin:20px 0 10px;">√úr√ºn Bazlƒ± Fiyat Kar≈üƒ±la≈ütƒ±rmasƒ±</h4>
            <div style="overflow-x:auto;">
            <table style="width:100%; font-size:13px;">
                <thead>
                    <tr style="background:#667eea; color:#fff;">
                        <th style="padding:10px;">√úr√ºn</th>
                        <th style="padding:10px;">Miktar</th>
                        ${teklifler.map(t => `<th style="padding:10px;">${t.tedarikci_adi}<br><small>Birim / Toplam</small></th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${talep.items.map(item => {
                        const fiyatlar = teklifler.map(t => {
                            const urunFiyatlari = t.urun_fiyatlari ? JSON.parse(t.urun_fiyatlari) : [];
                            const urunFiyat = urunFiyatlari.find(u => u.urun_id == item.urun_id);
                            return urunFiyat ? { birim: urunFiyat.birim_fiyat, toplam: urunFiyat.toplam } : { birim: 0, toplam: 0 };
                        });
                        const minBirim = Math.min(...fiyatlar.filter(f => f.birim > 0).map(f => f.birim));
                        
                        return `
                        <tr>
                            <td style="padding:8px;"><strong>${item.urun_kodu}</strong> - ${item.urun_adi}</td>
                            <td style="padding:8px; text-align:center;">${item.miktar} ${item.birim}</td>
                            ${fiyatlar.map((f, idx) => {
                                const enUcuz = f.birim > 0 && f.birim === minBirim;
                                return `<td style="padding:8px; text-align:center; ${enUcuz ? 'background:#e8f5e9;' : ''}">
                                    <div>‚Ç∫${f.birim.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</div>
                                    <div style="font-weight:bold; color:#667eea;">‚Ç∫${f.toplam.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</div>
                                    ${enUcuz ? '<span style="color:#27ae60; font-size:11px;">üèÜ En Ucuz</span>' : ''}
                                </td>`;
                            }).join('')}
                        </tr>`;
                    }).join('')}
                </tbody>
                <tfoot>
                    <tr style="background:#f8f9fa; font-weight:bold;">
                        <td colspan="2" style="padding:10px; text-align:right;">GENEL TOPLAM:</td>
                        ${teklifler.map(t => {
                            const minToplam = Math.min(...teklifler.map(tk => parseFloat(tk.toplam_fiyat || 0)));
                            const enUcuz = parseFloat(t.toplam_fiyat || 0) === minToplam;
                            return `<td style="padding:10px; text-align:center; ${enUcuz ? 'background:#d4edda;' : ''}">
                                <strong>‚Ç∫${parseFloat(t.toplam_fiyat || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</strong>
                                ${enUcuz ? '<br><span style="color:#27ae60;">üèÜ</span>' : ''}
                            </td>`;
                        }).join('')}
                    </tr>
                </tfoot>
            </table>
            </div>
        `;
    }
    
    modalContent.innerHTML = `
        <div class="modal-header">
            <h3>üìä Teklif Mukayese Tablosu - ${talep.talep_no}</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <h4 style="margin-bottom:10px;">Genel Bilgiler</h4>
            <table style="width:100%;">
                <thead>
                    <tr style="background:#667eea; color:#fff;">
                        <th>Kriter</th>
                        ${teklifler.map(t => `<th>${t.tedarikci_adi}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    <tr><td><strong>Genel Toplam</strong></td>${teklifler.map(t => `<td><strong>‚Ç∫${parseFloat(t.toplam_fiyat || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</strong></td>`).join('')}</tr>
                    <tr><td><strong>√ñdeme Vadesi</strong></td>${teklifler.map(t => `<td>${t.odeme_vadesi || '-'} g√ºn</td>`).join('')}</tr>
                    <tr><td><strong>Teslim S√ºresi</strong></td>${teklifler.map(t => `<td>${t.teslim_suresi || '-'} g√ºn</td>`).join('')}</tr>
                    <tr><td><strong>Notlar</strong></td>${teklifler.map(t => `<td>${t.notlar || '-'}</td>`).join('')}</tr>
                </tbody>
            </table>
            
            ${urunKarsilastirmaHTML}
        </div>
    `;
    modal.classList.add('show');
}

async function onaylaTeklif(talepId) {
    const selected = document.querySelector(`input[name="teklif-${talepId}"]:checked`);
    if (!selected) {
        showToast('L√ºtfen bir tedarik√ßi se√ßin!', 'error');
        return;
    }
    
    const teklifId = parseInt(selected.value);
    await apiCall(`offers/${teklifId}/approve`, 'PUT', { license_code: currentUser.license_code });
    showToast('Tedarik√ßi onaylandƒ±! ≈ûimdi Sipari≈ü Ver sayfasƒ±ndan sipari≈ü olu≈üturabilirsiniz.');
    navigateTo('siparis-ver');
}

function renderSiparisVer() {
    const onayliTeklifler = appData.offers.filter(o => o.onaylandi === 1);
    const content = document.getElementById('mainContent');
    
    content.innerHTML = `
        <div class="page-header">
            <h2>üõí Sipari≈ü Ver</h2>
            <p>Onaylanan tekliflerden sipari≈ü olu≈üturun</p>
        </div>
        <div class="card">
            <h3>Onaylƒ± Teklifler (${onayliTeklifler.length})</h3>
            ${onayliTeklifler.length === 0 ? '<div class="empty-state">Onaylanmƒ±≈ü teklif yok. √ñnce Teklif Mukayese sayfasƒ±ndan tedarik√ßi onayƒ± verin.</div>' : `
            <table>
                <thead><tr><th>Talep No</th><th>Tedarik√ßi</th><th>Toplam Fiyat</th><th>Teslim</th><th>ƒ∞≈ülem</th></tr></thead>
                <tbody>
                    ${onayliTeklifler.map(t => {
                        const talep = appData.requests.find(r => r.id === t.talep_id);
                        const existingOrder = appData.orders.find(o => o.talep_id === t.talep_id);
                        return `
                        <tr>
                            <td><strong>${talep?.talep_no || '-'}</strong></td>
                            <td>${t.tedarikci_adi}</td>
                            <td>‚Ç∫${parseFloat(t.toplam_fiyat || 0).toLocaleString('tr-TR')}</td>
                            <td>${t.teslim_suresi || '-'} g√ºn</td>
                            <td>
                                ${existingOrder ? '<span class="badge badge-success">Sipari≈ü Verildi</span>' : 
                                `<button class="action-btn success" onclick="showSiparisOlusturModal(${t.id})">Sipari≈ü Olu≈ütur</button>`}
                            </td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>`}
        </div>
    `;
}

function showSiparisOlusturModal(teklifId) {
    const teklif = appData.offers.find(o => o.id === teklifId);
    if (!teklif) return;
    
    const talep = appData.requests.find(t => t.id === teklif.talep_id);
    const urunFiyatlari = teklif.urun_fiyatlari ? JSON.parse(teklif.urun_fiyatlari) : [];
    
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    
    modalContent.innerHTML = `
        <div class="modal-header">
            <h3>üõí Sipari≈ü Olu≈ütur</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div id="siparisDetayContent">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px; background:#f8f9fa; padding:15px; border-radius:8px;">
                    <div><strong>Talep No:</strong> ${talep?.talep_no || '-'}</div>
                    <div><strong>Tedarik√ßi:</strong> ${teklif.tedarikci_adi}</div>
                    <div><strong>√ñdeme Vadesi:</strong> ${teklif.odeme_vadesi || '-'} g√ºn</div>
                    <div><strong>Teslim S√ºresi:</strong> ${teklif.teslim_suresi || '-'} g√ºn</div>
                </div>
                
                <h4 style="margin:15px 0 10px;">Sipari≈ü Edilecek √úr√ºnler</h4>
                <table style="width:100%; font-size:13px;" id="siparisUrunlerTable">
                    <thead>
                        <tr style="background:#667eea; color:#fff;">
                            <th style="padding:10px;">√úr√ºn Kodu</th>
                            <th style="padding:10px;">√úr√ºn Adƒ±</th>
                            <th style="padding:10px; text-align:center;">Miktar</th>
                            <th style="padding:10px;">Birim</th>
                            <th style="padding:10px; text-align:right;">Birim Fiyat</th>
                            <th style="padding:10px; text-align:right;">Toplam</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${urunFiyatlari.map(u => {
                            const urun = appData.products.find(p => p.id == u.urun_id);
                            const talepItem = talep?.items?.find(i => i.urun_id == u.urun_id);
                            return `
                            <tr>
                                <td style="padding:8px;"><strong>${urun?.urun_kodu || talepItem?.urun_kodu || '-'}</strong></td>
                                <td style="padding:8px;">${urun?.urun_adi || talepItem?.urun_adi || '-'}</td>
                                <td style="padding:8px; text-align:center;">${u.miktar}</td>
                                <td style="padding:8px;">${urun?.birim || talepItem?.birim || '-'}</td>
                                <td style="padding:8px; text-align:right;">‚Ç∫${parseFloat(u.birim_fiyat).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                                <td style="padding:8px; text-align:right; font-weight:bold;">‚Ç∫${parseFloat(u.toplam).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                    <tfoot>
                        <tr style="background:#e8f4e8; font-weight:bold;">
                            <td colspan="5" style="padding:10px; text-align:right;">GENEL TOPLAM:</td>
                            <td style="padding:10px; text-align:right;">‚Ç∫${parseFloat(teklif.toplam_fiyat || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        </tr>
                    </tfoot>
                </table>
                
                ${teklif.notlar ? `<div style="margin-top:15px; padding:10px; background:#fff3cd; border-radius:4px;"><strong>Teklif Notlarƒ±:</strong> ${teklif.notlar}</div>` : ''}
            </div>
            
            <hr style="margin:20px 0;">
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Teslim Tarihi *</label>
                    <input type="date" id="siparisTeslimTarihi" required>
                </div>
            </div>
            <div class="form-group">
                <label>Sipari≈ü A√ßƒ±klamasƒ±/Notlarƒ±</label>
                <textarea id="siparisAciklama" rows="3" placeholder="Sipari≈ü ile ilgili notlarƒ±nƒ±z..."></textarea>
            </div>
            
            <div style="display:flex; gap:10px; margin-top:20px; flex-wrap:wrap;">
                <button class="btn btn-success" onclick="createOrderFromApprovedOffer(${teklifId})" style="padding:12px 24px;">
                    üõí Sipari≈ü Ver
                </button>
                <button class="btn btn-info" onclick="printSiparisDetay()" style="padding:12px 24px;">
                    üñ®Ô∏è Yazdƒ±r
                </button>
                <button class="btn" onclick="printSiparisDetay()" style="padding:12px 24px;">
                    üìÑ PDF ƒ∞ndir
                </button>
            </div>
        </div>
    `;
    modal.classList.add('show');
}

async function createOrderFromApprovedOffer(teklifId) {
    const teklif = appData.offers.find(o => o.id === teklifId);
    if (!teklif) return;
    
    const talep = appData.requests.find(t => t.id === teklif.talep_id);
    if (!talep) return;
    
    const teslimTarihi = document.getElementById('siparisTeslimTarihi').value;
    if (!teslimTarihi) {
        showToast('Teslim tarihi zorunludur!', 'error');
        return;
    }
    
    const items = (talep.items || []).map(i => ({
        urun_id: i.urun_id,
        urun_kodu: i.urun_kodu,
        urun_adi: i.urun_adi,
        miktar: i.miktar,
        birim: i.birim
    }));
    
    const res = await apiCall('orders', 'POST', {
        license_code: currentUser.license_code,
        talep_id: talep.id,
        talep_no: talep.talep_no,
        tedarikci_id: teklif.tedarikci_id,
        tedarikci_adi: teklif.tedarikci_adi,
        siparis_urunleri: items,
        genel_toplam: teklif.toplam_fiyat,
        teslim_tarihi: teslimTarihi,
        aciklama: document.getElementById('siparisAciklama').value,
        user_id: currentUser.id,
        user_email: currentUser.email
    });
    
    if (res.success) {
        closeModal();
        showToast('Sipari≈ü olu≈üturuldu: ' + res.siparis_no);
        navigateTo('siparisler');
    }
}

function printContent(title, content) {
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>${title}</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                th { background: #667eea; color: white; }
                h1, h2 { color: #333; }
                .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #667eea; padding-bottom: 20px; }
                .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
                .total-row { background: #e8f4e8; font-weight: bold; }
                @media print { body { print-color-adjust: exact; -webkit-print-color-adjust: exact; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Proje ve Tedarik Y√∂netimi</h1>
                <p>Tarih: ${new Date().toLocaleDateString('tr-TR')}</p>
            </div>
            ${content}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

function printSiparisDetay() {
    const content = document.getElementById('siparisDetayContent');
    if (content) {
        printContent('Sipari≈ü Detayƒ±', content.innerHTML);
    }
}

function downloadSiparisPDF(teklifId) {
    const teklif = appData.offers.find(o => o.id === teklifId);
    if (!teklif) return;
    
    const talep = appData.requests.find(t => t.id === teklif.talep_id);
    const urunFiyatlari = teklif.urun_fiyatlari ? JSON.parse(teklif.urun_fiyatlari) : [];
    
    let tableRows = urunFiyatlari.map(u => {
        const urun = appData.products.find(p => p.id == u.urun_id);
        const talepItem = talep?.items?.find(i => i.urun_id == u.urun_id);
        return `<tr>
            <td>${urun?.urun_kodu || talepItem?.urun_kodu || '-'}</td>
            <td>${urun?.urun_adi || talepItem?.urun_adi || '-'}</td>
            <td style="text-align:center;">${u.miktar}</td>
            <td>${urun?.birim || talepItem?.birim || '-'}</td>
            <td style="text-align:right;">‚Ç∫${parseFloat(u.birim_fiyat).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
            <td style="text-align:right;">‚Ç∫${parseFloat(u.toplam).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
        </tr>`;
    }).join('');
    
    const content = `
        <h2>Sipari≈ü Detayƒ±</h2>
        <div class="info-grid">
            <p><strong>Talep No:</strong> ${talep?.talep_no || '-'}</p>
            <p><strong>Tedarik√ßi:</strong> ${teklif.tedarikci_adi}</p>
            <p><strong>√ñdeme Vadesi:</strong> ${teklif.odeme_vadesi || '-'} g√ºn</p>
            <p><strong>Teslim S√ºresi:</strong> ${teklif.teslim_suresi || '-'} g√ºn</p>
        </div>
        <table>
            <thead>
                <tr><th>√úr√ºn Kodu</th><th>√úr√ºn Adƒ±</th><th>Miktar</th><th>Birim</th><th>Birim Fiyat</th><th>Toplam</th></tr>
            </thead>
            <tbody>${tableRows}</tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="5" style="text-align:right;">GENEL TOPLAM:</td>
                    <td style="text-align:right;">‚Ç∫${parseFloat(teklif.toplam_fiyat || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                </tr>
            </tfoot>
        </table>
        ${teklif.notlar ? `<p><strong>Notlar:</strong> ${teklif.notlar}</p>` : ''}
    `;
    
    printContent('Sipari≈ü Detayƒ± - ' + (talep?.talep_no || ''), content);
    showToast('PDF indirmek i√ßin yazdƒ±rma ekranƒ±nda "PDF olarak kaydet" se√ßin', 'info');
}

function printTableAsPDF(title, tableId) {
    const table = document.getElementById(tableId);
    if (!table) {
        showToast('Tablo bulunamadƒ±!', 'error');
        return;
    }
    printContent(title, '<h2>' + title + '</h2>' + table.outerHTML);
}

function printListAsPDF(title, data, columns) {
    let tableHTML = '<table><thead><tr>';
    columns.forEach(col => { tableHTML += `<th>${col.header}</th>`; });
    tableHTML += '</tr></thead><tbody>';
    
    data.forEach(item => {
        tableHTML += '<tr>';
        columns.forEach(col => {
            let value = col.field.split('.').reduce((o, k) => o && o[k], item) || '-';
            if (col.format) value = col.format(value, item);
            tableHTML += `<td>${value}</td>`;
        });
        tableHTML += '</tr>';
    });
    tableHTML += '</tbody></table>';
    
    printContent(title, '<h2>' + title + '</h2>' + tableHTML);
}

function renderTeslimAl() {
    const teslimBekleyenSiparisler = appData.orders.filter(o => o.durum === 'Onaylandƒ±' || o.durum === 'Kƒ±smi Teslim');
    const content = document.getElementById('mainContent');
    
    content.innerHTML = `
        <div class="page-header">
            <h2>‚úÖ Teslim Al</h2>
            <p>Sipari≈ü edilen √ºr√ºnleri teslim alƒ±n</p>
        </div>
        <div class="card">
            <h3>Teslim Bekleyen Sipari≈üler (${teslimBekleyenSiparisler.length})</h3>
            ${teslimBekleyenSiparisler.length === 0 ? '<div class="empty-state">Teslim bekleyen sipari≈ü yok</div>' : `
            <table>
                <thead><tr><th>Sipari≈ü No</th><th>Talep No</th><th>Tedarik√ßi</th><th>Toplam</th><th>Durum</th><th>ƒ∞≈ülem</th></tr></thead>
                <tbody>
                    ${teslimBekleyenSiparisler.map(s => `
                        <tr>
                            <td><strong>${s.siparis_no}</strong></td>
                            <td>${s.talep_no || '-'}</td>
                            <td>${s.tedarikci_adi}</td>
                            <td>‚Ç∫${parseFloat(s.genel_toplam || 0).toLocaleString('tr-TR')}</td>
                            <td><span class="badge badge-warning">${s.durum}</span></td>
                            <td><button class="action-btn success" onclick="showTeslimAlModal(${s.id})">Teslim Al</button></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>`}
        </div>
    `;
}

function showTeslimAlModal(siparisId) {
    const siparis = appData.orders.find(o => o.id === siparisId);
    if (!siparis) return;
    
    let urunler = [];
    try {
        urunler = typeof siparis.siparis_urunleri === 'string' ? JSON.parse(siparis.siparis_urunleri) : siparis.siparis_urunleri || [];
    } catch(e) { urunler = []; }
    
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    
    modalContent.innerHTML = `
        <div class="modal-header">
            <h3>‚úÖ Teslim Al - ${siparis.siparis_no}</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <p><strong>Tedarik√ßi:</strong> ${siparis.tedarikci_adi}</p>
            <h4 style="margin:15px 0 10px;">√úr√ºnleri Teslim Alƒ±n</h4>
            <table id="teslimUrunTable">
                <thead><tr><th>√úr√ºn</th><th>Sipari≈ü Miktarƒ±</th><th>Teslim Miktarƒ±</th><th>Birim</th></tr></thead>
                <tbody>
                    ${urunler.map((u, idx) => `
                        <tr data-urun-idx="${idx}">
                            <td><strong>${u.urun_kodu}</strong> - ${u.urun_adi}</td>
                            <td>${u.miktar}</td>
                            <td><input type="number" class="teslim-miktar" data-beklenen="${u.miktar}" 
                                style="width:80px; padding:6px; text-align:center;" step="0.01" min="0" value="${u.miktar}"></td>
                            <td>${u.birim}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div id="teslimUyari" style="display:none; margin-top:10px; padding:10px; border-radius:8px;"></div>
            <button class="btn btn-success" onclick="confirmTeslimAl(${siparisId})" style="width:100%; margin-top:15px;">
                ‚úÖ Teslim Al ve Stok G√ºncelle
            </button>
        </div>
    `;
    modal.classList.add('show');
}

async function confirmTeslimAl(siparisId) {
    const rows = document.querySelectorAll('#teslimUrunTable tbody tr');
    const siparis = appData.orders.find(o => o.id === siparisId);
    let urunler = [];
    try {
        urunler = typeof siparis.siparis_urunleri === 'string' ? JSON.parse(siparis.siparis_urunleri) : siparis.siparis_urunleri || [];
    } catch(e) { urunler = []; }
    
    const teslimler = [];
    let hasDiscrepancy = false;
    let discrepancyMsg = '';
    
    rows.forEach((row, idx) => {
        const beklenen = parseFloat(row.querySelector('.teslim-miktar').dataset.beklenen);
        const teslim = parseFloat(row.querySelector('.teslim-miktar').value) || 0;
        const urun = urunler[idx];
        
        if (teslim !== beklenen) {
            hasDiscrepancy = true;
            const fark = teslim - beklenen;
            discrepancyMsg += `${urun.urun_adi}: ${fark > 0 ? '+' + fark : fark} ${urun.birim} ${fark > 0 ? '(FAZLA)' : '(EKSƒ∞K)'}\n`;
        }
        
        teslimler.push({
            urun_id: urun.urun_id,
            urun_kodu: urun.urun_kodu,
            urun_adi: urun.urun_adi,
            beklenen_miktar: beklenen,
            teslim_miktar: teslim,
            birim: urun.birim
        });
    });
    
    if (hasDiscrepancy) {
        const uyariDiv = document.getElementById('teslimUyari');
        uyariDiv.style.display = 'block';
        uyariDiv.style.background = '#fff3cd';
        uyariDiv.style.border = '1px solid #ffc107';
        uyariDiv.innerHTML = `<strong>‚ö†Ô∏è Miktar Uyu≈ümazlƒ±ƒüƒ±:</strong><br><pre style="margin:5px 0;">${discrepancyMsg}</pre><p style="margin:5px 0;">Satƒ±nalma birimine bildirim g√∂nderilecek.</p>`;
    }
    
    const res = await apiCall(`orders/${siparisId}/teslim`, 'PUT', {
        license_code: currentUser.license_code,
        teslimler: teslimler,
        has_discrepancy: hasDiscrepancy,
        discrepancy_msg: discrepancyMsg
    });
    
    if (res.success) {
        closeModal();
        showToast('Teslim alƒ±ndƒ± ve stok g√ºncellendi!');
        navigateTo('stok-liste');
    }
}

function renderSatinalinaUrunler() {
    const content = document.getElementById('mainContent');
    
    let tumUrunler = [];
    let toplamTutar = 0;
    
    appData.invoices.forEach(f => {
        let urunler = [];
        try {
            urunler = typeof f.fatura_urunleri === 'string' ? JSON.parse(f.fatura_urunleri) : f.fatura_urunleri || [];
        } catch(e) { urunler = []; }
        
        urunler.forEach(u => {
            const birimFiyat = parseFloat(u.birim_fiyat) || 0;
            const miktar = parseFloat(u.miktar) || 0;
            const toplam = birimFiyat * miktar;
            toplamTutar += toplam;
            
            tumUrunler.push({
                fatura_no: f.fatura_no,
                fatura_tarihi: f.fatura_tarihi,
                siparis_no: f.siparis_no,
                tedarikci: f.tedarikci_adi,
                urun_kodu: u.urun_kodu,
                urun_adi: u.urun_adi,
                miktar: miktar,
                birim: u.birim,
                birim_fiyat: birimFiyat,
                toplam: toplam,
                kdv_orani: f.kdv_orani || 0
            });
        });
    });
    
    content.innerHTML = `
        <div class="page-header">
            <h2>üõçÔ∏è Satƒ±nalƒ±nan √úr√ºnler</h2>
            <p>Fatura giri≈ülerinden alƒ±nan t√ºm √ºr√ºnlerin detaylƒ± listesi</p>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
                <h3 style="margin:0;">Satƒ±nalƒ±nan √úr√ºnler (${tumUrunler.length})</h3>
                <div style="display:flex; gap:10px; align-items:center;">
                    <span style="font-weight:bold; color:#27ae60;">Toplam: ‚Ç∫${toplamTutar.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</span>
                    ${tumUrunler.length > 0 ? `
                        <button class="btn btn-warning btn-sm" onclick="exportSatinalinaUrunler()">üìä Excel ƒ∞ndir</button>
                        <button class="btn btn-info btn-sm" onclick="printSatinalinanUrunler()">üñ®Ô∏è Yazdƒ±r</button>
                        <button class="btn btn-sm" onclick="printSatinalinanUrunler()">üìÑ PDF</button>
                    ` : ''}
                </div>
            </div>
            ${tumUrunler.length === 0 ? '<div class="empty-state">Hen√ºz fatura giri≈üi yapƒ±lmadƒ±. Fatura giri≈üi yaptƒ±ktan sonra √ºr√ºnler burada g√∂r√ºnecektir.</div>' : `
            <div style="overflow-x:auto;">
            <table id="satinalinanUrunlerTable">
                <thead><tr><th>Fatura No</th><th>Fatura Tarihi</th><th>Sipari≈ü No</th><th>Tedarik√ßi</th><th>√úr√ºn Kodu</th><th>√úr√ºn Adƒ±</th><th>Miktar</th><th>Birim</th><th>Birim Fiyat</th><th>Toplam</th><th>KDV</th></tr></thead>
                <tbody>
                    ${tumUrunler.map(u => `
                        <tr>
                            <td><strong>${u.fatura_no}</strong></td>
                            <td>${u.fatura_tarihi ? new Date(u.fatura_tarihi).toLocaleDateString('tr-TR') : '-'}</td>
                            <td>${u.siparis_no || '-'}</td>
                            <td>${u.tedarikci}</td>
                            <td>${u.urun_kodu}</td>
                            <td>${u.urun_adi}</td>
                            <td>${u.miktar}</td>
                            <td>${u.birim}</td>
                            <td>‚Ç∫${u.birim_fiyat.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                            <td><strong>‚Ç∫${u.toplam.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</strong></td>
                            <td>%${u.kdv_orani}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            </div>`}
        </div>
    `;
}

function printSatinalinanUrunler() {
    let tumUrunler = [];
    let toplamTutar = 0;
    
    appData.invoices.forEach(f => {
        let urunler = [];
        try {
            urunler = typeof f.fatura_urunleri === 'string' ? JSON.parse(f.fatura_urunleri) : f.fatura_urunleri || [];
        } catch(e) { urunler = []; }
        
        urunler.forEach(u => {
            const birimFiyat = parseFloat(u.birim_fiyat) || 0;
            const miktar = parseFloat(u.miktar) || 0;
            const toplam = birimFiyat * miktar;
            toplamTutar += toplam;
            
            tumUrunler.push({
                fatura_no: f.fatura_no,
                fatura_tarihi: f.fatura_tarihi,
                siparis_no: f.siparis_no || '-',
                tedarikci: f.tedarikci_adi,
                urun_kodu: u.urun_kodu,
                urun_adi: u.urun_adi,
                miktar: miktar,
                birim: u.birim,
                birim_fiyat: birimFiyat,
                toplam: toplam,
                kdv_orani: f.kdv_orani || 0
            });
        });
    });
    
    printListAsPDF('Satƒ±nalƒ±nan √úr√ºnler', tumUrunler, [
        { header: 'Fatura No', field: 'fatura_no' },
        { header: 'Fatura Tarihi', field: 'fatura_tarihi', format: (v) => v ? new Date(v).toLocaleDateString('tr-TR') : '-' },
        { header: 'Sipari≈ü No', field: 'siparis_no' },
        { header: 'Tedarik√ßi', field: 'tedarikci' },
        { header: '√úr√ºn Kodu', field: 'urun_kodu' },
        { header: '√úr√ºn Adƒ±', field: 'urun_adi' },
        { header: 'Miktar', field: 'miktar' },
        { header: 'Birim', field: 'birim' },
        { header: 'Birim Fiyat', field: 'birim_fiyat', format: (v) => '‚Ç∫' + parseFloat(v).toLocaleString('tr-TR', {minimumFractionDigits: 2}) },
        { header: 'Toplam', field: 'toplam', format: (v) => '‚Ç∫' + parseFloat(v).toLocaleString('tr-TR', {minimumFractionDigits: 2}) },
        { header: 'KDV', field: 'kdv_orani', format: (v) => '%' + v }
    ]);
}

function exportSatinalinaUrunler() {
    let csv = 'fatura_no,fatura_tarihi,siparis_no,tedarikci,urun_kodu,urun_adi,miktar,birim,birim_fiyat,toplam,kdv_orani\n';
    
    appData.invoices.forEach(f => {
        let urunler = [];
        try {
            urunler = typeof f.fatura_urunleri === 'string' ? JSON.parse(f.fatura_urunleri) : f.fatura_urunleri || [];
        } catch(e) { urunler = []; }
        
        urunler.forEach(u => {
            const birimFiyat = parseFloat(u.birim_fiyat) || 0;
            const miktar = parseFloat(u.miktar) || 0;
            const toplam = birimFiyat * miktar;
            csv += `${f.fatura_no},${f.fatura_tarihi || ''},${f.siparis_no || ''},${f.tedarikci_adi},${u.urun_kodu},${u.urun_adi},${miktar},${u.birim},${birimFiyat},${toplam},${f.kdv_orani || 0}\n`;
        });
    });
    
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `satinalina_urunler_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
    showToast('Excel indirildi');
}

function renderSiparisler() {
    const content = document.getElementById('mainContent');
    content.innerHTML = `
        <div class="page-header">
            <h2>üì¶ Sipari≈üler</h2>
            <p>T√ºm sipari≈üleri g√∂r√ºnt√ºleyin</p>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Sipari≈ü Listesi (${appData.orders.length})</h3>
                <div>
                    <button class="btn btn-info btn-sm" onclick="printSiparisler()">üñ®Ô∏è Yazdƒ±r</button>
                    <button class="btn btn-sm" onclick="printSiparisler()">üìÑ PDF</button>
                </div>
            </div>
            ${appData.orders.length === 0 ? '<div class="empty-state">Hen√ºz sipari≈ü yok</div>' : `
            <table id="siparislerTable">
                <thead><tr><th>Sipari≈ü No</th><th>Talep No</th><th>Tedarik√ßi</th><th>Toplam</th><th>Teslim Tarihi</th><th>Durum</th><th>ƒ∞≈ülem</th></tr></thead>
                <tbody>
                    ${appData.orders.map(s => `
                        <tr>
                            <td><strong>${s.siparis_no}</strong></td>
                            <td>${s.talep_no || '-'}</td>
                            <td>${s.tedarikci_adi}</td>
                            <td>‚Ç∫${parseFloat(s.genel_toplam || 0).toLocaleString('tr-TR')}</td>
                            <td>${s.teslim_tarihi ? new Date(s.teslim_tarihi).toLocaleDateString('tr-TR') : '-'}</td>
                            <td>
                                ${s.durum === 'Teslim Alƒ±ndƒ±' 
                                    ? `<button class="badge badge-success" style="cursor:pointer; border:none;" onclick="showTeslimDetayModal(${s.id})">${s.durum} üëÅ</button>`
                                    : `<span class="badge badge-${s.durum === 'Onaylandƒ±' ? 'success' : s.durum === 'ƒ∞ptal' ? 'danger' : 'warning'}">${s.durum}</span>`
                                }
                            </td>
                            <td>
                                <button class="action-btn" onclick="showSiparisDetayModal(${s.id})">üëÅ Detay</button>
                                ${s.durum === 'Beklemede' ? `
                                    <button class="action-btn success" onclick="updateOrderStatus(${s.id}, 'Onaylandƒ±')">Onayla</button>
                                    <button class="action-btn danger" onclick="updateOrderStatus(${s.id}, 'ƒ∞ptal')">ƒ∞ptal</button>
                                ` : ''}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>`}
        </div>
    `;
}

function printSiparisler() {
    printListAsPDF('Sipari≈ü Listesi', appData.orders, [
        { header: 'Sipari≈ü No', field: 'siparis_no' },
        { header: 'Talep No', field: 'talep_no' },
        { header: 'Tedarik√ßi', field: 'tedarikci_adi' },
        { header: 'Toplam', field: 'genel_toplam', format: (v) => '‚Ç∫' + parseFloat(v || 0).toLocaleString('tr-TR') },
        { header: 'Durum', field: 'durum' }
    ]);
}

function showSiparisDetayModal(siparisId) {
    const siparis = appData.orders.find(o => o.id === siparisId);
    if (!siparis) return;
    
    let urunler = [];
    try {
        urunler = typeof siparis.siparis_urunleri === 'string' ? JSON.parse(siparis.siparis_urunleri) : siparis.siparis_urunleri || [];
    } catch(e) { urunler = []; }
    
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    
    modalContent.innerHTML = `
        <div class="modal-header">
            <h3>üì¶ Sipari≈ü Detayƒ± - ${siparis.siparis_no}</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body" id="siparisDetayPrint">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px; background:#f8f9fa; padding:15px; border-radius:8px;">
                <div><strong>Sipari≈ü No:</strong> ${siparis.siparis_no}</div>
                <div><strong>Talep No:</strong> ${siparis.talep_no || '-'}</div>
                <div><strong>Tedarik√ßi:</strong> ${siparis.tedarikci_adi}</div>
                <div><strong>Durum:</strong> ${siparis.durum}</div>
                <div><strong>Teslim Tarihi:</strong> ${siparis.teslim_tarihi ? new Date(siparis.teslim_tarihi).toLocaleDateString('tr-TR') : '-'}</div>
                <div><strong>Toplam:</strong> ‚Ç∫${parseFloat(siparis.genel_toplam || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</div>
            </div>
            
            <h4 style="margin:15px 0 10px;">Sipari≈ü √úr√ºnleri</h4>
            <table>
                <thead>
                    <tr style="background:#667eea; color:#fff;">
                        <th>√úr√ºn Kodu</th><th>√úr√ºn Adƒ±</th><th>Miktar</th><th>Birim</th>
                    </tr>
                </thead>
                <tbody>
                    ${urunler.map(u => `
                        <tr>
                            <td><strong>${u.urun_kodu}</strong></td>
                            <td>${u.urun_adi}</td>
                            <td>${u.miktar}</td>
                            <td>${u.birim}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            
            ${siparis.aciklama ? `<div style="margin-top:15px; padding:10px; background:#fff3cd; border-radius:4px;"><strong>A√ßƒ±klama:</strong> ${siparis.aciklama}</div>` : ''}
        </div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn btn-info" onclick="printContent('Sipari≈ü Detayƒ± - ${siparis.siparis_no}', document.getElementById('siparisDetayPrint').innerHTML)">üñ®Ô∏è Yazdƒ±r</button>
            <button class="btn" onclick="printContent('Sipari≈ü Detayƒ± - ${siparis.siparis_no}', document.getElementById('siparisDetayPrint').innerHTML)">üìÑ PDF ƒ∞ndir</button>
        </div>
    `;
    modal.classList.add('show');
}

function showTeslimDetayModal(siparisId) {
    const siparis = appData.orders.find(o => o.id === siparisId);
    if (!siparis) return;
    
    let urunler = [];
    try {
        urunler = typeof siparis.siparis_urunleri === 'string' ? JSON.parse(siparis.siparis_urunleri) : siparis.siparis_urunleri || [];
    } catch(e) { urunler = []; }
    
    let teslimlerArray = [];
    try {
        const parsed = siparis.teslim_miktarlari ? (typeof siparis.teslim_miktarlari === 'string' ? JSON.parse(siparis.teslim_miktarlari) : siparis.teslim_miktarlari) : [];
        teslimlerArray = Array.isArray(parsed) ? parsed : [];
    } catch(e) { teslimlerArray = []; }
    
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    
    modalContent.innerHTML = `
        <div class="modal-header">
            <h3>‚úÖ Teslim Detayƒ± - ${siparis.siparis_no}</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body" id="teslimDetayPrint">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px; background:#d4edda; padding:15px; border-radius:8px;">
                <div><strong>Sipari≈ü No:</strong> ${siparis.siparis_no}</div>
                <div><strong>Tedarik√ßi:</strong> ${siparis.tedarikci_adi}</div>
                <div><strong>Teslim Durumu:</strong> ${siparis.teslim_durumu || 'Teslim Alƒ±ndƒ±'}</div>
                <div><strong>Teslim Tarihi:</strong> ${siparis.teslim_tarihi ? new Date(siparis.teslim_tarihi).toLocaleDateString('tr-TR') : '-'}</div>
            </div>
            
            <h4 style="margin:15px 0 10px;">Teslim Alƒ±nan √úr√ºnler</h4>
            <table>
                <thead>
                    <tr style="background:#27ae60; color:#fff;">
                        <th>√úr√ºn Kodu</th><th>√úr√ºn Adƒ±</th><th>Sipari≈ü Miktarƒ±</th><th>Teslim Alƒ±nan</th><th>Birim</th><th>Durum</th>
                    </tr>
                </thead>
                <tbody>
                    ${urunler.map((u, idx) => {
                        const teslimData = teslimlerArray[idx] || {};
                        const siparisM = parseFloat(teslimData.beklenen_miktar || u.miktar);
                        const teslimM = parseFloat(teslimData.teslim_miktar !== undefined ? teslimData.teslim_miktar : u.miktar);
                        const fark = teslimM - siparisM;
                        let durumBadge = '<span class="badge badge-success">Tam</span>';
                        if (fark < 0) durumBadge = '<span class="badge badge-warning">Eksik (' + Math.abs(fark) + ')</span>';
                        if (fark > 0) durumBadge = '<span class="badge badge-info">Fazla (+' + fark + ')</span>';
                        return `
                        <tr>
                            <td><strong>${teslimData.urun_kodu || u.urun_kodu || '-'}</strong></td>
                            <td>${teslimData.urun_adi || u.urun_adi || '-'}</td>
                            <td>${siparisM}</td>
                            <td><strong>${teslimM}</strong></td>
                            <td>${teslimData.birim || u.birim || '-'}</td>
                            <td>${durumBadge}</td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>
            
            ${siparis.teslim_uyumsuzluk ? `<div style="margin-top:15px; padding:10px; background:#fff3cd; border-radius:4px;"><strong>Uyumsuzluk Notu:</strong><pre style="margin:5px 0; white-space:pre-wrap;">${siparis.teslim_uyumsuzluk}</pre></div>` : ''}
        </div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn btn-info" onclick="printContent('Teslim Detayƒ± - ${siparis.siparis_no}', document.getElementById('teslimDetayPrint').innerHTML)">üñ®Ô∏è Yazdƒ±r</button>
            <button class="btn" onclick="printContent('Teslim Detayƒ± - ${siparis.siparis_no}', document.getElementById('teslimDetayPrint').innerHTML)">üìÑ PDF ƒ∞ndir</button>
        </div>
    `;
    modal.classList.add('show');
}

async function updateOrderStatus(id, durum) {
    await apiCall(`orders/${id}`, 'PUT', { durum });
    showToast(`Sipari≈ü ${durum.toLowerCase()}`);
    navigateTo('siparisler');
}

let faturaUrunleri = [];
let faturaKdvOrani = 20;

function renderFatura() {
    faturaUrunleri = [];
    faturaKdvOrani = 20;
    const content = document.getElementById('mainContent');
    content.innerHTML = `
        <div class="page-header">
            <h2>üßæ Fatura Giri≈üi</h2>
            <p>Tedarik√ßilerden gelen faturalarƒ± kaydedin</p>
        </div>
        <div class="card">
            <h3>Yeni Fatura Giri≈üi</h3>
            <form id="faturaForm">
                <div class="form-grid">
                    <div class="form-group"><label>Sipari≈ü *</label>
                        <select id="faturaSiparis" required onchange="updateFaturaDetay()">
                            <option value="">Sipari≈ü Se√ßin...</option>
                            ${appData.orders.map(s => `<option value="${s.id}" data-no="${s.siparis_no}" data-ted="${s.tedarikci_adi}" data-tutar="${s.genel_toplam}">${s.siparis_no} - ${s.tedarikci_adi}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group"><label>Tedarik√ßi</label>
                        <input type="text" id="faturaTedarikci" readonly style="background:#f0f0f0;">
                    </div>
                    <div class="form-group"><label>Fatura No *</label><input type="text" id="faturaNo" required placeholder="Tedarik√ßi fatura numarasƒ±"></div>
                    <div class="form-group"><label>Fatura Tarihi *</label><input type="date" id="faturaTarihi" required></div>
                </div>
                
                <div style="margin:20px 0; padding:15px; background:#f8f9fa; border-radius:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h4 style="margin:0;">üì¶ Fatura √úr√ºnleri</h4>
                        <button type="button" class="btn btn-info btn-sm" onclick="showFaturaUrunSecModal()">‚ûï √úr√ºn Ekle</button>
                    </div>
                    <div id="faturaUrunListesi">
                        <div class="empty-state" style="padding:20px;">Hen√ºz √ºr√ºn eklenmedi. √úr√ºn eklemek i√ßin yukarƒ±daki butonu kullanƒ±n.</div>
                    </div>
                </div>
                
                <div style="margin:20px 0;">
                    <label style="font-weight:bold; display:block; margin-bottom:10px;">KDV Oranƒ±</label>
                    <div style="display:flex; gap:10px;">
                        <button type="button" class="kdv-btn ${faturaKdvOrani === 0 ? 'active' : ''}" onclick="setFaturaKdv(0)">%0</button>
                        <button type="button" class="kdv-btn ${faturaKdvOrani === 10 ? 'active' : ''}" onclick="setFaturaKdv(10)">%10</button>
                        <button type="button" class="kdv-btn ${faturaKdvOrani === 20 ? 'active' : ''}" onclick="setFaturaKdv(20)">%20</button>
                    </div>
                </div>
                
                <div style="background:#e8f4e8; padding:15px; border-radius:8px; margin:20px 0;">
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; text-align:center;">
                        <div>
                            <div style="font-size:12px; color:#666;">Matrah (KDV Hari√ß)</div>
                            <div id="faturaMatrah" style="font-size:20px; font-weight:bold;">‚Ç∫0,00</div>
                        </div>
                        <div>
                            <div style="font-size:12px; color:#666;">KDV Tutarƒ± (<span id="kdvOraniText">%20</span>)</div>
                            <div id="faturaKdvTutar" style="font-size:20px; font-weight:bold;">‚Ç∫0,00</div>
                        </div>
                        <div style="background:#27ae60; color:#fff; padding:10px; border-radius:4px;">
                            <div style="font-size:12px;">GENEL TOPLAM</div>
                            <div id="faturaGenelToplam" style="font-size:24px; font-weight:bold;">‚Ç∫0,00</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group"><label>Notlar / A√ßƒ±klama</label><textarea id="faturaNotlar" rows="2" placeholder="Fatura ile ilgili notlar..."></textarea></div>
                <button type="submit" class="btn">üíæ Faturayƒ± Kaydet</button>
            </form>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Fatura Listesi (${appData.invoices.length})</h3>
                <div>
                    ${appData.invoices.length > 0 ? `
                        <button class="btn btn-warning btn-sm" onclick="exportFaturalar()">üìä Excel ƒ∞ndir</button>
                        <button class="btn btn-info btn-sm" onclick="printFaturalar()">üñ®Ô∏è Yazdƒ±r</button>
                        <button class="btn btn-sm" onclick="printFaturalar()">üìÑ PDF</button>
                    ` : ''}
                </div>
            </div>
            ${appData.invoices.length === 0 ? '<div class="empty-state">Hen√ºz fatura giri≈üi yapƒ±lmadƒ±</div>' : `
            <table id="faturalarTable">
                <thead><tr><th>Fatura No</th><th>Sipari≈ü</th><th>Tedarik√ßi</th><th>Matrah</th><th>KDV (%)</th><th>KDV Tutarƒ±</th><th>Toplam</th><th>Tarih</th><th>ƒ∞≈ülem</th></tr></thead>
                <tbody>
                    ${appData.invoices.map(f => {
                        const kdvOrani = f.kdv_orani || 0;
                        let matrah = 0;
                        let kdvTutari = 0;
                        let toplam = parseFloat(f.fatura_tutari || 0);
                        
                        if (f.matrah && f.matrah > 0) {
                            matrah = parseFloat(f.matrah);
                            kdvTutari = parseFloat(f.kdv_tutari || 0);
                        } else {
                            matrah = toplam / (1 + kdvOrani / 100);
                            kdvTutari = toplam - matrah;
                        }
                        
                        return `
                        <tr>
                            <td><strong>${f.fatura_no}</strong></td>
                            <td>${f.siparis_no}</td>
                            <td>${f.tedarikci_adi}</td>
                            <td>‚Ç∫${matrah.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                            <td>%${kdvOrani}</td>
                            <td>‚Ç∫${kdvTutari.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                            <td><strong>‚Ç∫${toplam.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</strong></td>
                            <td>${f.fatura_tarihi ? new Date(f.fatura_tarihi).toLocaleDateString('tr-TR') : '-'}</td>
                            <td><button class="action-btn danger" onclick="deleteInvoice(${f.id})">Sil</button></td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>`}
        </div>
    `;
    
    document.getElementById('faturaForm').onsubmit = async (e) => {
        e.preventDefault();
        
        if (faturaUrunleri.length === 0) {
            showToast('En az bir √ºr√ºn eklemelisiniz!', 'error');
            return;
        }
        
        const sipSelect = document.getElementById('faturaSiparis');
        const opt = sipSelect.options[sipSelect.selectedIndex];
        
        const matrah = faturaUrunleri.reduce((sum, u) => sum + u.toplam, 0);
        const kdvTutari = matrah * (faturaKdvOrani / 100);
        const genelToplam = matrah + kdvTutari;
        
        await apiCall('invoices', 'POST', {
            license_code: currentUser.license_code,
            siparis_id: parseInt(sipSelect.value),
            siparis_no: opt.dataset.no,
            tedarikci_adi: opt.dataset.ted,
            fatura_no: document.getElementById('faturaNo').value,
            fatura_tarihi: document.getElementById('faturaTarihi').value,
            matrah: matrah,
            kdv_orani: faturaKdvOrani,
            kdv_tutari: kdvTutari,
            fatura_tutari: genelToplam,
            fatura_urunleri: JSON.stringify(faturaUrunleri),
            notlar: document.getElementById('faturaNotlar').value
        });
        showToast('Fatura kaydedildi');
        navigateTo('fatura');
    };
}

function setFaturaKdv(oran) {
    faturaKdvOrani = oran;
    document.querySelectorAll('.kdv-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('kdvOraniText').textContent = '%' + oran;
    updateFaturaToplam();
}

function showFaturaUrunSecModal() {
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    
    modalContent.innerHTML = `
        <div class="modal-header">
            <h3>üì¶ √úr√ºn Se√ß</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <input type="text" id="faturaUrunArama" placeholder="√úr√ºn kodu veya adƒ± ile arayƒ±n..." oninput="filterFaturaUrunler()">
            </div>
            <div id="faturaUrunSecListesi" style="max-height:400px; overflow-y:auto;">
                ${renderFaturaUrunSecListesi('')}
            </div>
        </div>
    `;
    modal.classList.add('show');
}

function renderFaturaUrunSecListesi(filter) {
    const filterLower = filter.toLowerCase();
    const filteredProducts = appData.products.filter(p => 
        p.urun_kodu.toLowerCase().includes(filterLower) || 
        p.urun_adi.toLowerCase().includes(filterLower)
    );
    
    if (filteredProducts.length === 0) {
        return '<div class="empty-state">√úr√ºn bulunamadƒ±</div>';
    }
    
    return `<table style="width:100%;">
        <thead><tr style="background:#667eea; color:#fff;"><th>√úr√ºn Kodu</th><th>√úr√ºn Adƒ±</th><th>Birim</th><th>ƒ∞≈ülem</th></tr></thead>
        <tbody>
            ${filteredProducts.map(p => `
                <tr>
                    <td><strong>${p.urun_kodu}</strong></td>
                    <td>${p.urun_adi}</td>
                    <td>${p.birim}</td>
                    <td><button class="action-btn success" onclick="addFaturaUrun(${p.id})">Ekle</button></td>
                </tr>
            `).join('')}
        </tbody>
    </table>`;
}

function filterFaturaUrunler() {
    const filter = document.getElementById('faturaUrunArama').value;
    document.getElementById('faturaUrunSecListesi').innerHTML = renderFaturaUrunSecListesi(filter);
}

function addFaturaUrun(urunId) {
    const urun = appData.products.find(p => p.id === urunId);
    if (!urun) return;
    
    const existing = faturaUrunleri.find(u => u.urun_id === urunId);
    if (existing) {
        showToast('Bu √ºr√ºn zaten eklendi!', 'error');
        return;
    }
    
    faturaUrunleri.push({
        urun_id: urunId,
        urun_kodu: urun.urun_kodu,
        urun_adi: urun.urun_adi,
        birim: urun.birim,
        miktar: 1,
        birim_fiyat: 0,
        toplam: 0
    });
    
    closeModal();
    renderFaturaUrunlerListesi();
    showToast('√úr√ºn eklendi');
}

function renderFaturaUrunlerListesi() {
    const container = document.getElementById('faturaUrunListesi');
    
    if (faturaUrunleri.length === 0) {
        container.innerHTML = '<div class="empty-state" style="padding:20px;">Hen√ºz √ºr√ºn eklenmedi. √úr√ºn eklemek i√ßin yukarƒ±daki butonu kullanƒ±n.</div>';
        return;
    }
    
    container.innerHTML = `
        <table style="width:100%; font-size:13px;">
            <thead>
                <tr style="background:#667eea; color:#fff;">
                    <th style="padding:8px;">√úr√ºn Kodu</th>
                    <th style="padding:8px;">√úr√ºn Adƒ±</th>
                    <th style="padding:8px;">Birim</th>
                    <th style="padding:8px; width:80px;">Miktar</th>
                    <th style="padding:8px; width:120px;">Birim Fiyat (‚Ç∫)</th>
                    <th style="padding:8px; text-align:right;">Toplam</th>
                    <th style="padding:8px; width:60px;">ƒ∞≈ülem</th>
                </tr>
            </thead>
            <tbody>
                ${faturaUrunleri.map((u, idx) => `
                    <tr>
                        <td style="padding:8px;"><strong>${u.urun_kodu}</strong></td>
                        <td style="padding:8px;">${u.urun_adi}</td>
                        <td style="padding:8px;">${u.birim}</td>
                        <td style="padding:8px;"><input type="number" value="${u.miktar}" min="1" style="width:70px; padding:5px;" onchange="updateFaturaUrunMiktar(${idx}, this.value)"></td>
                        <td style="padding:8px;"><input type="number" value="${u.birim_fiyat}" min="0" step="0.01" style="width:110px; padding:5px;" onchange="updateFaturaUrunFiyat(${idx}, this.value)"></td>
                        <td style="padding:8px; text-align:right; font-weight:bold;">‚Ç∫${u.toplam.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding:8px;"><button class="action-btn danger" onclick="removeFaturaUrun(${idx})">√ó</button></td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    
    updateFaturaToplam();
}

function updateFaturaUrunMiktar(idx, val) {
    faturaUrunleri[idx].miktar = parseFloat(val) || 0;
    faturaUrunleri[idx].toplam = faturaUrunleri[idx].miktar * faturaUrunleri[idx].birim_fiyat;
    renderFaturaUrunlerListesi();
}

function updateFaturaUrunFiyat(idx, val) {
    faturaUrunleri[idx].birim_fiyat = parseFloat(val) || 0;
    faturaUrunleri[idx].toplam = faturaUrunleri[idx].miktar * faturaUrunleri[idx].birim_fiyat;
    renderFaturaUrunlerListesi();
}

function removeFaturaUrun(idx) {
    faturaUrunleri.splice(idx, 1);
    renderFaturaUrunlerListesi();
    showToast('√úr√ºn kaldƒ±rƒ±ldƒ±');
}

function updateFaturaToplam() {
    const matrah = faturaUrunleri.reduce((sum, u) => sum + u.toplam, 0);
    const kdvTutari = matrah * (faturaKdvOrani / 100);
    const genelToplam = matrah + kdvTutari;
    
    document.getElementById('faturaMatrah').textContent = '‚Ç∫' + matrah.toLocaleString('tr-TR', {minimumFractionDigits: 2});
    document.getElementById('faturaKdvTutar').textContent = '‚Ç∫' + kdvTutari.toLocaleString('tr-TR', {minimumFractionDigits: 2});
    document.getElementById('faturaGenelToplam').textContent = '‚Ç∫' + genelToplam.toLocaleString('tr-TR', {minimumFractionDigits: 2});
}

function exportFaturalar() {
    let csv = 'fatura_no,siparis_no,tedarikci,matrah,kdv_orani,kdv_tutari,genel_toplam,fatura_tarihi,notlar,kayit_tarihi\n';
    appData.invoices.forEach(f => {
        const matrah = parseFloat(f.matrah || 0);
        const kdvOrani = f.kdv_orani || 0;
        const kdvTutari = parseFloat(f.kdv_tutari || 0);
        const genelToplam = parseFloat(f.fatura_tutari || 0);
        csv += `${f.fatura_no},${f.siparis_no},${f.tedarikci_adi},${matrah.toFixed(2)},${kdvOrani},${kdvTutari.toFixed(2)},${genelToplam.toFixed(2)},${f.fatura_tarihi || ''},${(f.notlar || '').replace(/,/g, ';')},${f.created_at || ''}\n`;
    });
    
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `faturalar_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
    showToast('Fatura listesi indirildi');
}

function printFaturalar() {
    printListAsPDF('Fatura Listesi', appData.invoices, [
        { header: 'Fatura No', field: 'fatura_no' },
        { header: 'Sipari≈ü', field: 'siparis_no' },
        { header: 'Tedarik√ßi', field: 'tedarikci_adi' },
        { header: 'Matrah', field: 'matrah', format: (v) => '‚Ç∫' + parseFloat(v || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2}) },
        { header: 'KDV %', field: 'kdv_orani', format: (v) => '%' + (v || 0) },
        { header: 'KDV Tutarƒ±', field: 'kdv_tutari', format: (v) => '‚Ç∫' + parseFloat(v || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2}) },
        { header: 'Toplam', field: 'fatura_tutari', format: (v) => '‚Ç∫' + parseFloat(v || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2}) },
        { header: 'Tarih', field: 'fatura_tarihi', format: (v) => v ? new Date(v).toLocaleDateString('tr-TR') : '-' }
    ]);
}

function updateFaturaDetay() {
    const select = document.getElementById('faturaSiparis');
    const opt = select.options[select.selectedIndex];
    const tedInput = document.getElementById('faturaTedarikci');
    if (tedInput && opt.dataset.ted) {
        tedInput.value = opt.dataset.ted;
    }
}

async function deleteInvoice(id) {
    if (!confirm('Faturayƒ± silmek istediƒüinize emin misiniz?')) return;
    await apiCall(`invoices/${id}`, 'DELETE');
    showToast('Fatura silindi');
    navigateTo('fatura');
}

function renderYoneticiPanel() {
    const content = document.getElementById('mainContent');
    
    const modulListesi = Object.entries(ALL_PERMISSIONS).map(([id, label]) => ({ id, label }));
    
    content.innerHTML = `
        <div class="page-header">
            <h2>‚öôÔ∏è Y√∂netici Paneli</h2>
            <p>Personel ve yetki y√∂netimi</p>
        </div>
        <div class="card">
            <h3>Yeni Personel Ekle</h3>
            <form id="personelForm">
                <div class="form-grid">
                    <div class="form-group"><label>E-posta *</label><input type="email" id="perEmail" required placeholder="ornek@sirket.com"></div>
                    <div class="form-group"><label>≈ûifre *</label><input type="password" id="perSifre" required placeholder="≈ûifre belirleyin"></div>
                    <div class="form-group"><label>Rol *</label>
                        <select id="perRol" required onchange="updateYetkiCheckboxes()">
                            <option value="Kullanƒ±cƒ±">Kullanƒ±cƒ±</option>
                            <option value="Satƒ±nalma">Satƒ±nalma</option>
                            <option value="Y√∂netim">Y√∂netim (T√ºm Yetkiler)</option>
                        </select>
                    </div>
                </div>
                
                <div id="yetkiSecimContainer" style="margin-top:20px; background:#f8f9fa; padding:15px; border-radius:8px;">
                    <h4 style="margin-bottom:10px;">Eri≈üim Yetkileri</h4>
                    <p style="font-size:12px; color:#7f8c8d; margin-bottom:15px;">Kullanƒ±cƒ±nƒ±n eri≈üebileceƒüi mod√ºlleri se√ßin:</p>
                    <div class="yetki-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:10px;">
                        ${modulListesi.map(m => `
                            <label class="yetki-item" style="display:flex; align-items:center; gap:8px; padding:8px; background:#fff; border:1px solid #ddd; border-radius:6px; cursor:pointer;">
                                <input type="checkbox" class="yetki-checkbox" value="${m.id}">
                                <span>${m.label}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div style="margin-top:10px;">
                        <button type="button" class="btn btn-sm" onclick="selectAllYetkiler(true)" style="margin-right:5px;">T√ºm√ºn√º Se√ß</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="selectAllYetkiler(false)" style="background:#6c757d;">T√ºm√ºn√º Kaldƒ±r</button>
                    </div>
                </div>
                
                <button type="submit" class="btn" style="margin-top:20px;">üíæ Personel Ekle</button>
            </form>
        </div>
        <div class="card">
            <h3>Personel Listesi (${appData.users.length})</h3>
            ${appData.users.length === 0 ? '<div class="empty-state">Hen√ºz personel yok</div>' : `
            <table>
                <thead><tr><th>E-posta</th><th>Rol</th><th>Yetkiler</th><th>Kayƒ±t Tarihi</th><th>ƒ∞≈ülem</th></tr></thead>
                <tbody>
                    ${appData.users.map(u => {
                        let yetkiler = [];
                        try { yetkiler = JSON.parse(u.yetkiler || '[]'); } catch(e) { yetkiler = []; }
                        return `
                        <tr>
                            <td><strong>${u.email}</strong></td>
                            <td><span class="badge badge-${u.role === 'Y√∂netim' ? 'danger' : u.role === 'Satƒ±nalma' ? 'warning' : 'info'}">${u.role}</span></td>
                            <td style="font-size:11px; max-width:200px; overflow:hidden; text-overflow:ellipsis;">
                                ${u.role === 'Y√∂netim' ? 'T√ºm Yetkiler' : yetkiler.length > 0 ? yetkiler.length + ' mod√ºl' : 'Varsayƒ±lan'}
                            </td>
                            <td>${u.created_at ? new Date(u.created_at).toLocaleDateString('tr-TR') : '-'}</td>
                            <td>
                                ${u.email !== currentUser.email ? `
                                    <button class="action-btn primary" onclick="editUserYetkiler(${u.id})">D√ºzenle</button>
                                    <button class="action-btn danger" onclick="deleteUser(${u.id})">Sil</button>
                                ` : '<span style="color:#7f8c8d;">Aktif</span>'}
                            </td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>`}
        </div>
    `;
    
    updateYetkiCheckboxes();
    
    document.getElementById('personelForm').onsubmit = async (e) => {
        e.preventDefault();
        
        const selectedYetkiler = [];
        document.querySelectorAll('.yetki-checkbox:checked').forEach(cb => {
            selectedYetkiler.push(cb.value);
        });
        
        const res = await apiCall('users', 'POST', {
            license_code: currentUser.license_code,
            email: document.getElementById('perEmail').value,
            password: document.getElementById('perSifre').value,
            role: document.getElementById('perRol').value,
            yetkiler: JSON.stringify(selectedYetkiler)
        });
        if (res.success) {
            showToast('Personel eklendi');
            navigateTo('yonetici-panel');
        } else {
            showToast(res.message || 'Hata olu≈ütu!', 'error');
        }
    };
}

function updateYetkiCheckboxes() {
    const rol = document.getElementById('perRol')?.value;
    const container = document.getElementById('yetkiSecimContainer');
    if (!container) return;
    
    if (rol === 'Y√∂netim') {
        container.style.display = 'none';
    } else {
        container.style.display = 'block';
        const defaultPerms = DEFAULT_PERMISSIONS[rol] || [];
        document.querySelectorAll('.yetki-checkbox').forEach(cb => {
            cb.checked = defaultPerms.includes(cb.value);
        });
    }
}

function selectAllYetkiler(select) {
    document.querySelectorAll('.yetki-checkbox').forEach(cb => {
        cb.checked = select;
    });
}

function editUserYetkiler(userId) {
    const user = appData.users.find(u => u.id === userId);
    if (!user) return;
    
    let yetkiler = [];
    try { yetkiler = JSON.parse(user.yetkiler || '[]'); } catch(e) { yetkiler = []; }
    
    const modulListesi = Object.entries(ALL_PERMISSIONS).map(([id, label]) => ({ id, label }));
    
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    
    modalContent.innerHTML = `
        <div class="modal-header">
            <h3>Yetki D√ºzenle: ${user.email}</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Rol</label>
                <select id="editUserRol">
                    <option value="Kullanƒ±cƒ±" ${user.role === 'Kullanƒ±cƒ±' ? 'selected' : ''}>Kullanƒ±cƒ±</option>
                    <option value="Satƒ±nalma" ${user.role === 'Satƒ±nalma' ? 'selected' : ''}>Satƒ±nalma</option>
                    <option value="Y√∂netim" ${user.role === 'Y√∂netim' ? 'selected' : ''}>Y√∂netim</option>
                </select>
            </div>
            <div class="form-group" style="margin-top:15px;">
                <label>Eri≈üim Yetkileri</label>
                <div class="yetki-grid" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; margin-top:10px; max-height:300px; overflow-y:auto;">
                    ${modulListesi.map(m => `
                        <label style="display:flex; align-items:center; gap:8px; padding:6px; background:#f8f9fa; border-radius:4px; cursor:pointer; font-size:13px;">
                            <input type="checkbox" class="edit-yetki-checkbox" value="${m.id}" ${yetkiler.includes(m.id) ? 'checked' : ''}>
                            <span>${m.label}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
            <button class="btn btn-success" onclick="saveUserYetkiler(${userId})" style="width:100%; margin-top:15px;">
                üíæ Kaydet
            </button>
        </div>
    `;
    modal.classList.add('show');
}

async function saveUserYetkiler(userId) {
    const rol = document.getElementById('editUserRol').value;
    const selectedYetkiler = [];
    document.querySelectorAll('.edit-yetki-checkbox:checked').forEach(cb => {
        selectedYetkiler.push(cb.value);
    });
    
    await apiCall(`users/${userId}`, 'PUT', {
        license_code: currentUser.license_code,
        role: rol,
        yetkiler: JSON.stringify(selectedYetkiler)
    });
    
    closeModal();
    showToast('Yetkiler g√ºncellendi');
    navigateTo('yonetici-panel');
}

async function deleteUser(id) {
    if (!confirm('Personeli silmek istediƒüinize emin misiniz?')) return;
    await apiCall(`users/${id}`, 'DELETE');
    showToast('Personel silindi');
    navigateTo('yonetici-panel');
}

function logout() {
    currentUser = null;
    document.getElementById('appContainer').classList.remove('show');
    document.getElementById('loginWrapper').style.display = 'flex';
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPassword').value = '';
}

document.getElementById('loginForm').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('loginBtn');
    btn.disabled = true;
    btn.textContent = 'Giri≈ü yapƒ±lƒ±yor...';
    
    const res = await apiCall('login', 'POST', {
        email: document.getElementById('loginEmail').value,
        password: document.getElementById('loginPassword').value
    });
    
    btn.disabled = false;
    btn.textContent = 'Giri≈ü Yap';
    
    if (res.success) {
        currentUser = res.user;
        currentUser.license_info = res.license_info;
        document.getElementById('loginWrapper').style.display = 'none';
        document.getElementById('appContainer').classList.add('show');
        document.getElementById('companyName').textContent = currentUser.company_name;
        document.getElementById('userEmail').textContent = currentUser.email;
        document.getElementById('userRole').textContent = currentUser.role;
        
        if (!res.license_info.aktif) {
            generateLicenseOnlyMenu();
            navigateTo('lisans-yonetimi');
        } else {
            generateMenu();
            navigateTo('dashboard');
        }
    } else {
        showError('loginError', res.message);
    }
};

document.getElementById('modal').onclick = (e) => {
    if (e.target.id === 'modal') closeModal();
};

let superAdmin = null;
let superAdminToken = null;
let superAdminData = { licenses: [], dashboard: {} };

function showSuperAdminLogin() {
    document.getElementById('loginWrapper').style.display = 'none';
    document.getElementById('superAdminLoginWrapper').style.display = 'flex';
}

function showNormalLogin() {
    document.getElementById('superAdminLoginWrapper').style.display = 'none';
    document.getElementById('loginWrapper').style.display = 'flex';
}

async function superAdminApiCall(endpoint, method = 'GET', data = null) {
    const options = {
        method,
        headers: { 
            'Content-Type': 'application/json',
            'X-Super-Admin-Token': superAdminToken || ''
        }
    };
    if (data) options.body = JSON.stringify(data);
    const res = await fetch(`/api/${endpoint}`, options);
    return res.json();
}

document.getElementById('superAdminLoginForm').onsubmit = async (e) => {
    e.preventDefault();
    const email = document.getElementById('superAdminEmail').value;
    const password = document.getElementById('superAdminPassword').value;
    
    const res = await apiCall('super-admin/login', 'POST', { email, password });
    
    if (res.success) {
        superAdmin = res.admin;
        superAdminToken = res.token;
        document.getElementById('superAdminLoginWrapper').style.display = 'none';
        document.getElementById('superAdminContainer').style.display = 'flex';
        document.getElementById('superAdminName').textContent = superAdmin.ad_soyad;
        document.getElementById('superAdminEmail2').textContent = superAdmin.email;
        showSuperAdminPage('dashboard');
    } else {
        showError('superAdminLoginError', res.message);
    }
};

async function superAdminLogout() {
    if (superAdminToken) {
        await superAdminApiCall('super-admin/logout', 'POST');
    }
    superAdmin = null;
    superAdminToken = null;
    document.getElementById('superAdminContainer').style.display = 'none';
    document.getElementById('loginWrapper').style.display = 'flex';
}

function toggleSuperAdminAccordion(section) {
    const submenu = document.getElementById(section + '-submenu');
    const icon = document.getElementById(section + '-icon');
    if (submenu.style.display === 'none') {
        submenu.style.display = 'block';
        icon.textContent = '‚ñ≤';
    } else {
        submenu.style.display = 'none';
        icon.textContent = '‚ñº';
    }
}

function toggleProductRow(productCode) {
    const checkbox = document.getElementById(`newProd_${productCode}`);
    const datesDiv = document.getElementById(`productDates_${productCode}`);
    const rowDiv = document.getElementById(`productRow_${productCode}`);
    const startInput = document.getElementById(`newProdStart_${productCode}`);
    const endInput = document.getElementById(`newProdEnd_${productCode}`);
    
    if (checkbox.checked) {
        datesDiv.style.opacity = '1';
        rowDiv.style.borderColor = '#667eea';
        rowDiv.style.background = '#f0f4ff';
        startInput.disabled = false;
        endInput.disabled = false;
    } else {
        datesDiv.style.opacity = '0.5';
        rowDiv.style.borderColor = '#e5e7eb';
        rowDiv.style.background = '#f9fafb';
        startInput.disabled = true;
        endInput.disabled = true;
    }
}

async function showSuperAdminPage(page) {
    document.querySelectorAll('#superAdminMenu .menu-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.page === page) item.classList.add('active');
    });
    
    const content = document.getElementById('superAdminContent');
    
    if (page === 'dashboard') {
        const data = await superAdminApiCall('super-admin/dashboard', 'GET');
        superAdminData.dashboard = data;
        
        content.innerHTML = `
            <div class="page-header">
                <h2>Sistem Dashboard</h2>
            </div>
            
            <!-- Genel ƒ∞statistikler -->
            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px;">
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: #fff;">
                    <div style="font-size: 28px; font-weight: bold;">${data.toplam_firma}</div>
                    <div style="opacity: 0.9; margin-top: 5px;">Toplam Firma</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 20px; border-radius: 12px; color: #fff;">
                    <div style="font-size: 28px; font-weight: bold;">${data.aktif_firma}</div>
                    <div style="opacity: 0.9; margin-top: 5px;">Aktif Firma</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); padding: 20px; border-radius: 12px; color: #fff;">
                    <div style="font-size: 28px; font-weight: bold;">${data.toplam_kullanici || 0}</div>
                    <div style="opacity: 0.9; margin-top: 5px;">Toplam Kullanƒ±cƒ±</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; color: #fff;">
                    <div style="font-size: 28px; font-weight: bold;">${formatMoney(data.aylik_gelir)}</div>
                    <div style="opacity: 0.9; margin-top: 5px;">Aylƒ±k Gelir</div>
                </div>
            </div>
            
            <!-- √úr√ºn Bazlƒ± ƒ∞statistikler -->
            <div class="card" style="background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 20px;">√úr√ºn Bazlƒ± ƒ∞statistikler</span>
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    ${(data.urun_istatistikleri || []).map(urun => `
                        <div style="background: linear-gradient(135deg, ${urun.color} 0%, ${urun.color}cc 100%); padding: 20px; border-radius: 12px; color: #fff; ${!urun.is_active ? 'opacity: 0.5;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <span style="font-size: 24px;">${urun.icon}</span>
                                ${urun.is_active ? '<span style="background: rgba(255,255,255,0.3); padding: 3px 10px; border-radius: 20px; font-size: 11px;">AKTƒ∞F</span>' : '<span style="background: rgba(0,0,0,0.3); padding: 3px 10px; border-radius: 20px; font-size: 11px;">YAKINDA</span>'}
                            </div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">${urun.product_name}</div>
                            <div style="display: flex; justify-content: space-between; font-size: 13px; opacity: 0.9;">
                                <span>${urun.aktif_firma} Firma</span>
                                <span>${urun.kullanici_sayisi} Kullanƒ±cƒ±</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <!-- Kullanƒ±cƒ± Daƒüƒ±lƒ±mƒ± -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="card" style="background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 15px;">Kullanƒ±cƒ± Daƒüƒ±lƒ±mƒ±</h3>
                    <div style="space-y: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px;">
                            <span style="display: flex; align-items: center; gap: 8px;"><span style="width: 12px; height: 12px; background: #667eea; border-radius: 50%;"></span> Tedarik</span>
                            <strong>${data.kullanici_dagilimi?.tedarik || 0}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px;">
                            <span style="display: flex; align-items: center; gap: 8px;"><span style="width: 12px; height: 12px; background: #10b981; border-radius: 50%;"></span> Lojistik</span>
                            <strong>${data.kullanici_dagilimi?.lojistik || 0}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                            <span style="display: flex; align-items: center; gap: 8px;"><span style="width: 12px; height: 12px; background: #f59e0b; border-radius: 50%;"></span> Servis</span>
                            <strong>${data.kullanici_dagilimi?.servis || 0}</strong>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 15px; color: #f39c12;">Uyarƒ±lar</h3>
                    <div style="space-y: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: ${data.yaklasan_biten > 0 ? '#fef3c7' : '#f0fdf4'}; border-radius: 8px; margin-bottom: 8px;">
                            <span>7 G√ºn ƒ∞√ßinde Biten</span>
                            <strong style="color: ${data.yaklasan_biten > 0 ? '#d97706' : '#22c55e'};">${data.yaklasan_biten}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: ${data.suresi_dolan > 0 ? '#fee2e2' : '#f0fdf4'}; border-radius: 8px; margin-bottom: 8px;">
                            <span>S√ºresi Dolan</span>
                            <strong style="color: ${data.suresi_dolan > 0 ? '#dc2626' : '#22c55e'};">${data.suresi_dolan}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                            <span>Pasif Firma</span>
                            <strong>${data.pasif_firma}</strong>
                        </div>
                    </div>
                </div>
            </div>
            
            ${data.yaklasan_bitenler && data.yaklasan_bitenler.length > 0 ? `
                <div class="card" style="background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 15px; color: #f39c12;">Yakla≈üan Bitenler (30 g√ºn i√ßinde)</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Firma</th>
                                <th>Lisans Kodu</th>
                                <th>Paket</th>
                                <th>Biti≈ü Tarihi</th>
                                <th>ƒ∞≈ülem</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.yaklasan_bitenler.map(lic => `
                                <tr>
                                    <td>${lic.company_name}</td>
                                    <td><strong>${lic.license_code}</strong></td>
                                    <td>${lic.paket_tipi || 'Standart'}</td>
                                    <td>${lic.bitis_tarihi || '-'}</td>
                                    <td>
                                        <button class="action-btn warning" onclick="showExtendModal(${lic.id})">S√ºre Uzat</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            ` : ''}
        `;
    } else if (page === 'firmalar') {
        const licenses = await superAdminApiCall('super-admin/licenses', 'GET');
        superAdminData.licenses = licenses;
        
        content.innerHTML = `
            <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Firma Y√∂netimi</h2>
                <button class="btn btn-sm" onclick="showSuperAdminPage('yeni-lisans')">+ Yeni Lisans</button>
            </div>
            <div class="card" style="background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Firma</th>
                            <th>Lisans Kodu</th>
                            <th>Paket</th>
                            <th>Ba≈ülangƒ±√ß</th>
                            <th>Biti≈ü</th>
                            <th>Kalan</th>
                            <th>Aylƒ±k √úcret</th>
                            <th>Durum</th>
                            <th>ƒ∞≈ülemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${licenses.map(lic => {
                            let durumBadge = '';
                            if (!lic.is_active) {
                                durumBadge = '<span class="badge" style="background:#95a5a6;color:#fff;">Pasif</span>';
                            } else if (lic.durum_renk === 'yesil') {
                                durumBadge = '<span class="badge badge-success">Aktif</span>';
                            } else if (lic.durum_renk === 'sari') {
                                durumBadge = '<span class="badge badge-warning">Bitiyor</span>';
                            } else if (lic.durum_renk === 'kirmizi') {
                                durumBadge = '<span class="badge badge-danger">S√ºresi Doldu</span>';
                            } else {
                                durumBadge = '<span class="badge badge-info">S√ºresiz</span>';
                            }
                            
                            return `
                                <tr>
                                    <td><strong>${lic.company_name}</strong><br><small style="color:#7f8c8d;">${lic.kullanici_sayisi || 0} kullanƒ±cƒ±, ${lic.proje_sayisi || 0} proje</small></td>
                                    <td><code style="background:#f0f0f0; padding:2px 6px; border-radius:4px;">${lic.license_code}</code></td>
                                    <td>${(lic.paket_tipi || 'standart').charAt(0).toUpperCase() + (lic.paket_tipi || 'standart').slice(1)}</td>
                                    <td>${lic.baslangic_tarihi || '-'}</td>
                                    <td>${lic.bitis_tarihi || '-'}</td>
                                    <td>${lic.kalan_gun !== null ? lic.kalan_gun + ' g√ºn' : 'S√ºresiz'}</td>
                                    <td>${formatMoney(lic.aylik_ucret || 0)}</td>
                                    <td>${durumBadge}</td>
                                    <td>
                                        <button class="action-btn primary" onclick="showLicenseDetail(${lic.id})">Detay</button>
                                        <button class="action-btn warning" onclick="showExtendModal(${lic.id})">Uzat</button>
                                        <button class="action-btn danger" onclick="deleteLicense(${lic.id})">Sil</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } else if (page === 'yeni-lisans') {
        const today = new Date().toISOString().split('T')[0];
        const nextYear = new Date(Date.now() + 365*24*60*60*1000).toISOString().split('T')[0];
        
        content.innerHTML = `
            <div class="page-header">
                <h2>Yeni Lisans Olu≈ütur</h2>
            </div>
            <div class="card" style="background: #fff; border-radius: 12px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 800px;">
                <form id="newLicenseForm">
                    <h4 style="margin-bottom: 15px; color: #667eea;">1. Firma Bilgileri</h4>
                    <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label>Lisans Kodu *</label>
                            <input type="text" id="newLicenseCode" required placeholder="√ñrn: FIRMA-2025" style="text-transform: uppercase;">
                        </div>
                        <div class="form-group">
                            <label>Firma Adƒ± *</label>
                            <input type="text" id="newCompanyName" required placeholder="Firma √únvanƒ±">
                        </div>
                        <div class="form-group">
                            <label>ƒ∞leti≈üim E-posta</label>
                            <input type="email" id="newIletisimEmail" placeholder="iletisim@firma.com">
                        </div>
                        <div class="form-group">
                            <label>ƒ∞leti≈üim Telefon</label>
                            <input type="tel" id="newIletisimTelefon" placeholder="0212 XXX XX XX">
                        </div>
                    </div>
                    
                    <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">
                    <h4 style="margin-bottom: 15px; color: #667eea;">2. Kullanƒ±lacak Sistemler *</h4>
                    <p style="color: #6b7280; font-size: 13px; margin-bottom: 15px;">En az bir sistem se√ßmelisiniz. Her sistem i√ßin ayrƒ± lisans tarihi belirleyebilirsiniz.</p>
                    
                    <div style="display: flex; flex-direction: column; gap: 15px;" id="productSelectionArea">
                        <div style="display: flex; align-items: center; gap: 15px; padding: 15px; border-radius: 10px; background: #f9fafb; border: 2px solid #e5e7eb;" id="productRow_tedarik">
                            <input type="checkbox" id="newProd_tedarik" style="width: 20px; height: 20px;" onchange="toggleProductRow('tedarik')">
                            <div style="display: flex; align-items: center; gap: 8px; min-width: 150px;">
                                <span style="font-size: 24px;">üì¶</span>
                                <span style="font-weight: 600;">Tedarik</span>
                            </div>
                            <div style="display: flex; gap: 10px; flex: 1; opacity: 0.5;" id="productDates_tedarik">
                                <div style="flex: 1;">
                                    <label style="font-size: 11px; color: #6b7280;">Ba≈ülangƒ±√ß</label>
                                    <input type="date" id="newProdStart_tedarik" value="${today}" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;" disabled>
                                </div>
                                <div style="flex: 1;">
                                    <label style="font-size: 11px; color: #6b7280;">Biti≈ü</label>
                                    <input type="date" id="newProdEnd_tedarik" value="${nextYear}" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;" disabled>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 15px; padding: 15px; border-radius: 10px; background: #f9fafb; border: 2px solid #e5e7eb;" id="productRow_lojistik">
                            <input type="checkbox" id="newProd_lojistik" style="width: 20px; height: 20px;" onchange="toggleProductRow('lojistik')">
                            <div style="display: flex; align-items: center; gap: 8px; min-width: 150px;">
                                <span style="font-size: 24px;">üöõ</span>
                                <span style="font-weight: 600;">Lojistik</span>
                            </div>
                            <div style="display: flex; gap: 10px; flex: 1; opacity: 0.5;" id="productDates_lojistik">
                                <div style="flex: 1;">
                                    <label style="font-size: 11px; color: #6b7280;">Ba≈ülangƒ±√ß</label>
                                    <input type="date" id="newProdStart_lojistik" value="${today}" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;" disabled>
                                </div>
                                <div style="flex: 1;">
                                    <label style="font-size: 11px; color: #6b7280;">Biti≈ü</label>
                                    <input type="date" id="newProdEnd_lojistik" value="${nextYear}" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;" disabled>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 15px; padding: 15px; border-radius: 10px; background: #f9fafb; border: 2px solid #e5e7eb;" id="productRow_servis">
                            <input type="checkbox" id="newProd_servis" style="width: 20px; height: 20px;" onchange="toggleProductRow('servis')">
                            <div style="display: flex; align-items: center; gap: 8px; min-width: 150px;">
                                <span style="font-size: 24px;">üîß</span>
                                <span style="font-weight: 600;">Servis</span>
                            </div>
                            <div style="display: flex; gap: 10px; flex: 1; opacity: 0.5;" id="productDates_servis">
                                <div style="flex: 1;">
                                    <label style="font-size: 11px; color: #6b7280;">Ba≈ülangƒ±√ß</label>
                                    <input type="date" id="newProdStart_servis" value="${today}" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;" disabled>
                                </div>
                                <div style="flex: 1;">
                                    <label style="font-size: 11px; color: #6b7280;">Biti≈ü</label>
                                    <input type="date" id="newProdEnd_servis" value="${nextYear}" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;" disabled>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">
                    <h4 style="margin-bottom: 15px; color: #667eea;">3. Admin Kullanƒ±cƒ±</h4>
                    <p style="color: #6b7280; font-size: 13px; margin-bottom: 15px;">Bu kullanƒ±cƒ± se√ßilen t√ºm sistemlere eri≈üim saƒülayacaktƒ±r.</p>
                    <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label>Admin E-posta *</label>
                            <input type="email" id="newAdminEmail" required placeholder="admin@firma.com">
                        </div>
                        <div class="form-group">
                            <label>Admin ≈ûifre</label>
                            <input type="text" id="newAdminPassword" value="123456">
                        </div>
                    </div>
                    <button type="submit" class="btn" style="width: 100%; margin-top: 20px;">Lisans Olu≈ütur</button>
                </form>
            </div>
        `;
        
        document.getElementById('newLicenseForm').onsubmit = async (e) => {
            e.preventDefault();
            
            // Se√ßilen √ºr√ºnleri topla
            const selectedProducts = [];
            ['tedarik', 'lojistik', 'servis'].forEach(code => {
                if (document.getElementById(`newProd_${code}`).checked) {
                    selectedProducts.push({
                        product_code: code,
                        activated_at: document.getElementById(`newProdStart_${code}`).value,
                        expires_at: document.getElementById(`newProdEnd_${code}`).value
                    });
                }
            });
            
            if (selectedProducts.length === 0) {
                showToast('En az bir sistem se√ßmelisiniz!', 'error');
                return;
            }
            
            const data = {
                license_code: document.getElementById('newLicenseCode').value.toUpperCase(),
                company_name: document.getElementById('newCompanyName').value,
                iletisim_email: document.getElementById('newIletisimEmail').value,
                iletisim_telefon: document.getElementById('newIletisimTelefon').value,
                admin_email: document.getElementById('newAdminEmail').value,
                admin_password: document.getElementById('newAdminPassword').value || '123456',
                products: selectedProducts
            };
            
            const res = await superAdminApiCall('super-admin/licenses', 'POST', data);
            if (res.success) {
                showToast('Lisans ba≈üarƒ±yla olu≈üturuldu: ' + res.license_code);
                showSuperAdminPage('firmalar');
            } else {
                showToast(res.message, 'error');
            }
        };
    } else if (page.startsWith('sistem-')) {
        const sistemKodu = page.replace('sistem-', '');
        const sistemInfo = {
            'tedarik': { name: 'Tedarik Sistemi', icon: 'üì¶', color: '#667eea', desc: 'Satƒ±nalma ve Proje Y√∂netimi' },
            'lojistik': { name: 'Lojistik Sistemi', icon: 'üöõ', color: '#10b981', desc: 'Filo ve Sevkiyat Y√∂netimi' },
            'servis': { name: 'Servis Sistemi', icon: 'üîß', color: '#f59e0b', desc: 'Teknik Servis Y√∂netimi' }
        };
        const info = sistemInfo[sistemKodu] || { name: sistemKodu, icon: 'üíº', color: '#666', desc: '' };
        
        // Accordion'u a√ß
        const submenu = document.getElementById('sistemler-submenu');
        const icon = document.getElementById('sistemler-icon');
        if (submenu) {
            submenu.style.display = 'block';
            icon.textContent = '‚ñ≤';
        }
        
        // Tek API √ßaƒürƒ±sƒ± ile t√ºm lisans ve √ºr√ºn bilgilerini al (optimize edilmi≈ü)
        const licenses = await superAdminApiCall('super-admin/licenses?includeProducts=true', 'GET');
        const data = await superAdminApiCall('super-admin/dashboard', 'GET');
        
        // Sistem i√ßin √ºr√ºn istatistiƒüini bul
        const urunIstatistik = (data.urun_istatistikleri || []).find(u => u.product_code === sistemKodu);
        
        // Bu sistemi kullanan firmalarƒ± filtrele (artƒ±k N+1 yok)
        const sistemFirmalari = [];
        for (const lic of licenses) {
            const urun = (lic.urunler || []).find(u => u.product_code === sistemKodu);
            if (urun && urun.firma_aktif) {
                sistemFirmalari.push({
                    ...lic,
                    urun_baslangic: urun.activated_at,
                    urun_bitis: urun.expires_at
                });
            }
        }
        
        const today = new Date().toISOString().split('T')[0];
        
        content.innerHTML = `
            <div class="page-header" style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
                <span style="font-size: 40px;">${info.icon}</span>
                <div>
                    <h2 style="margin: 0;">${info.name}</h2>
                    <p style="margin: 5px 0 0 0; color: #6b7280;">${info.desc}</p>
                </div>
            </div>
            
            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px;">
                <div style="background: linear-gradient(135deg, ${info.color} 0%, ${info.color}cc 100%); padding: 20px; border-radius: 12px; color: #fff;">
                    <div style="font-size: 28px; font-weight: bold;">${sistemFirmalari.length}</div>
                    <div style="opacity: 0.9; margin-top: 5px;">Aktif Firma</div>
                </div>
                <div style="background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="font-size: 28px; font-weight: bold; color: ${info.color};">${urunIstatistik?.kullanici_sayisi || 0}</div>
                    <div style="color: #6b7280; margin-top: 5px;">Toplam Kullanƒ±cƒ±</div>
                </div>
                <div style="background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="font-size: 28px; font-weight: bold; color: #f59e0b;">${sistemFirmalari.filter(f => f.urun_bitis && f.urun_bitis <= new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0]).length}</div>
                    <div style="color: #6b7280; margin-top: 5px;">30 G√ºn ƒ∞√ßinde Biten</div>
                </div>
            </div>
            
            <div class="card" style="background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span>${info.icon}</span> ${info.name} Kullanan Firmalar
                </h3>
                ${sistemFirmalari.length === 0 ? `
                    <p style="text-align: center; color: #9ca3af; padding: 40px;">Bu sistemi kullanan firma bulunmuyor.</p>
                ` : `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Firma</th>
                                <th>Lisans Kodu</th>
                                <th>${info.name} Ba≈ülangƒ±√ß</th>
                                <th>${info.name} Biti≈ü</th>
                                <th>Kalan G√ºn</th>
                                <th>Durum</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sistemFirmalari.map(lic => {
                                let kalanGun = null;
                                let durumBadge = '<span class="badge badge-info">S√ºresiz</span>';
                                if (lic.urun_bitis) {
                                    const bitis = new Date(lic.urun_bitis);
                                    kalanGun = Math.ceil((bitis - new Date()) / (1000 * 60 * 60 * 24));
                                    if (kalanGun < 0) {
                                        durumBadge = '<span class="badge badge-danger">S√ºresi Doldu</span>';
                                    } else if (kalanGun <= 7) {
                                        durumBadge = '<span class="badge badge-warning">Kritik</span>';
                                    } else if (kalanGun <= 30) {
                                        durumBadge = '<span class="badge badge-warning">Yakla≈üƒ±yor</span>';
                                    } else {
                                        durumBadge = '<span class="badge badge-success">Aktif</span>';
                                    }
                                }
                                return `
                                    <tr>
                                        <td><strong>${lic.company_name}</strong></td>
                                        <td><code style="background:#f0f0f0; padding:2px 6px; border-radius:4px;">${lic.license_code}</code></td>
                                        <td>${lic.urun_baslangic || '-'}</td>
                                        <td>${lic.urun_bitis || '-'}</td>
                                        <td>${kalanGun !== null ? kalanGun + ' g√ºn' : 'S√ºresiz'}</td>
                                        <td>${durumBadge}</td>
                                        <td>
                                            <button class="action-btn primary" onclick="showLicenseDetail(${lic.id})">Detay</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `}
            </div>
        `;
    }
}

async function showLicenseDetail(id) {
    const lic = await superAdminApiCall(`super-admin/licenses/${id}`, 'GET');
    
    if (!lic || lic.success === false) {
        showToast('Firma detaylarƒ± y√ºklenemedi!', 'error');
        return;
    }
    
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    
    modalContent.innerHTML = `
        <div class="modal-header">
            <h3>Firma Detayƒ±: ${lic.company_name}</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div><strong>Lisans Kodu:</strong><br>${lic.license_code}</div>
                <div><strong>Paket:</strong><br>${lic.paket_tipi || 'Standart'}</div>
                <div><strong>Ba≈ülangƒ±√ß:</strong><br>${lic.baslangic_tarihi || '-'}</div>
                <div><strong>Biti≈ü:</strong><br>${lic.bitis_tarihi || '-'}</div>
                <div><strong>Aylƒ±k √úcret:</strong><br>${formatMoney(lic.aylik_ucret || 0)}</div>
                <div><strong>Durum:</strong><br>${lic.is_active ? '‚úÖ Aktif' : '‚ùå Pasif'}</div>
                <div><strong>ƒ∞leti≈üim:</strong><br>${lic.iletisim_email || '-'}<br>${lic.iletisim_telefon || '-'}</div>
                <div><strong>Kayƒ±t Tarihi:</strong><br>${lic.created_at ? lic.created_at.split('T')[0] : '-'}</div>
            </div>
            
            <hr style="margin: 20px 0;">
            <h4 style="margin-bottom: 15px;">√úr√ºn Lisanslarƒ±</h4>
            <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 15px;">
                ${(lic.tum_urunler || []).map(urun => `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px 15px; border-radius: 10px; background: ${urun.firma_aktif ? urun.color + '15' : '#f9fafb'}; border: 2px solid ${urun.firma_aktif ? urun.color : '#e5e7eb'};">
                        <div style="display: flex; align-items: center; gap: 8px; min-width: 140px;">
                            <span style="font-size: 20px;">${urun.icon}</span>
                            <span style="font-weight: 600; color: ${urun.firma_aktif ? urun.color : '#9ca3af'};">${urun.product_name.replace('Protera ', '')}</span>
                        </div>
                        ${urun.firma_aktif ? `
                            <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                <div style="display: flex; flex-direction: column; gap: 2px;">
                                    <label style="font-size: 10px; color: #6b7280;">Ba≈ülangƒ±√ß</label>
                                    <input type="date" id="prod_start_${urun.id}" value="${urun.activated_at || ''}" 
                                           style="padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px;">
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 2px;">
                                    <label style="font-size: 10px; color: #6b7280;">Biti≈ü</label>
                                    <input type="date" id="prod_end_${urun.id}" value="${urun.expires_at || ''}" 
                                           style="padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px;">
                                </div>
                                <button onclick="updateProductDates(${id}, ${urun.id})" 
                                        style="background: #3b82f6; color: #fff; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 11px; margin-left: 5px;">
                                    Kaydet
                                </button>
                            </div>
                            <button onclick="toggleProductForLicense(${id}, ${urun.id}, 0)" 
                                    style="background: #ef4444; color: #fff; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 11px;">
                                Kaldƒ±r
                            </button>
                        ` : `
                            <div style="flex: 1; color: #9ca3af; font-size: 13px;">Aktif deƒüil</div>
                            <button onclick="showAddProductModal(${id}, ${urun.id}, '${urun.product_name}')" 
                                    style="background: #22c55e; color: #fff; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 11px;">
                                + Ekle
                            </button>
                        `}
                    </div>
                `).join('')}
            </div>
            
            <hr style="margin: 20px 0;">
            <h4 style="margin-bottom: 15px;">Sistemlere G√∂re ƒ∞statistikler</h4>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                <div style="background: linear-gradient(135deg, #667eea22, #764ba222); padding: 15px; border-radius: 10px; border-left: 4px solid #667eea;">
                    <div style="font-weight: 600; color: #667eea; margin-bottom: 10px;">üì¶ Tedarik</div>
                    <div style="font-size: 13px; color: #666;">
                        <div>${lic.tedarik_kullanici_sayisi || 0} Kullanƒ±cƒ±</div>
                        <div>${lic.proje_sayisi || 0} Proje</div>
                        <div>${lic.tedarikci_sayisi || 0} Tedarik√ßi</div>
                        <div>${lic.siparis_sayisi || 0} Sipari≈ü</div>
                    </div>
                </div>
                <div style="background: linear-gradient(135deg, #10b98122, #38ef7d22); padding: 15px; border-radius: 10px; border-left: 4px solid #10b981;">
                    <div style="font-weight: 600; color: #10b981; margin-bottom: 10px;">üöõ Lojistik</div>
                    <div style="font-size: 13px; color: #666;">
                        <div>${lic.lojistik_kullanici_sayisi || 0} Kullanƒ±cƒ±</div>
                        <div>${lic.arac_sayisi || 0} Ara√ß</div>
                        <div>${lic.surucu_sayisi || 0} S√ºr√ºc√º</div>
                        <div>${lic.sevkiyat_sayisi || 0} Sevkiyat</div>
                    </div>
                </div>
                <div style="background: linear-gradient(135deg, #f59e0b22, #fcd34d22); padding: 15px; border-radius: 10px; border-left: 4px solid #f59e0b;">
                    <div style="font-weight: 600; color: #f59e0b; margin-bottom: 10px;">üîß Servis</div>
                    <div style="font-size: 13px; color: #666;">
                        <div>${lic.servis_kullanici_sayisi || 0} Kullanƒ±cƒ±</div>
                        <div>${lic.servis_musteri_sayisi || 0} M√º≈üteri</div>
                        <div>${lic.teknisyen_sayisi || 0} Teknisyen</div>
                        <div>${lic.ariza_sayisi || 0} Arƒ±za Kaydƒ±</div>
                    </div>
                </div>
            </div>
            
            <hr style="margin: 20px 0;">
            <h4 style="margin-bottom: 10px;">T√ºm Kullanƒ±cƒ±lar (${(lic.kullanicilar || []).length})</h4>
            <div style="max-height: 200px; overflow-y: auto; background: #f9fafb; border-radius: 8px; padding: 10px;">
                ${(lic.kullanicilar || []).length === 0 ? '<p style="color: #9ca3af; text-align: center;">Hen√ºz kullanƒ±cƒ± yok</p>' : 
                    (lic.kullanicilar || []).map(u => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #fff; border-radius: 6px; margin-bottom: 5px;">
                            <div>
                                <span style="font-weight: 500;">${u.ad_soyad || u.email}</span>
                                <span style="font-size: 11px; color: #9ca3af; margin-left: 5px;">${u.email}</span>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <span style="background: ${u.sistem === 'tedarik' ? '#667eea' : u.sistem === 'lojistik' ? '#10b981' : '#f59e0b'}; color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 10px;">${u.sistem.toUpperCase()}</span>
                                <span style="background: #e5e7eb; padding: 2px 8px; border-radius: 10px; font-size: 10px;">${u.role}</span>
                            </div>
                        </div>
                    `).join('')
                }
            </div>
            
            <hr style="margin: 20px 0;">
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-warning btn-sm" onclick="showEditLicenseModal(${id})" style="flex:1;">D√ºzenle</button>
                <button class="btn btn-sm" onclick="showExtendModal(${id}); closeModal();" style="flex:1;">S√ºre Uzat</button>
                <button class="btn btn-danger btn-sm" onclick="toggleLicenseStatus(${id}, ${lic.is_active ? 0 : 1})" style="flex:1;">
                    ${lic.is_active ? 'Pasif Yap' : 'Aktif Yap'}
                </button>
            </div>
        </div>
    `;
    modal.classList.add('show');
}

async function toggleProductForLicense(licenseId, productId, add) {
    const action = add ? 'add' : 'remove';
    const res = await superAdminApiCall(`super-admin/licenses/${licenseId}/products`, 'POST', { product_id: productId, action: action });
    if (res.success) {
        showToast(add ? '√úr√ºn eklendi!' : '√úr√ºn kaldƒ±rƒ±ldƒ±!');
        showLicenseDetail(licenseId);
    } else {
        showToast('ƒ∞≈ülem ba≈üarƒ±sƒ±z!', 'error');
    }
}

async function updateProductDates(licenseId, productId) {
    const startDate = document.getElementById(`prod_start_${productId}`).value;
    const endDate = document.getElementById(`prod_end_${productId}`).value;
    
    if (!startDate || !endDate) {
        showToast('L√ºtfen ba≈ülangƒ±√ß ve biti≈ü tarihlerini girin!', 'error');
        return;
    }
    
    const res = await superAdminApiCall(`super-admin/licenses/${licenseId}/products`, 'POST', {
        product_id: productId,
        action: 'update',
        activated_at: startDate,
        expires_at: endDate
    });
    
    if (res.success) {
        showToast('√úr√ºn lisans tarihleri g√ºncellendi!');
    } else {
        showToast('G√ºncelleme ba≈üarƒ±sƒ±z!', 'error');
    }
}

function showAddProductModal(licenseId, productId, productName) {
    const today = new Date().toISOString().split('T')[0];
    const nextYear = new Date(Date.now() + 365*24*60*60*1000).toISOString().split('T')[0];
    
    const modalContent = document.getElementById('modalContent');
    const currentContent = modalContent.innerHTML;
    
    modalContent.innerHTML = `
        <div class="modal-header">
            <h3>${productName} Lisansƒ± Ekle</h3>
            <button class="modal-close" onclick="showLicenseDetail(${licenseId})">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Ba≈ülangƒ±√ß Tarihi</label>
                <input type="date" id="newProdStart" value="${today}">
            </div>
            <div class="form-group">
                <label>Biti≈ü Tarihi</label>
                <input type="date" id="newProdEnd" value="${nextYear}">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-sm" onclick="addProductWithDates(${licenseId}, ${productId})" style="flex: 1;">Ekle</button>
                <button class="btn btn-secondary btn-sm" onclick="showLicenseDetail(${licenseId})" style="flex: 1;">ƒ∞ptal</button>
            </div>
        </div>
    `;
}

async function addProductWithDates(licenseId, productId) {
    const startDate = document.getElementById('newProdStart').value;
    const endDate = document.getElementById('newProdEnd').value;
    
    if (!startDate || !endDate) {
        showToast('L√ºtfen tarihleri girin!', 'error');
        return;
    }
    
    const res = await superAdminApiCall(`super-admin/licenses/${licenseId}/products`, 'POST', {
        product_id: productId,
        action: 'add',
        activated_at: startDate,
        expires_at: endDate
    });
    
    if (res.success) {
        showToast('√úr√ºn lisansƒ± eklendi!');
        showLicenseDetail(licenseId);
    } else {
        showToast('Ekleme ba≈üarƒ±sƒ±z!', 'error');
    }
}

async function showEditLicenseModal(id) {
    const lic = await superAdminApiCall(`super-admin/licenses/${id}`, 'GET');
    closeModal();
    
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    
    modalContent.innerHTML = `
        <div class="modal-header">
            <h3>Lisans D√ºzenle: ${lic.company_name}</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <form id="editLicenseForm">
                <div class="form-group">
                    <label>Firma Adƒ±</label>
                    <input type="text" id="editCompanyName" value="${lic.company_name}" required>
                </div>
                <div class="form-group">
                    <label>Paket Tipi</label>
                    <select id="editPaketTipi">
                        <option value="standart" ${lic.paket_tipi === 'standart' ? 'selected' : ''}>Standart</option>
                        <option value="premium" ${lic.paket_tipi === 'premium' ? 'selected' : ''}>Premium</option>
                        <option value="kurumsal" ${lic.paket_tipi === 'kurumsal' ? 'selected' : ''}>Kurumsal</option>
                    </select>
                </div>
                <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Ba≈ülangƒ±√ß Tarihi</label>
                        <input type="date" id="editBaslangicTarihi" value="${lic.baslangic_tarihi || ''}">
                    </div>
                    <div class="form-group">
                        <label>Biti≈ü Tarihi</label>
                        <input type="date" id="editBitisTarihi" value="${lic.bitis_tarihi || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label>Aylƒ±k √úcret (‚Ç∫)</label>
                    <input type="number" id="editAylikUcret" value="${lic.aylik_ucret || 0}" min="0">
                </div>
                <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>ƒ∞leti≈üim E-posta</label>
                        <input type="email" id="editIletisimEmail" value="${lic.iletisim_email || ''}">
                    </div>
                    <div class="form-group">
                        <label>ƒ∞leti≈üim Telefon</label>
                        <input type="tel" id="editIletisimTelefon" value="${lic.iletisim_telefon || ''}">
                    </div>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Kaydet</button>
            </form>
        </div>
    `;
    modal.classList.add('show');
    
    document.getElementById('editLicenseForm').onsubmit = async (e) => {
        e.preventDefault();
        const data = {
            company_name: document.getElementById('editCompanyName').value,
            paket_tipi: document.getElementById('editPaketTipi').value,
            baslangic_tarihi: document.getElementById('editBaslangicTarihi').value,
            bitis_tarihi: document.getElementById('editBitisTarihi').value,
            aylik_ucret: parseFloat(document.getElementById('editAylikUcret').value) || 0,
            iletisim_email: document.getElementById('editIletisimEmail').value,
            iletisim_telefon: document.getElementById('editIletisimTelefon').value,
            is_active: lic.is_active
        };
        
        await superAdminApiCall(`super-admin/licenses/${id}`, 'PUT', data);
        closeModal();
        showToast('Lisans g√ºncellendi');
        showSuperAdminPage('firmalar');
    };
}

function showExtendModal(id) {
    const nextYear = new Date(Date.now() + 365*24*60*60*1000).toISOString().split('T')[0];
    
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    
    modalContent.innerHTML = `
        <div class="modal-header">
            <h3>Lisans S√ºre Uzatma</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Yeni Biti≈ü Tarihi</label>
                <input type="date" id="extendBitisTarihi" value="${nextYear}">
            </div>
            <button class="btn" style="width: 100%;" onclick="extendLicense(${id})">S√ºreyi Uzat</button>
        </div>
    `;
    modal.classList.add('show');
}

async function extendLicense(id) {
    const yeniBitis = document.getElementById('extendBitisTarihi').value;
    if (!yeniBitis) {
        showToast('Biti≈ü tarihi se√ßin', 'error');
        return;
    }
    
    await superAdminApiCall(`super-admin/licenses/${id}/extend`, 'POST', { bitis_tarihi: yeniBitis });
    closeModal();
    showToast('Lisans s√ºresi uzatƒ±ldƒ±');
    showSuperAdminPage('firmalar');
}

async function toggleLicenseStatus(id, newStatus) {
    const lic = superAdminData.licenses.find(l => l.id === id);
    if (!lic) return;
    
    await superAdminApiCall(`super-admin/licenses/${id}`, 'PUT', {
        company_name: lic.company_name,
        paket_tipi: lic.paket_tipi,
        baslangic_tarihi: lic.baslangic_tarihi,
        bitis_tarihi: lic.bitis_tarihi,
        aylik_ucret: lic.aylik_ucret,
        iletisim_email: lic.iletisim_email,
        iletisim_telefon: lic.iletisim_telefon,
        is_active: newStatus
    });
    
    closeModal();
    showToast(newStatus ? 'Lisans aktif edildi' : 'Lisans pasif yapƒ±ldƒ±');
    showSuperAdminPage('firmalar');
}

async function deleteLicense(id) {
    if (!confirm('Bu lisansƒ± ve T√úM VERƒ∞LERƒ∞Nƒ∞ silmek istediƒüinize emin misiniz? Bu i≈ülem geri alƒ±namaz!')) return;
    if (!confirm('UYARI: Firmaya ait t√ºm projeler, √ºr√ºnler, sipari≈üler, kullanƒ±cƒ±lar silinecek. Devam etmek istiyor musunuz?')) return;
    
    await superAdminApiCall(`super-admin/licenses/${id}`, 'DELETE');
    showToast('Lisans ve t√ºm verileri silindi');
    showSuperAdminPage('firmalar');
}

// Sayfa y√ºklendiƒüinde URL kontrol√º
(function() {
    const path = window.location.pathname;
    if (path === '/superadmin') {
        showSuperAdminLogin();
    } else if (path === '/giris' || path === '/') {
        document.getElementById('loginWrapper').style.display = 'flex';
    }
})();
</script>
</body>
</html>
